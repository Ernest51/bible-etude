<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Étude biblique — Lecture</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;background:#f6f7fb}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 22px -10px rgba(2,6,23,.18)}
    .hdr{padding:18px 20px;border-bottom:1px solid #eef2f7}
    .hdr h1{margin:0;font-size:26px}
    .content{padding:20px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:10px 0}
    .row-sm{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    label{font-size:12px;font-weight:600;color:#334155;display:block;margin:4px 0}
    input,select,button,textarea{font:inherit}
    input,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
    button{border:1px solid #cbd5e1;border-radius:10px;background:#0f172a;color:#fff;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#f1f5f9;color:#0f172a}
    button.ghost{background:transparent;color:#0f172a}
    .muted{color:#64748b;font-size:12px}
    .error{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;border-radius:10px;padding:10px 12px;margin-top:10px}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;border-radius:10px;padding:10px 12px;margin-top:10px}
    pre{white-space:pre-wrap;word-break:break-word}
    .result{background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;padding:14px}
    .row-buttons{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hdr">
        <h1>Étude biblique — Lecture</h1>
        <div class="muted">Affichage lisible de 8 ou 28 points (aucun JSON brut par défaut).</div>
      </div>

      <div class="content">
        <div class="row">
          <div>
            <label for="livre">Livre</label>
            <input id="livre" placeholder="Jean" value="Jean" />
          </div>
          <div>
            <label for="chapitre">Chapitre</label>
            <input id="chapitre" type="number" min="1" step="1" value="3" />
          </div>
          <div>
            <label for="points">Format</label>
            <select id="points">
              <option value="8">8 points (rapide)</option>
              <option value="28">28 points (complet)</option>
            </select>
          </div>
        </div>

        <div class="row-sm">
          <button id="go">Générer</button>
          <div class="row-buttons">
            <button class="secondary" id="copyBtn">Copier</button>
            <button class="secondary" id="exportBtn">Exporter JSON</button>
            <button class="secondary" id="printBtn">Imprimer / PDF</button>
            <button class="ghost" id="toggleRawBtn">Voir le JSON brut (pour debug uniquement)</button>
          </div>
        </div>

        <div id="msg" class="hidden"></div>

        <div id="pretty" class="result" style="margin-top:12px;"></div>
        <pre id="raw" class="result hidden" style="margin-top:12px;"></pre>

        <div class="muted" style="margin-top:10px">
          API : <code id="apiLink"></code>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);

  const livreEl    = $('#livre');
  const chapEl     = $('#chapitre');
  const pointsEl   = $('#points');
  const goBtn      = $('#go');
  const msgBox     = $('#msg');
  const prettyBox  = $('#pretty');
  const rawBox     = $('#raw');
  const apiLink    = $('#apiLink');

  const copyBtn    = $('#copyBtn');
  const exportBtn  = $('#exportBtn');
  const printBtn   = $('#printBtn');
  const toggleRaw  = $('#toggleRawBtn');

  // Toujours relatif → marche en local et sur Vercel
  const API_URL = new URL('./api/chat', window.location.href).toString();
  apiLink.textContent = API_URL;

  toggleRaw.addEventListener('click', () => {
    rawBox.classList.toggle('hidden');
  });

  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(prettyBox.textContent || '');
      showMsg('Texte copié dans le presse-papiers.', 'ok');
    } catch {
      showMsg('Impossible de copier.', 'error');
    }
  });
  exportBtn.addEventListener('click', () => {
    const blob = new Blob([rawBox.textContent || '{}'], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const l = (livreEl.value || 'Livre').replace(/\s+/g,'_');
    a.download = `etude_${l}_${chapEl.value || '1'}.json`;
    a.click();
  });
  printBtn.addEventListener('click', () => window.print());

  goBtn.addEventListener('click', run);

  function showMsg(text, kind) {
    msgBox.className = kind === 'ok' ? 'ok' : 'error';
    msgBox.textContent = text;
    msgBox.classList.remove('hidden');
  }
  function clearMsg(){
    msgBox.classList.add('hidden');
    msgBox.textContent = '';
  }

  function renderPretty(data){
    // 1) content (string) → on affiche tel quel
    if (typeof data?.content === 'string' && data.content.trim()) {
      prettyBox.textContent = data.content.trim();
      return;
    }
    // 2) points: [...] (tableau de chaînes)
    if (Array.isArray(data?.points) && data.points.length) {
      prettyBox.innerHTML = data.points
        .map((p,i)=>`<p><strong>${i+1}.</strong> ${escapeHtml(String(p||''))}</p>`)
        .join('');
      return;
    }
    // 3) p1…p28
    const keys = Object.keys(data||{}).filter(k=>/^p\d{1,2}$/.test(k)).sort((a,b)=>parseInt(a.slice(1))-parseInt(b.slice(1)));
    if (keys.length) {
      prettyBox.innerHTML = keys
        .map((k,i)=>`<p><strong>${i+1}.</strong> ${escapeHtml(String(data[k]||''))}</p>`)
        .join('');
      return;
    }
    // Sinon on affiche brut
    prettyBox.textContent = JSON.stringify(data,null,2);
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function run(){
    clearMsg();
    prettyBox.textContent = '… Génération en cours …';
    rawBox.textContent = '';

    const livre    = (livreEl.value || '').trim();
    const chapitre = parseInt(chapEl.value, 10) || 1;
    const points   = parseInt(pointsEl.value, 10) || 8;

    if (!livre) {
      showMsg('Renseigne le livre (ex. « Jean »).', 'error');
      prettyBox.textContent = '';
      return;
    }

    try{
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ livre, chapitre, points })
      });

      const text = await res.text();
      let json  = null;
      try { json = JSON.parse(text); } catch { /* parfois du texte brut */ }

      if (!res.ok) {
        // 405 = méthode, 404 = route, 500 = serveur/clé, etc.
        const msg = json?.error || json?.message || `Erreur HTTP ${res.status}`;
        prettyBox.textContent = '';
        rawBox.textContent = text || msg;
        showMsg(`Erreur : ${msg}`, 'error');
        return;
      }

      // Réussite
      rawBox.textContent = json ? JSON.stringify(json,null,2) : text;
      renderPretty(json || {content:text});
      showMsg('OK', 'ok');

    }catch(err){
      prettyBox.textContent = '';
      showMsg('Erreur réseau : ' + String(err && err.message || err), 'error');
    }
  }
})();
</script>
</body>
</html>
