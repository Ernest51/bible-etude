<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Étude Biblique — 28 points (modèle strict)</title>

  <!-- Tailwind compilé côté build -->
  <link rel="stylesheet" href="/dist/output.css" />

  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    :root{
      --c50:#eef2ff;--c100:#e0e7ff;--c200:#c7d2fe;--c600:#4f46e5;--c700:#4338ca;--c800:#3730a3;
      --ok:#10b981;--err:#ef4444;--ink:#0f172a;
    }
    body{background:#f7f8fb;color:#0f172a}
    .container-xl{max-width:1200px;margin-inline:auto}
    .card{background:#fff;border:1px solid var(--c100);border-radius:16px;box-shadow:0 12px 24px -12px rgba(2,6,23,.15)}
    .btn{display:inline-flex;align-items:center;gap:.55rem;border-radius:12px;font-weight:800;padding:.7rem 1rem}
    .btn-solid{background:var(--c600);color:#fff}.btn-solid:hover{background:var(--c700)}
    .btn-outline{border:1px solid var(--c200);background:#fff}
    .btn-ghost{border:1px dashed var(--c200);background:#fff}
    .badge{display:inline-grid;place-items:center;width:1.9rem;height:1.9rem;border-radius:.55rem;background:var(--c100);color:var(--c800);font-weight:800;font-size:.75rem}
    .sidebar-item{border:1px solid transparent;border-radius:12px;padding:.6rem .7rem;display:flex;align-items:flex-start;gap:.6rem}
    .sidebar-item:hover{background:var(--c50);border-color:var(--c200)}
    .sidebar-item.active{background:var(--c100);border-color:var(--c200);box-shadow:inset 4px 0 0 0 var(--c600)}
    .content-section{display:none;opacity:0;transition:opacity .18s ease}
    .content-section.active{display:block;opacity:1}
    .toast{position:fixed;right:14px;bottom:14px;background:#111827;color:#fff;padding:.65rem .95rem;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.15);z-index:200;transition:opacity .25s, transform .25s}
    .toolbar{background:#fff;border:1px solid var(--c100);border-radius:14px;padding:.6rem .8rem}
    .prose a{color:var(--c700);text-decoration:underline}
    .prose img{border-radius:12px;box-shadow:0 10px 24px rgba(2,6,23,.15);max-width:100%;height:auto}
    .ghost-note{display:none} /* plus de textarea visibles par défaut */
    .edit-wrap[aria-expanded="true"] .ghost-note{display:block}
    .edit-wrap[aria-expanded="true"] .display-note{display:none}
    .pill{background:#fff;border:1px solid var(--c100);border-radius:12px;padding:.35rem .6rem}
    .dropdown{position:relative}
    .menu{position:absolute;left:0;right:0;z-index:30;background:#fff;border:1px solid var(--c100);border-radius:12px;box-shadow:0 14px 28px -12px rgba(2,6,23,.18);max-height:300px;overflow:auto;display:none}
    .menu.open{display:block}
    .menu button{display:block;width:100%;text-align:left;padding:.55rem .8rem}
    .menu button:hover{background:var(--c50)}
    @media (max-width: 640px){
      .grid-mobile{display:grid;grid-template-columns:1fr;gap:12px}
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="toasts"></div>

  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-[var(--c100)]">
    <div class="container-xl px-3 sm:px-4">
      <div class="py-2 sm:py-3 flex flex-wrap items-center justify-between gap-2">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl grid place-items-center bg-[var(--c100)] text-[var(--c700)] shadow">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
          </div>
          <div>
            <h1 class="text-xl sm:text-2xl font-extrabold tracking-wide">Étude Biblique — Modèle strict (28 points)</h1>
            <p class="text-[11px] sm:text-xs text-slate-600 -mt-0.5">Chaque point = contenu ciblé, ≥ 2 500 caractères, format imposé</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span class="pill text-xs" id="lastStudyPill">Dernière étude : —</span>
          <button id="resumeBtn" class="btn btn-outline text-xs sm:text-sm">Reprendre</button>
          <button id="printBtn" class="btn btn-outline text-xs sm:text-sm">Imprimer / PDF</button>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 py-5 sm:py-6">
    <div class="container-xl px-3 sm:px-4">
      <!-- Sélecteurs -->
      <section class="card p-4 sm:p-6 mb-6">
        <div class="grid grid-cols-12 gap-3 sm:gap-4 items-end grid-mobile">
          <!-- Recherche -->
          <div class="col-span-12">
            <label class="text-sm font-semibold block mb-1">Recherche</label>
            <div class="relative">
              <svg class="w-4 h-4 text-neutral-400 absolute left-3 top-3" viewBox="0 0 24 24" fill="currentColor"><path d="M10 18a8 8 0 1 1 5.293-14.293A8 8 0 0 1 10 18zm11 3-6-6"/></svg>
              <input id="searchInput" class="w-full border rounded-lg pl-9 pr-3 py-2.5" placeholder="Tape ‘jean 3’, ‘1co 13’, ‘exo 3’…">
            </div>
            <p class="text-xs text-neutral-600 mt-1">Abréviations OK : mar, jn, 1co, rm… accents facultatifs.</p>
          </div>

          <!-- Livre -->
          <div class="col-span-12 sm:col-span-6 lg:col-span-5">
            <label class="text-sm font-semibold block mb-1">Livre</label>
            <div class="dropdown">
              <button id="livreBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between">
                <span id="livreLabel">Sélectionner un livre</span>
                <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
              </button>
              <div id="livreMenu" class="menu"></div>
            </div>
          </div>

          <!-- Chapitre -->
          <div class="col-span-6 sm:col-span-3 lg:col-span-3">
            <label class="text-sm font-semibold block mb-1">Chapitre</label>
            <div class="dropdown">
              <button id="chapBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between" disabled>
                <span id="chapLabel">Chapitre</span>
                <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
              </button>
              <div id="chapMenu" class="menu"></div>
            </div>
          </div>

          <!-- Version -->
          <div class="col-span-6 sm:col-span-3 lg:col-span-2">
            <label class="text-sm font-semibold block mb-1">Version</label>
            <select id="versionSelect" class="w-full bg-white border rounded-lg py-2.5 px-4">
              <option value="LSG" selected>LSG — Louis Segond</option>
              <option value="SG21">SG21 — Segond 21</option>
              <option value="NEG1979">NEG79 — Nouvelle Édition de Genève</option>
              <option value="BDS">BDS — La Bible du Semeur</option>
              <option value="PDV">PDV — Parole de Vie</option>
            </select>
          </div>

          <!-- Actions -->
          <div class="col-span-12 flex flex-wrap gap-2 mt-1">
            <button id="validerBtn" class="btn btn-solid shadow w-full sm:w-auto">Valide (28 pts)</button>
            <button id="reinitBtn" class="btn btn-outline w-full sm:w-auto">Réinitialiser</button>
            <button id="lireBtn" class="btn btn-outline w-full sm:w-auto" disabled>Lire (BibleGateway)</button>

            <div class="ml-auto flex gap-2 w-full sm:w-auto">
              <button id="generateBtn" class="btn btn-solid shadow w-full sm:w-auto">Générer IA</button>
              <button id="exportMdBtn" class="btn btn-ghost w-full sm:w-auto">Exporter (Markdown)</button>
              <button id="copyLinkBtn" class="btn btn-ghost w-full sm:w-auto">Copier le lien</button>
            </div>
          </div>

          <!-- Dernière étude -->
          <div class="col-span-12">
            <div class="mt-3 text-sm text-slate-700">
              <span class="font-semibold">Dernière étude :</span>
              <span id="lastStudyInline">—</span>
            </div>
          </div>
        </div>
      </section>

      <div class="grid grid-cols-12 gap-4 lg:gap-6">
        <!-- NAV points -->
        <aside class="col-span-12 lg:col-span-4">
          <div class="card p-3 sticky top-[84px] max-h-[calc(100vh-140px)] overflow-y-auto">
            <h2 class="text-lg font-extrabold mb-2">Points d’étude (28)</h2>
            <nav id="pointsNav" class="space-y-1"></nav>
          </div>
        </aside>

        <!-- CONTENU -->
        <section class="col-span-12 lg:col-span-8">
          <div class="card relative">
            <div id="busy" class="hidden absolute inset-0 bg-white/70 z-10 grid place-items-center">
              <div class="rounded-xl border bg-white px-4 py-3 shadow-md text-sm flex items-center gap-2">
                <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                <span id="busyText">Génération…</span>
              </div>
            </div>
            <div id="contentArea" class="p-4 sm:p-6">
              <div id="welcome" class="text-center py-10">
                <div class="w-16 h-16 rounded-xl bg-[var(--c50)] text-[var(--c700)] grid place-items-center mx-auto mb-3">
                  <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
                </div>
                <h3 class="text-lg font-bold mb-2">Bienvenue 👋</h3>
                <p class="text-neutral-600">Choisis un livre et un chapitre, puis clique <b>Valide</b>. Chaque point est généré au format imposé (≥ 2 500 caractères).</p>
              </div>
              <div id="sectionsHost"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    /* ==================== PARAMS ==================== */
    const API_URL_CHAT = new URL('./api/chat', location.href).toString();
    const MIN_CHARS = 2500;            // objectif par point
    const BATCH = 3;                   // lots petits = plus stable
    const $ = s=>document.querySelector(s);
    const toast=(m,k='info',ms=4000)=>{const z=$("#toasts"),d=document.createElement('div');d.className='toast';d.textContent=m;d.style.background=k==='err'?'#ef4444':(k==='ok'?'#10b981':'#111827');z.appendChild(d);setTimeout(()=>{d.style.opacity='0';d.style.transform='translateY(4px)';},ms-300);setTimeout(()=>d.remove(),ms);};

    /* ==================== LISTES ==================== */
    const LIVRES_CHAP={"Genèse":50,"Exode":40,"Lévitique":27,"Nombres":36,"Deutéronome":34,"Josué":24,"Juges":21,"Ruth":4,"1 Samuel":31,"2 Samuel":24,"1 Rois":22,"2 Rois":25,"1 Chroniques":29,"2 Chroniques":36,"Esdras":10,"Néhémie":13,"Esther":10,"Job":42,"Psaumes":150,"Proverbes":31,"Ecclésiaste":12,"Cantique":8,"Ésaïe":66,"Jérémie":52,"Lamentations":5,"Ézéchiel":48,"Daniel":12,"Osée":14,"Joël":3,"Amos":9,"Abdias":1,"Jonas":4,"Michée":7,"Nahum":3,"Habacuc":3,"Sophonie":3,"Aggée":2,"Zacharie":14,"Malachie":4,"Matthieu":28,"Marc":16,"Luc":24,"Jean":21,"Actes":28,"Romains":16,"1 Corinthiens":16,"2 Corinthiens":13,"Galates":6,"Éphésiens":6,"Philippiens":4,"Colossiens":4,"1 Thessaloniciens":5,"2 Thessaloniciens":3,"1 Timothée":6,"2 Timothée":4,"Tite":3,"Philémon":1,"Hébreux":13,"Jacques":5,"1 Pierre":5,"2 Pierre":3,"1 Jean":5,"2 Jean":1,"3 Jean":1,"Jude":1,"Apocalypse":22};
    const ALIAS={gen:'Genèse',gn:'Genèse',ex:'Exode',exo:'Exode',lev:'Lévitique',lv:'Lévitique',nb:'Nombres',nbr:'Nombres',deut:'Deutéronome',dt:'Deutéronome',jos:'Josué',jg:'Juges',ru:'Ruth','1sa':'1 Samuel','2sa':'2 Samuel','1r':'1 Rois','2r':'2 Rois','1ch':'1 Chroniques','2ch':'2 Chroniques',esd:'Esdras',neh:'Néhémie',est:'Esther',ps:'Psaumes',prov:'Proverbes',eccl:'Ecclésiaste',cant:'Cantique',es:'Ésaïe',jr:'Jérémie',lam:'Lamentations',ez:'Ézéchiel',dn:'Daniel',os:'Osée',jl:'Joël',am:'Amos',abd:'Abdias',jon:'Jonas',mic:'Michée',nah:'Nahum',hb:'Habacuc',so:'Sophonie',ag:'Aggée',za:'Zacharie',ml:'Malachie',mt:'Matthieu',mc:'Marc',lc:'Luc',jn:'Jean',ac:'Actes',rm:'Romains','1co':'1 Corinthiens','2co':'2 Corinthiens',ga:'Galates',eph:'Éphésiens',php:'Philippiens',cl:'Colossiens','1th':'1 Thessaloniciens','2th':'2 Thessaloniciens','1ti':'1 Timothée','2ti':'2 Timothée',tt:'Tite',phm:'Philémon',he:'Hébreux',ja:'Jacques','1p':'1 Pierre','2p':'2 Pierre','1j':'1 Jean','2j':'2 Jean','3j':'3 Jean',jud:'Jude',ap:'Apocalypse'};

    const POINTS=[
      "Prière d’ouverture — Invocation du Saint-Esprit pour éclairer mon étude.",
      "Canon et testament — Identifier le livre dans le canon (Ancien/Nouveau Testament).",
      "Questions du chapitre précédent — Minimum 5 questions, avec réponses intégrales pour vérifier la compréhension.",
      "Titre du chapitre — Résumé doctrinal synthétique du passage.",
      "Contexte historique — Période, géopolitique, culture, avec carte visuelle localisée.",
      "Structure littéraire — Séquençage narratif et composition interne du chapitre.",
      "Genre littéraire — Type de texte (narratif, poétique, prophétique, etc.).",
      "Auteur et généalogie — Présentation de l’auteur et lien aux patriarches (avec arbre généalogique).",
      "Verset-clé doctrinal — Verset central du chapitre (cliquable vers BibleGateway).",
      "Analyse exégétique — Commentaire mot-à-mot avec références au grec/hébreu.",
      "Analyse lexicale — Analyse des mots-clés originaux et sens doctrinal.",
      "Références croisées — Passages parallèles ou complémentaires dans la Bible.",
      "Fondements théologiques — Doctrines majeures qui émergent du chapitre.",
      "Thème doctrinal — Lien entre ce chapitre et les 22 grands thèmes de la doctrine biblique.",
      "Fruits spirituels — Vertus et attitudes inspirées par le chapitre.",
      "Types bibliques — Symboles ou figures typologiques présents.",
      "Appui doctrinal — Autres passages bibliques qui confirment l’enseignement.",
      "Comparaison entre versets — Comparer des versets du chapitre pour mise en relief.",
      "Comparaison avec Actes 2 — Parallèle avec le début de l’Église et l’action du Saint-Esprit.",
      "Verset à mémoriser — Verset essentiel à retenir dans ma vie spirituelle.",
      "Enseignement pour l’Église — Implications collectives et ecclésiales.",
      "Enseignement pour la famille — Valeurs à transmettre dans le foyer chrétien.",
      "Enseignement pour enfants — Méthode simplifiée avec récits, images, jeux.",
      "Application missionnaire — Comment ce texte guide l’évangélisation.",
      "Application pastorale — Conseils pour les pasteurs et enseignants.",
      "Application personnelle — Examen de conscience et engagement individuel.",
      "Versets à retenir — Versets incontournables pour la prédication.",
      "Prière de fin — Clôture spirituelle de l’étude avec reconnaissance."
    ];

    /* ==================== STATE ==================== */
    let currentLivre=null,currentChap=null;

    /* ==================== UI helpers ==================== */
    function openMenu(el, open){ el.classList.toggle('open', open ?? !el.classList.contains('open')); }
    function fillBooks(){
      const m=$("#livreMenu"); m.innerHTML='';
      Object.keys(LIVRES_CHAP).forEach((name,idx)=>{
        const b=document.createElement('button'); b.type='button'; b.textContent=`${idx+1}. ${name}`;
        b.addEventListener('click',()=>selectBook(name,true)); m.appendChild(b);
      });
    }
    function fillChaps(livre){
      const m=$("#chapMenu"); m.innerHTML=''; const max=LIVRES_CHAP[livre]||1;
      for(let i=1;i<=max;i++){ const b=document.createElement('button'); b.type='button'; b.textContent=i; b.addEventListener('click',()=>selectChap(i,true)); m.appendChild(b); }
    }
    function selectBook(l,close){currentLivre=l;$("#livreLabel").textContent=l;$("#chapBtn").disabled=false;$("#chapLabel").textContent='Chapitre';currentChap=null;fillChaps(l);if(close)openMenu($("#livreMenu"),false);updateButtons();syncHash();refreshLastStudy(false);}
    function selectChap(c,close){currentChap=String(c);$("#chapLabel").textContent=currentChap;if(close)openMenu($("#chapMenu"),false);updateButtons();syncHash();refreshLastStudy(false);}
    function updateButtons(){ $("#lireBtn").disabled=!(currentLivre&&currentChap); }
    function syncHash(){ if(currentLivre&&currentChap){ history.replaceState(null,'',`#/${encodeURIComponent(currentLivre)}/${currentChap}?point=1`); } }
    function strip(s){return (s||'').normalize('NFD').replace(/[̀-ͯ]/g,'');}
    function norm(s){return strip(s).toLowerCase().replace(/[^a-z0-9]/g,'');}
    function resolveBook(t){const k=norm(t);if(ALIAS[k])return ALIAS[k];const f=Object.keys(ALIAS).find(a=>a.startsWith(k));if(f)return ALIAS[f];return Object.keys(LIVRES_CHAP).find(b=>norm(b).startsWith(k))||null;}
    function parseRef(raw){const s=(raw||'').trim().replace(/\s+/g,' ');if(!s)return{book:null,chap:null};const m=s.match(/^(.+?)\s+(\d{1,3})$/i);if(m)return{book:resolveBook(m[1]),chap:parseInt(m[2],10)};return{book:resolveBook(s)||null,chap:null};}

    /* ==================== Rendu des 28 sections ==================== */
    function renderSections(){
      const nav=$("#pointsNav"), host=$("#sectionsHost"); nav.innerHTML=''; host.innerHTML='';
      for(let i=1;i<=POINTS.length;i++){
        const btn=document.createElement('button'); btn.className='sidebar-item w-full text-left'; btn.dataset.section='p'+i;
        btn.innerHTML=`<span class="badge">${i}</span><span class="font-semibold">${POINTS[i-1]}</span>`;
        btn.addEventListener('click',()=>{document.querySelectorAll('#pointsNav .sidebar-item').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));btn.classList.add('active');$('#'+btn.dataset.section)?.classList.add('active');$("#welcome")?.classList.add('hidden');});
        nav.appendChild(btn);

        const sec=document.createElement('div'); sec.id='p'+i; sec.className='content-section';
        sec.innerHTML=`
          <h3 class="text-xl font-extrabold mb-2">${i}. ${POINTS[i-1]}</h3>
          <div class="rounded-xl border p-3 edit-wrap" aria-expanded="false">
            <div class="text-xs text-neutral-500 mb-1 flex justify-between">
              <span id="noteStatus-p${i}">En attente…</span>
              <div class="flex items-center gap-2">
                <button class="btn btn-ghost text-xs" data-edit="${i}">Éditer</button>
                <span><span id="wordCount-p${i}">0</span> mots</span>
              </div>
            </div>
            <article class="prose max-w-none display-note" id="view-p${i}"></article>
            <textarea id="note-p${i}" class="ghost-note w-full border rounded-lg p-3 mt-2" rows="12"></textarea>
          </div>`;
        host.appendChild(sec);
      }
      host.querySelectorAll('[data-edit]').forEach(b=>{
        b.addEventListener('click',()=>{ const id=b.getAttribute('data-edit'); const wrap=b.closest('.edit-wrap'); const ex=wrap.getAttribute('aria-expanded')==='true'; wrap.setAttribute('aria-expanded', String(!ex)); b.textContent=ex?'Éditer':'Aperçu'; });
      });
    }

    /* ==================== Markdown (léger) ==================== */
    function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
    function mdBold(t){return t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');}
    function mdLists(t){return t.replace(/^(?:\s*-\s.+\n?)+/gms,blk=>`<ul class="list-disc pl-5">${blk.trim().split('\n').map(l=>`<li>${l.replace(/^\s*-\s?/,'')}</li>`).join('')}</ul>`);}
    function mdTables(block){return block.replace(/^(?:\s*\|.+\|\s*)+$/gms,tbl=>{const rows=tbl.trim().split('\n').map(r=>r.trim().replace(/^\||\|$/g,''));const trs=rows.map((r,idx)=>`<tr class="${idx?'':'font-semibold bg-[var(--c50)]'}">${r.split('|').map(c=>`<td class="border px-2 py-1 align-top">${escapeHtml(c.trim())}</td>`).join('')}</tr>`).join('');return `<div class="overflow-x-auto my-2"><table class="w-full text-sm border">${trs}</table></div>`;});}
    function mdImages(t){return t.replace(/!\[([^\]]*)\]\((https?:\/\/[^\s)]+)\)/g,(_m,alt,src)=>`<figure class="my-3"><img src="${src}" alt="${escapeHtml(alt)}" loading="lazy"><figcaption class="text-xs text-slate-500 mt-1">${escapeHtml(alt)}</figcaption></figure>`);}
    function paragraphs(t){return t.split(/\n{2,}/).map(p=>`<p>${p}</p>`).join('');}
    function gatewayLink(book,chap,vers){const vMap={LSG:'LSG',BDS:'BDS',NEG1979:'NEG1979',SG21:'S21',PDV:'PDV-FR'};const code=vMap[$("#versionSelect").value]||'LSG';const ref=`${book} ${chap}${vers?(':'+vers):''}`;return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=${code}`;}
    function linkifyRefs(html){
      const bookRx="(?:[1-3]\\s*)?(?:Genèse|Exode|Lévitique|Nombres|Deutéronome|Josué|Juges|Ruth|1\\s*Samuel|2\\s*Samuel|1\\s*Rois|2\\s*Rois|1\\s*Chroniques|2\\s*Chroniques|Esdras|Néhémie|Esther|Job|Psaumes|Proverbes|Ecclésiaste|Cantique|Ésaïe|Esaïe|Jérémie|Lamentations|Ézéchiel|Ezechiel|Daniel|Osée|Joël|Amos|Abdias|Jonas|Michée|Nahum|Habacuc|Sophonie|Aggée|Zacharie|Malachie|Matthieu|Marc|Luc|Jean|Actes|Romains|1\\s*Corinthiens|2\\s*Corinthiens|Galates|Éphésiens|Philippiens|Colossiens|1\\s*Thessaloniciens|2\\s*Thessaloniciens|1\\s*Timothée|2\\s*Timothée|Tite|Philémon|Hébreux|Jacques|1\\s*Pierre|2\\s*Pierre|1\\s*Jean|2\\s*Jean|3\\s*Jean|Jude|Apocalypse)";
      const rx=new RegExp(`\\b(${bookRx})\\s+(\\d{1,3})(?:[.:](\\d{1,3}(?:[-–]\\d{1,3})?))?\\b`,'gi');
      return html.replace(rx,(m,bk,ch,vv)=>{const resolved=resolveBook(bk)||bk;return `<a target="_blank" rel="noopener" href="${gatewayLink(resolved,ch,vv||'')}">${m}</a>`;});
    }
    function mdToHtml(md){if(!md)return'';let t=md.replace(/\r/g,'').trim();t=mdImages(t);t=mdTables(t);t=mdLists(t);t=mdBold(t);t=paragraphs(t);t=linkifyRefs(t);return t;}
    function showPoint(i, md){ const html=mdToHtml(md); const view=$("#view-p"+i), wc=$("#wordCount-p"+i), st=$("#noteStatus-p"+i); view.innerHTML=html; wc.textContent=(md.trim()?md.trim().split(/\s+/).length:0); st.textContent='Généré ✓'; $("#note-p"+i).value=md; }

    /* ==================== Normalisation & contrôle ==================== */
    const BAN_RX=/(^|\n)\s*voici\s+\d+\s+points.*$/i;
    function clean(txt){ return String(txt||'').replace(BAN_RX,'').trim(); }
    function okLen(txt){ return (txt||'').replace(/\s+/g,' ').length >= MIN_CHARS; }

    /* ==================== Prompts stricts ==================== */
    // Instructions par point (ce qui oriente fortement l'IA)
    function rulesForPoint(n, book, chap){
      const base=`Rappelle le passage : ${book} ${chap}. Minimum ${MIN_CHARS} caractères. Utilise **gras**, listes, tableaux |a|b|, images ![alt](url) si pertinent, frises "YYYY — ...", et références bibliques cliquables (écris normalement, je ferai les liens). Interdis toute phrase du type "Voici X points..."`;
      switch(n){
        case 1:  return `${base}. Prière d’ouverture en **première personne** ("je"). Invoque le Saint-Esprit, relie explicitement à ${book} ${chap}. Pas de "nous".`;
        case 3:  return `${base}. Fourni STRICTEMENT un objet JSON:
{
 "q1":"Question 1 ...",
 "r1":"Réponse détaillée (exégèse, versets).",
 "q2":"...",
 "r2":"...",
 "q3":"...",
 "r3":"...",
 "q4":"...",
 "r4":"...",
 "q5":"...",
 "r5":"..."
}
Pas d'autre texte hors JSON. Questions précises sur le **chapitre précédent**. Chaque réponse longue et doctrinale.`;
        case 4:  return `${base}. Donne un titre doctrinal synthétique (court) puis un paragraphe d'explication solide.`;
        case 5:  return `${base}. Contexte historique: période, géopolitique, culture. Ajoute une carte sous forme d'image: ![Carte — ${book} ${chap}](https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/BlankMap-World.svg/1024px-BlankMap-World.svg.png) et une frise chronologique (format "YYYY — évènement").`;
        case 9:  return `${base}. Choisis **un verset-clé** du chapitre et ouvre par la citation exacte (référence entre parenthèses). Explique pourquoi doctrinalement.`;
        case 10: return `${base}. Analyse exégétique mot-à-mot avec mention grec/hébreu quand utile (translittération).`;
        case 20: return `${base}. Propose 1 verset à mémoriser, explique comment l’apprendre et l’appliquer.`;
        case 24: return `${base}. Application missionnaire: plans, dialogues, prudence, apologétique.`;
        case 25: return `${base}. Application pastorale: conseils **concrets** pour pasteurs/enseignants: structure de prédication, catéchèse, accompagnement, mise en garde.`;
        case 26: return `${base}. Application personnelle: examen de conscience à la première personne, engagements pratiques.`;
        case 28: return `${base}. Prière de fin en **première personne**, remerciements, supplication, centrée sur ${book} ${chap}. Pas de "nous".`;
        default: return `${base}. Respecte strictement l’intitulé: "${POINTS[n-1]}".`;
      }
    }

    // Schéma attendu (type JSON) : p3 est spécial
    function schemaForPoint(n){
      if(n===3){
        return {type:'object',keys:['q1','r1','q2','r2','q3','r3','q4','r4','q5','r5']};
      }
      return {type:'string'};
    }

    /* ==================== API ==================== */
    async function callAI(payload){
      const res=await fetch(API_URL_CHAT,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      const txt=await res.text(); let data; try{data=JSON.parse(txt);}catch{data={content:txt};}
      if(!res.ok){toast('API: '+(data?.error||data?.message||('HTTP '+res.status)),'err',7000);return null;}
      return data;
    }

    /* ==================== Génération par lots ==================== */
    function chunks(arr,size){const out=[];for(let i=0;i<arr.length;i+=size)out.push(arr.slice(i,i+size));return out;}
    async function generateAll(){
      if(!(currentLivre&&currentChap)){toast('Sélectionne un livre et un chapitre.','err');return;}
      $("#busyText").textContent='Génération…'; $("#busy").classList.remove('hidden');

      try{
        const all=[...Array(28)].map((_,i)=>i+1);
        for(const grp of chunks(all,BATCH)){
          const subPrompts = grp.map(n=>({n,rules:rulesForPoint(n,currentLivre,currentChap),schema:schemaForPoint(n)}));
          const data=await callAI({
            livre:currentLivre, chapitre:parseInt(currentChap,10),
            strict_28:true, subset:grp, min_chars:MIN_CHARS, prompts:subPrompts
          });
          if(!data) continue;

          for(const n of grp){
            const raw = data['p'+n] ?? data.content ?? '';
            let md='';
            if(n===3){
              // doit être objet avec q/r
              let obj=null; try{ obj = typeof raw==='string' ? JSON.parse(raw) : raw; }catch{}
              if(obj && ['q1','r1','q2','r2','q3','r3','q4','r4','q5','r5'].every(k=>typeof obj[k]==='string')){
                md = `### Questions & réponses (chapitre précédent)
${[1,2,3,4,5].map(i=>`**Q${i}. ${obj['q'+i]}**\n\n${obj['r'+i]}`).join('\n\n---\n\n')}`;
              }else{
                md = String(raw||''); // fallback
              }
            }else{
              md = typeof raw==='string' ? raw : JSON.stringify(raw);
            }
            md = clean(md);

            // Longueur minimale (relance 1 fois si trop court)
            if(!okLen(md)){
              const retry = await callAI({
                livre:currentLivre, chapitre:parseInt(currentChap,10),
                force_point:n, min_chars:MIN_CHARS,
                prompt: rulesForPoint(n,currentLivre,currentChap) + ' Texte trop court précédemment : développe beaucoup plus, structure, exemples, références.'
              });
              const r2 = retry ? (retry['p'+n] ?? retry.content ?? '') : '';
              md = clean(typeof r2==='string'? r2 : JSON.stringify(r2));
            }

            showPoint(n, md);
          }
        }

        // Prières fallback ultra-sécurisées
        const p1=$("#note-p1").value.trim(); if(p1.length<200){ showPoint(1, `Père céleste, alors que je lis **${currentLivre} ${currentChap}**, éclaire mon intelligence... (développer)`) }
        const p28=$("#note-p28").value.trim(); if(p28.length<200){ showPoint(28, `Seigneur, je te rends grâce pour **${currentLivre} ${currentChap}**... (développer)`) }

        // Ouvre le premier point
        document.querySelector('#pointsNav .sidebar-item')?.click();
        toast('Étude générée.','ok');
      } finally {
        $("#busy").classList.add('hidden');
      }
    }

    /* ==================== Dernière étude ==================== */
    function setLastStudy(l,c){localStorage.setItem('derniere_etude',JSON.stringify({livre:l,chapitre:String(c)}));refreshLastStudy(true);}
    function getLast(){try{return JSON.parse(localStorage.getItem('derniere_etude')||'null');}catch{return null;}}
    function refreshLastStudy(){const last=getLast();const label=last?`${last.livre} ${last.chapitre}`:'—';$("#lastStudyPill").textContent=`Dernière étude : ${label}`;$("#lastStudyInline").textContent=label;}

    /* ==================== Init ==================== */
    document.addEventListener('DOMContentLoaded',()=>{
      fillBooks(); renderSections(); refreshLastStudy();

      $("#livreBtn").addEventListener('click',()=>openMenu($("#livreMenu")));
      $("#chapBtn").addEventListener('click',()=>openMenu($("#chapMenu")));

      let si=null;
      $("#searchInput").addEventListener('input',()=>{clearTimeout(si);si=setTimeout(()=>{const r=parseRef($("#searchInput").value);if(!r.book)return;selectBook(r.book,false);if(r.chap)selectChap(r.chap,false);},140);});
      $("#searchInput").addEventListener('keydown',e=>{if(e.key==='Enter'){const r=parseRef($("#searchInput").value);if(!r.book){toast('Ex : « jean 3 », « exo 3 ».','err');return;}selectBook(r.book,false);selectChap(r.chap||1,false);}});

      $("#validerBtn").addEventListener('click',async()=>{if(!(currentLivre&&currentChap)){toast('Sélectionne un livre et un chapitre.','err');return;} setLastStudy(currentLivre,currentChap); await generateAll();});
      $("#generateBtn").addEventListener('click',generateAll);

      $("#resumeBtn").addEventListener('click',()=>{const last=getLast();if(!last){toast('Aucune étude enregistrée.','err');return;}selectBook(last.livre,false);selectChap(parseInt(last.chapitre,10),false);toast(`Repris : ${last.livre} ${last.chapitre}`,'ok');});

      $("#reinitBtn").addEventListener('click',()=>{currentLivre=null;currentChap=null;$("#livreLabel").textContent='Sélectionner un livre';$("#chapLabel").textContent='Chapitre';$("#chapBtn").disabled=true;$("#lireBtn").disabled=true;$("#searchInput").value='';history.replaceState(null,'','#');toast('Réinitialisé.','info');});

      $("#lireBtn").addEventListener('click',()=>{if(!(currentLivre&&currentChap))return; const url=gatewayLink(currentLivre,currentChap,''); window.open(url,'_blank','noopener');});
      $("#printBtn").addEventListener('click',()=>window.print());

      $("#exportMdBtn").addEventListener('click',()=>{if(!(currentLivre&&currentChap)){toast('Sélectionne un passage.','err');return;} let out=`# ${currentLivre} ${currentChap}\n\n_Généré : ${new Date().toLocaleString()}_\n\n`; for(let i=1;i<=28;i++){ const title=POINTS[i-1]; const note=($("#note-p"+i).value||'').trim(); out+=`## ${i}. ${title}\n\n${note||'_(vide)_'}\n\n`; } const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([out],{type:'text/markdown;charset=utf-8'})); a.download=`Etude_${currentLivre.replace(/\s+/g,'_')}_${currentChap}.md`; document.body.appendChild(a); a.click(); a.remove();});
      $("#copyLinkBtn").addEventListener('click',async()=>{const url=new URL(location.href);url.hash=(currentLivre&&currentChap)?`#/${encodeURIComponent(currentLivre)}/${currentChap}?point=1`:'#';try{await navigator.clipboard.writeText(url.toString());toast('Lien copié.','ok');}catch{toast('Copie impossible.','err');}});

      // hash
      if(location.hash){const m=location.hash.match(/^#\/([^\/]+)\/(\d+)/);if(m){selectBook(decodeURIComponent(m[1]),false);selectChap(parseInt(m[2],10),false);}}
      document.querySelector('#pointsNav .sidebar-item')?.click();
    });
  </script>
</body>
</html>
