<!DOCTYPE html>
<html lang="fr" class="h-full theme-indigo">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>√âtude Biblique</title>

  <!-- Tailwind config (CDN ok pour avancer ; on pourra compiler plus tard) -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary:{50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81'},
            slate: {50:'#f8fafc',100:'#f1f5f9',200:'#e2e8f0',300:'#cbd5e1',400:'#94a3b8',500:'#64748b',600:'#475569',700:'#334155',800:'#1e293b',900:'#0f172a'}
          },
          fontFamily:{sans:['"Plus Jakarta Sans"','Inter','system-ui','Arial','sans-serif']},
          boxShadow:{card:'0 10px 25px -12px rgba(2,6,23,.18),0 8px 10px -6px rgba(2,6,23,.1)'}
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root{color-scheme:light dark}
    body{font-family:"Plus Jakarta Sans",Inter,system-ui,Arial,sans-serif;background:#f6f7fb}
    .dark body{background:#0b1220}
    .container-xl{max-width:1200px;margin-inline:auto}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),0 10px 25px -12px rgba(2,6,23,.18),0 8px 10px -6px rgba(2,6,23,.1)}
    .dark .card{background:#0f172a;border-color:#1f2937}
    .content-section{display:none;opacity:0;transition:opacity .18s ease}
    .content-section.active{display:block;opacity:1}
    .sidebar-item{border:1px solid transparent;border-radius:12px;padding:.6rem .7rem;display:flex;align-items:flex-start;gap:.6rem}
    .sidebar-item:hover{background:#eef2ff;border-color:#c7d2fe}
    .sidebar-item.active{background:#e0e7ff;border-color:#c7d2fe;box-shadow:inset 4px 0 0 0 #6366f1}
    .dropdown{position:relative}
    .menu{position:absolute;left:0;right:0;z-index:30;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 25px -12px rgba(2,6,23,.18);max-height:280px;overflow:auto;display:none}
    .menu.open{display:block}
    .menu::-webkit-scrollbar{width:8px;height:8px}
    .menu::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:999px}
    .menu button{display:block;width:100%;text-align:left;padding:.55rem .8rem}
    .menu button:hover{background:#eef2ff}
    .pill{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:.25rem .6rem}
    .badge{display:inline-grid;place-items:center;width:1.9rem;height:1.9rem;border-radius:.55rem;background:#e0e7ff;color:#3730a3;font-weight:800;font-size:.75rem}
    .toast{position:fixed;right:12px;bottom:12px;background:#111827;color:#fff;padding:.6rem .9rem;border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,.15);z-index:200;transition:opacity .25s, transform .25s}
  </style>
</head>

<body class="min-h-screen">
  <div id="toasts"></div>

  <div class="min-h-screen flex flex-col">
    <!-- HEADER -->
    <header class="sticky top-0 z-30 bg-white/95 dark:bg-neutral-900/95 border-b border-neutral-200 dark:border-neutral-800 backdrop-blur">
      <div class="container-xl px-4">
        <div class="py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl grid place-items-center bg-primary-100 text-primary-700 shadow">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
            </div>
            <div>
              <h1 class="text-2xl font-extrabold tracking-wide">√âtude Biblique</h1>
              <p class="text-xs text-slate-600 -mt-1">Explorer les √âcritures en profondeur</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="pill text-xs" id="lastStudyPill">Derni√®re √©tude : ‚Äî</span>
            <button id="resumeBtn" class="px-3 py-1.5 rounded-lg border text-sm">Reprendre</button>
            <button id="printBtn" class="px-3 py-1.5 rounded-lg border text-sm">Imprimer / PDF</button>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 py-6">
      <div class="container-xl px-4">
        <!-- Bandeau recherche + s√©lection -->
        <section class="card p-4 sm:p-6 mb-6">
          <div class="grid grid-cols-12 gap-3 items-end">
            <!-- Recherche -->
            <div class="col-span-12">
              <label class="text-sm font-semibold block mb-1">Recherche</label>
              <div class="relative">
                <svg class="w-4 h-4 text-neutral-400 absolute left-3 top-3" viewBox="0 0 24 24" fill="currentColor"><path d="M10 18a8 8 0 1 1 5.293-14.293A8 8 0 0 1 10 18zm11 3-6-6"/></svg>
                <input id="searchInput" class="w-full border rounded-lg pl-9 pr-3 py-2.5" placeholder="Tape ‚Äòmar 5‚Äô, ‚Äòjean 3:16‚Äô, ‚Äò1co 13.4-7‚Äô‚Ä¶">
              </div>
              <p class="text-xs text-neutral-500 mt-1">Abr√©viations OK : mar, jn, 1co, rm‚Ä¶ accents facultatifs.</p>
            </div>

            <!-- Livre -->
            <div class="col-span-12 md:col-span-5">
              <label class="text-sm font-semibold block mb-1">Livre</label>
              <div class="dropdown">
                <button id="livreBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between">
                  <span id="livreLabel">S√©lectionner un livre</span>
                  <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
                </button>
                <div id="livreMenu" class="menu"></div>
              </div>
            </div>

            <!-- Chapitre -->
            <div class="col-span-6 md:col-span-3">
              <label class="text-sm font-semibold block mb-1">Chapitre</label>
              <div class="dropdown">
                <button id="chapBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between" disabled>
                  <span id="chapLabel">Chapitre</span>
                  <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
                </button>
                <div id="chapMenu" class="menu"></div>
              </div>
            </div>

            <!-- Version -->
            <div class="col-span-6 md:col-span-2">
              <label class="text-sm font-semibold block mb-1">Version</label>
              <select id="versionSelect" class="w-full bg-white border rounded-lg py-2.5 px-4">
                <option value="LSG" selected>LSG ‚Äî Louis Segond</option>
                <option value="SG21">SG21 ‚Äî Segond 21</option>
                <option value="NEG1979">NEG79 ‚Äî Nouvelle √âdition de Gen√®ve</option>
                <option value="BDS">BDS ‚Äî La Bible du Semeur</option>
                <option value="PDV">PDV ‚Äî Parole de Vie</option>
              </select>
            </div>

            <!-- Actions -->
            <div class="col-span-12 flex flex-wrap gap-2 mt-2">
              <!-- ‚úÖ Bouton Valider bien visible -->
              <button id="validerBtn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold px-4 py-2 rounded-lg shadow">
                Valider (28 pts)
              </button>
              <button id="reinitBtn" class="px-4 py-2 rounded-lg border">R√©initialiser</button>
              <button id="lireBtn" class="px-4 py-2 rounded-lg border" disabled>Lire (BibleGateway)</button>

              <div class="ml-auto flex gap-2">
                <select id="pointsSelect" class="border rounded-lg px-3 py-2">
                  <option value="8">8 points (rapide)</option>
                  <option value="12">12 points</option>
                  <option value="28" selected>28 points</option>
                </select>
                <button id="generateBtn" class="bg-primary-600 hover:bg-primary-700 text-white font-bold px-4 py-2 rounded-lg shadow">
                  G√©n√©rer IA
                </button>
              </div>
            </div>

            <!-- Derni√®re √©tude (zone visible sous le bandeau) -->
            <div class="col-span-12">
              <div class="mt-3 text-sm text-slate-700">
                <span class="font-semibold">Derni√®re √©tude :</span>
                <span id="lastStudyInline">‚Äî</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Corps -->
        <div class="grid grid-cols-12 gap-6">
          <!-- NAV points -->
          <aside class="col-span-12 lg:col-span-4">
            <div class="card p-3 sticky top-20 max-h-[calc(100vh-140px)] overflow-y-auto">
              <h2 class="text-lg font-extrabold mb-2">Points d‚Äô√©tude</h2>
              <nav id="pointsNav" class="space-y-1"></nav>
            </div>
          </aside>

          <!-- CONTENU -->
          <section class="col-span-12 lg:col-span-8">
            <div class="card relative">
              <div id="busy" class="hidden absolute inset-0 bg-white/70 dark:bg-black/40 z-10 grid place-items-center">
                <div class="rounded-xl border bg-white dark:bg-neutral-900 px-4 py-3 shadow-md text-sm flex items-center gap-2">
                  <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                  <span id="busyText">G√©n√©ration‚Ä¶</span>
                </div>
              </div>
              <div id="contentArea" class="p-5 sm:p-6">
                <div id="welcome" class="text-center py-10">
                  <div class="w-16 h-16 rounded-xl bg-primary-50 text-primary-700 grid place-items-center mx-auto mb-3">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
                  </div>
                  <h3 class="text-lg font-bold mb-2">Bienvenue üëã</h3>
                  <p class="text-neutral-600">Choisis un livre et un chapitre, ou tape une r√©f√©rence dans la recherche. Clique <b>Valider</b> pour lancer les 28 points.</p>
                </div>
                <div id="sectionsHost"></div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button id="exportMdBtn" class="px-3 py-1.5 rounded-lg border text-sm">Exporter (Markdown)</button>
              <button id="copyLinkBtn" class="px-3 py-1.5 rounded-lg border text-sm">Copier le lien</button>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ---------- Donn√©es ---------- */
    const LIVRES_CHAP = {"Gen√®se":50,"Exode":40,"L√©vitique":27,"Nombres":36,"Deut√©ronome":34,"Josu√©":24,"Juges":21,"Ruth":4,"1 Samuel":31,"2 Samuel":24,"1 Rois":22,"2 Rois":25,"1 Chroniques":29,"2 Chroniques":36,"Esdras":10,"N√©h√©mie":13,"Esther":10,"Job":42,"Psaumes":150,"Proverbes":31,"Eccl√©siaste":12,"Cantique":8,"√âsa√Øe":66,"J√©r√©mie":52,"Lamentations":5,"√âz√©chiel":48,"Daniel":12,"Os√©e":14,"Jo√´l":3,"Amos":9,"Abdias":1,"Jonas":4,"Mich√©e":7,"Nahum":3,"Habacuc":3,"Sophonie":3,"Agg√©e":2,"Zacharie":14,"Malachie":4,"Matthieu":28,"Marc":16,"Luc":24,"Jean":21,"Actes":28,"Romains":16,"1 Corinthiens":16,"2 Corinthiens":13,"Galates":6,"√âph√©siens":6,"Philippiens":4,"Colossiens":4,"1 Thessaloniciens":5,"2 Thessaloniciens":3,"1 Timoth√©e":6,"2 Timoth√©e":4,"Tite":3,"Phil√©mon":1,"H√©breux":13,"Jacques":5,"1 Pierre":5,"2 Pierre":3,"1 Jean":5,"2 Jean":1,"3 Jean":1,"Jude":1,"Apocalypse":22};

    const ALIAS = {gen:'Gen√®se',gn:'Gen√®se',ex:'Exode',exo:'Exode',lev:'L√©vitique',lv:'L√©vitique',nb:'Nombres',nbr:'Nombres',deut:'Deut√©ronome',dt:'Deut√©ronome',jos:'Josu√©',jg:'Juges',ru:'Ruth','1sa':'1 Samuel','2sa':'2 Samuel','1r':'1 Rois','2r':'2 Rois','1ch':'1 Chroniques','2ch':'2 Chroniques',esd:'Esdras',neh:'N√©h√©mie',est:'Esther',ps:'Psaumes',prov:'Proverbes',eccl:'Eccl√©siaste',cant:'Cantique',es:'√âsa√Øe',jr:'J√©r√©mie',lam:'Lamentations',ez:'√âz√©chiel',dn:'Daniel',os:'Os√©e',jl:'Jo√´l',am:'Amos',abd:'Abdias',jon:'Jonas',mic:'Mich√©e',nah:'Nahum',hb:'Habacuc',so:'Sophonie',ag:'Agg√©e',za:'Zacharie',ml:'Malachie',mt:'Matthieu',mc:'Marc',lc:'Luc',jn:'Jean',ac:'Actes',rm:'Romains','1co':'1 Corinthiens','2co':'2 Corinthiens',ga:'Galates',eph:'√âph√©siens',php:'Philippiens',cl:'Colossiens','1th':'1 Thessaloniciens','2th':'2 Thessaloniciens','1ti':'1 Timoth√©e','2ti':'2 Timoth√©e',tt:'Tite',phm:'Phil√©mon',he:'H√©breux',ja:'Jacques','1p':'1 Pierre','2p':'2 Pierre','1j':'1 Jean','2j':'2 Jean','3j':'3 Jean',jud:'Jude',ap:'Apocalypse'};

    const POINTS = [
      "Pri√®re d‚Äôouverture","Canon et testament","Contexte historique","Auteur et destinataires","Structure du passage","Mots-cl√©s et th√®mes",
      "Observation du texte","Interpr√©tation","Parall√®les bibliques","Contexte th√©ologique","Application personnelle","Application communautaire",
      "Promesses et avertissements","Christ au centre","Pri√®re d‚Äôillumination","Questions de discussion","√âtude des personnages","Analyse litt√©raire",
      "Cadre culturel","Original grec/h√©breu","Difficult√©s du texte","Implications pratiques","Mission et t√©moignage","Louange / Adoration",
      "M√©ditation","Engagement","Plan d‚Äôaction","Pri√®re de fin"
    ];

    const $ = (s)=>document.querySelector(s);
    const API_URL_CHAT = new URL('./api/chat', location.href).toString();

    function toast(msg, kind='info', ms=3800){
      const z=$("#toasts"); const d=document.createElement('div');
      d.className='toast'; d.textContent=msg;
      d.style.background = kind==='err' ? '#ef4444' : (kind==='ok' ? '#10b981' : '#111827');
      z.appendChild(d);
      setTimeout(()=>{d.style.opacity='0';d.style.transform='translateY(4px)';}, ms-300);
      setTimeout(()=>d.remove(), ms);
    }

    /* ---------- Dropdowns ---------- */
    function openMenu(el, open){ el.classList.toggle('open', open ?? !el.classList.contains('open')); }
    function fillBooks(){
      const m = $('#livreMenu'); m.innerHTML = '';
      Object.keys(LIVRES_CHAP).forEach((name, idx)=>{
        const b = document.createElement('button');
        b.type='button'; b.textContent = `${idx+1}. ${name}`;
        b.addEventListener('click', ()=> selectBook(name, true));
        m.appendChild(b);
      });
    }
    function fillChapters(livre){
      const m = $('#chapMenu'); m.innerHTML = '';
      const max = LIVRES_CHAP[livre] || 1;
      for (let i=1;i<=max;i++){
        const b = document.createElement('button');
        b.type='button'; b.textContent = i;
        b.addEventListener('click', ()=> selectChapter(i, true));
        m.appendChild(b);
      }
    }

    let currentLivre=null, currentChap=null;

    function selectBook(livre, closeMenus){
      currentLivre = livre;
      $('#livreLabel').textContent = livre;
      $('#chapBtn').disabled = false;
      $('#chapLabel').textContent = 'Chapitre';
      currentChap = null;
      fillChapters(livre);
      if (closeMenus) openMenu($('#livreMenu'), false);
      updateButtons(); updateHash(); refreshLastStudyUI(false);
    }
    function selectChapter(chap, closeMenus){
      currentChap = String(chap);
      $('#chapLabel').textContent = currentChap;
      if (closeMenus) openMenu($('#chapMenu'), false);
      updateButtons(); updateHash(); refreshLastStudyUI(false);
    }

    function updateButtons(){ $('#lireBtn').disabled = !(currentLivre && currentChap); }
    function updateHash(){
      if (currentLivre && currentChap){
        history.replaceState(null,'',`#/${encodeURIComponent(currentLivre)}/${currentChap}?point=1`);
      }
    }

    /* ---------- Recherche ---------- */
    function strip(s){return (s||'').normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'');}
    function norm(s){return strip(s).toLowerCase().replace(/[^a-z0-9]/g,'');}
    function resolveBook(term){
      const k = norm(term);
      if (ALIAS[k]) return ALIAS[k];
      const first = Object.keys(ALIAS).find(a=>a.startsWith(k));
      if (first) return ALIAS[first];
      return Object.keys(LIVRES_CHAP).find(b=>norm(b).startsWith(k)) || null;
    }
    function parseRef(raw){
      const s=(raw||'').trim().replace(/\s+/g,' ');
      if(!s) return {book:null, chap:null};
      const m=s.match(/^(.+?)[\s,;]+(\d{1,3})/i);
      if(m) return {book:resolveBook(m[1]),chap:parseInt(m[2],10)};
      return {book:resolveBook(s)||null, chap:null};
    }

    /* ---------- Points & autosave (sans num√©ro en double) ---------- */
    function renderPoints(){
      const nav = $('#pointsNav'); const host = $('#sectionsHost');
      nav.innerHTML=''; host.innerHTML='';
      for(let i=1;i<=POINTS.length;i++){
        const btn=document.createElement('button');
        btn.className='sidebar-item w-full text-left'; btn.dataset.section='p'+i;
        btn.innerHTML=`<span class="badge">${i}</span><span class="font-semibold">${POINTS[i-1]}</span>`;
        btn.addEventListener('click',()=>{
          document.querySelectorAll('#pointsNav .sidebar-item').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
          btn.classList.add('active'); $('#'+btn.dataset.section)?.classList.add('active');
          $('#welcome')?.classList.add('hidden');
        });
        nav.appendChild(btn);

        const sec=document.createElement('div'); sec.id='p'+i; sec.className='content-section';
        sec.innerHTML=`<h3 class="text-xl font-extrabold mb-2">${POINTS[i-1]}</h3>
          <div class="rounded-xl border p-3">
            <div class="text-xs text-neutral-500 mb-1 flex justify-between">
              <span id="noteStatus-p${i}">Auto-enregistr√©</span>
              <span><span id="wordCount-p${i}">0</span> mots</span>
            </div>
            <textarea id="note-p${i}" class="w-full border rounded-lg p-3" rows="6" placeholder="Vos notes‚Ä¶"></textarea>
          </div>`;
        host.appendChild(sec);
      }
      for(let i=1;i<=28;i++){
        const ta=$('#note-p'+i), wc=$('#wordCount-p'+i), st=$('#noteStatus-p'+i);
        ta.addEventListener('input',()=>{
          const txt=ta.value.trim(); wc.textContent=txt?txt.split(/\s+/).length:0;
          st.textContent='Enregistrement‚Ä¶'; clearTimeout(ta._t);
          ta._t=setTimeout(()=>{
            if(currentLivre&&currentChap){
              localStorage.setItem(`notes::${currentLivre}::${currentChap}::${i}`,ta.value);
              st.textContent='Enregistr√© ‚úì';
            }
          },300);
        });
      }
    }
    function loadSavedNotes(){
      if(!(currentLivre&&currentChap)) return;
      for(let i=1;i<=28;i++){
        const key=`notes::${currentLivre}::${currentChap}::${i}`, txt=localStorage.getItem(key)||'';
        const ta=$('#note-p'+i), wc=$('#wordCount-p'+i);
        ta.value=txt; wc.textContent=txt.trim()?txt.trim().split(/\s+/).length:0;
      }
    }

    /* ---------- Normalisation r√©ponse ---------- */
    function trySplitToPoints(str){
      if(!str) return [];
      const lines=String(str).replace(/\r/g,'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const isPoint=s=>/^(\d{1,2}[\.\)]\s+|-|\‚Ä¢)\s*/.test(s);
      const pts=[]; let buf=[];
      const flush=()=>{ if(buf.length){ pts.push(buf.join(' ')); buf=[]; } };
      for(const ln of lines){ if(isPoint(ln)){ flush(); buf.push(ln.replace(/^(\d{1,2}[\.\)]\s+|-|\‚Ä¢)\s*/,'').trim()); } else buf.push(ln); }
      flush();
      if(!pts.length){ const byNum=String(str).split(/\n?\s*\d{1,2}[\.\)]\s+/).map(s=>s.trim()).filter(Boolean); if(byNum.length>1) return byNum; }
      return pts.length?pts:[str];
    }
    function normalizeToP28(data){
      const out={};
      if(!data) return out;
      const keys=Object.keys(data).filter(k=>/^p\d{1,2}$/.test(k));
      if(keys.length){ for(let i=1;i<=28;i++){ const v=data['p'+i]; if(typeof v==='string'&&v.trim()) out['p'+i]=v.trim(); } return out; }
      if(Array.isArray(data.points)&&data.points.length){ for(let i=1;i<=28&&i<=data.points.length;i++){ const v=data.points[i-1]; if(typeof v==='string'&&v.trim()) out['p'+i]=v.trim(); } return out; }
      if(typeof data.content==='string'&&data.content.trim()){ const parts=trySplitToPoints(data.content); for(let i=1;i<=28&&i<=parts.length;i++) out['p'+i]=parts[i-1]; return out; }
      out.p1=JSON.stringify(data); return out;
    }

    /* ---------- Pri√®res fallback (adapt√©es) ---------- */
    function buildOpeningPrayer(book, chap){
      return `P√®re c√©leste, nous venons devant toi avec gratitude pour ta Parole. `
        + `Alors que nous ouvrons ${book} ${chap}, accorde-nous un c≈ìur humble et attentif. `
        + `Que ton Esprit √©claire notre intelligence, afin que ce passage nous conduise vers Christ `
        + `et transforme nos vies. Au nom de J√©sus, amen.`;
    }
    function buildClosingPrayer(book, chap){
      return `Seigneur, merci pour la lumi√®re re√ßue √† travers ${book} ${chap}. `
        + `Scelle en nous ces v√©rit√©s, aide-nous √† les mettre en pratique `
        + `et fais de nous des t√©moins fid√®les. Nous te prions au nom de J√©sus. Amen.`;
    }

    function fillFromServer(data){
      const obj=normalizeToP28(data);
      for(let i=1;i<=28;i++){
        const v=obj['p'+i]; if(typeof v!=='string'||!v.trim()) continue;
        const ta=$('#note-p'+i), wc=$('#wordCount-p'+i), st=$('#noteStatus-p'+i);
        ta.value=v.trim(); wc.textContent=v.trim().split(/\s+/).filter(Boolean).length; st.textContent='G√©n√©r√© par IA ‚úì';
        if(currentLivre&&currentChap){ localStorage.setItem(`notes::${currentLivre}::${currentChap}::${i}`,v.trim()); }
      }
      const p1=$('#note-p1'), w1=$('#wordCount-p1'), s1=$('#noteStatus-p1');
      if(p1.value.trim().length < 80){
        p1.value = buildOpeningPrayer(currentLivre, currentChap);
        w1.textContent = p1.value.split(/\s+/).length; s1.textContent='Pri√®re d‚Äôouverture (adapt√©e) ‚úì';
        localStorage.setItem(`notes::${currentLivre}::${currentChap}::1`, p1.value);
      }
      const p28=$('#note-p28'), w28=$('#wordCount-p28'), s28=$('#noteStatus-p28');
      if(p28.value.trim().length < 80){
        p28.value = buildClosingPrayer(currentLivre, currentChap);
        w28.textContent = p28.value.split(/\s+/).length; s28.textContent='Pri√®re de fin (adapt√©e) ‚úì';
        localStorage.setItem(`notes::${currentLivre}::${currentChap}::28`, p28.value);
      }
      document.querySelector('#pointsNav .sidebar-item')?.click();
    }

    /* ---------- Appel backend ---------- */
    async function callServerAI(payload){
      const res = await fetch(API_URL_CHAT,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      const txt = await res.text(); let data; try{ data=JSON.parse(txt); }catch{ data={content:txt}; }
      if(!res.ok){ toast('API : '+(data?.error||data?.message||('HTTP '+res.status)),'err',6000); return null; }
      return data;
    }

    async function generate(force28=false){
      if(!(currentLivre&&currentChap)){ toast('S√©lectionne un livre et un chapitre.','err'); return; }
      if(force28){ $('#pointsSelect').value='28'; }
      const points=parseInt($('#pointsSelect').value,10)||28;

      $('#busyText').textContent=`G√©n√©ration (${currentLivre} ${currentChap})‚Ä¶`;
      $('#busy').classList.remove('hidden');
      try{
        const data = await callServerAI({
          livre: currentLivre,
          chapitre: parseInt(currentChap,10),
          points,
          hint: "Inclure une pri√®re d‚Äôouverture et une pri√®re de fin adapt√©es au passage."
        });
        if(data){ fillFromServer(data); toast('√âtude g√©n√©r√©e.','ok'); }
      }finally{ $('#busy').classList.add('hidden'); }
    }

    /* ---------- Derni√®re √©tude (affichage + reprise) ---------- */
    function setLastStudy(livre, chap){
      const payload = {livre, chapitre:String(chap)};
      localStorage.setItem('derniere_etude', JSON.stringify(payload));
      refreshLastStudyUI(true);
    }
    function getLastStudy(){
      try{ return JSON.parse(localStorage.getItem('derniere_etude')||'null'); }catch{ return null; }
    }
    function refreshLastStudyUI(mirrorOnly){
      const last = getLastStudy();
      const label = last ? `${last.livre} ${last.chapitre}` : '‚Äî';
      $('#lastStudyPill').textContent = `Derni√®re √©tude : ${label}`;
      $('#lastStudyInline').textContent = label;
      if (!mirrorOnly && currentLivre && currentChap){
        // rien
      }
    }

    /* ---------- Init UI ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      fillBooks();
      $('#livreBtn').addEventListener('click',()=>openMenu($('#livreMenu')));
      $('#chapBtn').addEventListener('click',()=>openMenu($('#chapMenu')));

      // Recherche -> remplit Livre/Chapitre
      let si=null;
      $('#searchInput').addEventListener('input',()=>{
        clearTimeout(si);
        si=setTimeout(()=>{
          const r=parseRef($('#searchInput').value);
          if(!r.book) return;
          selectBook(r.book,false);
          if(r.chap) selectChapter(r.chap,false);
        },120);
      });
      $('#searchInput').addEventListener('keydown',(e)=>{
        if(e.key==='Enter'){
          const r=parseRef($('#searchInput').value);
          if(!r.book){ toast('Ex : ¬´ mar 5 ¬ª, ¬´ jean 3:16 ¬ª.','err'); return; }
          selectBook(r.book,false);
          selectChapter(r.chap||1,false);
        }
      });

      // Valider ‚Üí sauvegarde la derni√®re √©tude + lance 28 points
      $('#validerBtn').addEventListener('click', async ()=>{
        if(!(currentLivre&&currentChap)){ toast('S√©lectionne un livre et un chapitre.','err'); return; }
        setLastStudy(currentLivre, currentChap);
        loadSavedNotes(); // recharge brouillons
        await generate(true); // force 28 points
      });

      // Reprendre derni√®re √©tude
      $('#resumeBtn').addEventListener('click', ()=>{
        const last = getLastStudy(); if(!last){ toast('Aucune √©tude enregistr√©e.','err'); return; }
        selectBook(last.livre,false);
        selectChapter(parseInt(last.chapitre,10),false);
        toast(`Repris : ${last.livre} ${last.chapitre}`,'ok');
      });

      $('#reinitBtn').addEventListener('click',()=>{
        currentLivre=null; currentChap=null;
        $('#livreLabel').textContent='S√©lectionner un livre';
        $('#chapLabel').textContent='Chapitre';
        $('#chapBtn').disabled=true; $('#lireBtn').disabled=true;
        $('#searchInput').value=''; history.replaceState(null,'','#');
        toast('R√©initialis√©.','info');
      });

      $('#lireBtn').addEventListener('click',()=>{
        if(!(currentLivre&&currentChap)) return;
        const vMap={LSG:'LSG',BDS:'BDS',NEG1979:'NEG1979',SG21:'S21',PDV:'PDV-FR'};
        const code=vMap[$('#versionSelect').value]||'LSG';
        const ref=currentLivre+' '+currentChap;
        window.open('https://www.biblegateway.com/passage/?search='+encodeURIComponent(ref)+'&version='+code,'_blank','noopener');
      });

      $('#generateBtn').addEventListener('click', ()=>generate(false));
      $('#printBtn').addEventListener('click',()=>window.print());

      $('#exportMdBtn').addEventListener('click',()=>{
        if(!(currentLivre&&currentChap)){ toast('S√©lectionne un passage.','err'); return; }
        let out=`# ${currentLivre} ${currentChap}\n\n_G√©n√©r√© : ${new Date().toLocaleString()}_\n\n`;
        for(let i=1;i<=28;i++){ const title=POINTS[i-1]; const note=($('#note-p'+i).value||'').trim(); out+=`## ${i}. ${title}\n\n${note||'_(vide)_'}\n\n`; }
        const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([out],{type:'text/markdown;charset=utf-8'})); a.download=`Etude_${currentLivre.replace(/\s+/g,'_')}_${currentChap}.md`; document.body.appendChild(a); a.click(); a.remove();
      });
      $('#copyLinkBtn').addEventListener('click',async()=>{
        const url=new URL(location.href); url.hash=(currentLivre&&currentChap)?`#/${encodeURIComponent(currentLivre)}/${currentChap}?point=1`:'#';
        try{ await navigator.clipboard.writeText(url.toString()); toast('Lien copi√©.','ok'); }catch{ toast('Copie impossible.','err'); }
      });

      renderPoints();
      document.querySelector('#pointsNav .sidebar-item')?.click();

      // Hash initial
      if(location.hash){
        const m=location.hash.match(/^#\/([^\/]+)\/(\d+)/);
        if(m){ selectBook(decodeURIComponent(m[1]),false); selectChapter(parseInt(m[2],10),false); }
      }

      // Afficher l‚Äô√©ventuelle derni√®re √©tude d√®s le d√©part
      refreshLastStudyUI(true);
    });
  </script>
</body>
</html>
