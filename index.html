<!DOCTYPE html>
<html lang="fr" class="h-full theme-indigo">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>√âtude Biblique ‚Äî 28 points stricts</title>

  <!-- PAS DE CDN: le CSS est compil√© vers /dist/output.css -->
  <link rel="stylesheet" href="/dist/output.css" />

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root{color-scheme:light dark}
    body{font-family:"Plus Jakarta Sans",Inter,system-ui,Arial,sans-serif;background:#f6f7fb}
    .container-xl{max-width:1200px;margin-inline:auto}
    /* 8 th√®mes (couleurs pilot√©es via variables CSS) */
    .theme-indigo{--c50:#eef2ff;--c100:#e0e7ff;--c200:#c7d2fe;--c600:#4f46e5;--c700:#4338ca;--c800:#3730a3}
    .theme-vin{--c50:#fff1f2;--c100:#ffe4e6;--c200:#fecdd3;--c600:#e11d48;--c700:#be123c;--c800:#9f1239}
    .theme-bleunuit{--c50:#eff6ff;--c100:#dbeafe;--c200:#bfdbfe;--c600:#2563eb;--c700:#1d4ed8;--c800:#1e40af}
    .theme-emerald{--c50:#ecfdf5;--c100:#d1fae5;--c200:#a7f3d0;--c600:#059669;--c700:#047857;--c800:#065f46}
    .theme-amber{--c50:#fffbeb;--c100:#fef3c7;--c200:#fde68a;--c600:#d97706;--c700:#b45309;--c800:#92400e}
    .theme-rose{--c50:#fff1f2;--c100:#ffe4e6;--c200:#fecdd3;--c600:#e11d48;--c700:#be123c;--c800:#9f1239}
    .theme-sky{--c50:#f0f9ff;--c100:#e0f2fe;--c200:#bae6fd;--c600:#0284c7;--c700:#0369a1;--c800:#075985}
    .theme-violet{--c50:#f5f3ff;--c100:#ede9fe;--c200:#ddd6fe;--c600:#7c3aed;--c700:#6d28d9;--c800:#5b21b6}

    .card{background:linear-gradient(145deg,var(--c50),#fff);border:1px solid var(--c100);border-radius:18px;box-shadow:0 16px 32px -16px rgba(2,6,23,.18),0 8px 16px -8px rgba(2,6,23,.12)}
    .toolbar{background:#fff;border:1px solid var(--c100);border-radius:14px;padding:.6rem .8rem}
    .btn{display:inline-flex;align-items:center;gap:.55rem;border-radius:12px;font-weight:800;padding:.7rem 1rem}
    .btn-solid{background:var(--c600);color:#fff}.btn-solid:hover{background:var(--c700)}
    .btn-outline{border:1px solid var(--c200);background:#fff}
    .btn-ghost{border:1px dashed var(--c200);background:#fff}
    .badge{display:inline-grid;place-items:center;width:1.9rem;height:1.9rem;border-radius:.55rem;background:var(--c100);color:var(--c800);font-weight:800;font-size:.75rem}
    .sidebar-item{border:1px solid transparent;border-radius:12px;padding:.6rem .7rem;display:flex;align-items:flex-start;gap:.6rem}
    .sidebar-item:hover{background:var(--c50);border-color:var(--c200)}
    .sidebar-item.active{background:var(--c100);border-color:var(--c200);box-shadow:inset 4px 0 0 0 var(--c600)}
    .content-section{display:none;opacity:0;transition:opacity .18s ease}
    .content-section.active{display:block;opacity:1}
    .dropdown{position:relative}
    .menu{position:absolute;left:0;right:0;z-index:30;background:#fff;border:1px solid var(--c100);border-radius:12px;box-shadow:0 14px 28px -12px rgba(2,6,23,.18);max-height:300px;overflow:auto;display:none}
    .menu.open{display:block}
    .menu button{display:block;width:100%;text-align:left;padding:.55rem .8rem}
    .menu button:hover{background:var(--c50)}
    .toast{position:fixed;right:14px;bottom:14px;background:#111827;color:#fff;padding:.65rem .95rem;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.15);z-index:200;transition:opacity .25s, transform .25s}
    .prose img{border-radius:12px;box-shadow:0 10px 24px rgba(2,6,23,.15);max-width:100%;height:auto}
    .timeline{display:grid;gap:.6rem}
    .timeline-item{display:grid;grid-template-columns:72px 1fr;gap:.6rem;align-items:start}
    .timeline-year{font-weight:800;background:var(--c100);color:var(--c800);border-radius:10px;padding:.3rem .55rem;text-align:center}
    @media (max-width: 640px){ .toolbar{padding:.5rem .7rem} .btn{padding:.65rem .9rem} .badge{width:1.75rem;height:1.75rem} .timeline-item{grid-template-columns:64px 1fr} }
  </style>
</head>

<body class="min-h-screen">
  <div id="toasts"></div>

  <div class="min-h-screen flex flex-col">
    <!-- HEADER -->
    <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-[var(--c100)]">
      <div class="container-xl px-3 sm:px-4">
        <div class="py-2 sm:py-3 flex flex-wrap items-center justify-between gap-2">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl grid place-items-center bg-[var(--c100)] text-[var(--c700)] shadow">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
            </div>
            <div>
              <h1 class="text-xl sm:text-2xl font-extrabold tracking-wide">√âtude Biblique</h1>
              <p class="text-[11px] sm:text-xs text-slate-600 -mt-0.5">28 points strictement conformes</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <select id="themeSelect" class="toolbar text-xs sm:text-sm">
              <option value="indigo" selected>Indigo</option>
              <option value="vin">Vin</option>
              <option value="bleunuit">Bleu nuit</option>
              <option value="emerald">√âmeraude</option>
              <option value="amber">Ambre</option>
              <option value="rose">Rose</option>
              <option value="sky">Ciel</option>
              <option value="violet">Violet</option>
            </select>
            <span class="toolbar text-xs" id="lastStudyPill">Derni√®re √©tude : ‚Äî</span>
            <button id="resumeBtn" class="btn btn-outline text-xs sm:text-sm">Reprendre</button>
            <button id="printBtn" class="btn btn-outline text-xs sm:text-sm">Imprimer / PDF</button>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 py-5 sm:py-6">
      <div class="container-xl px-3 sm:px-4">

        <!-- S√©lecteurs -->
        <section class="card p-4 sm:p-6 mb-6">
          <div class="grid grid-cols-12 gap-3 sm:gap-4 items-end">
            <!-- Recherche -->
            <div class="col-span-12">
              <label class="text-sm font-semibold block mb-1">Recherche</label>
              <div class="relative">
                <svg class="w-4 h-4 text-neutral-400 absolute left-3 top-3" viewBox="0 0 24 24" fill="currentColor"><path d="M10 18a8 8 0 1 1 5.293-14.293A8 8 0 0 1 10 18zm11 3-6-6"/></svg>
                <input id="searchInput" class="w-full border rounded-lg pl-9 pr-3 py-2.5" placeholder="Tape ‚Äòmar 5‚Äô, ‚Äòjean 3:16‚Äô, ‚Äò1co 13.4-7‚Äô‚Ä¶">
              </div>
              <p class="text-xs text-neutral-600 mt-1">Abr√©viations OK : mar, jn, 1co, rm‚Ä¶ accents facultatifs.</p>
            </div>

            <!-- Livre -->
            <div class="col-span-12 sm:col-span-6 lg:col-span-5">
              <label class="text-sm font-semibold block mb-1">Livre</label>
              <div class="dropdown">
                <button id="livreBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between">
                  <span id="livreLabel">S√©lectionner un livre</span>
                  <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
                </button>
                <div id="livreMenu" class="menu"></div>
              </div>
            </div>

            <!-- Chapitre -->
            <div class="col-span-6 sm:col-span-3 lg:col-span-3">
              <label class="text-sm font-semibold block mb-1">Chapitre</label>
              <div class="dropdown">
                <button id="chapBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between" disabled>
                  <span id="chapLabel">Chapitre</span>
                  <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
                </button>
                <div id="chapMenu" class="menu"></div>
              </div>
            </div>

            <!-- Version -->
            <div class="col-span-6 sm:col-span-3 lg:col-span-2">
              <label class="text-sm font-semibold block mb-1">Version</label>
              <select id="versionSelect" class="w-full bg-white border rounded-lg py-2.5 px-4">
                <option value="LSG" selected>LSG ‚Äî Louis Segond</option>
                <option value="SG21">SG21 ‚Äî Segond 21</option>
                <option value="NEG1979">NEG79 ‚Äî Nouvelle √âdition de Gen√®ve</option>
                <option value="BDS">BDS ‚Äî La Bible du Semeur</option>
                <option value="PDV">PDV ‚Äî Parole de Vie</option>
              </select>
            </div>

            <!-- Actions -->
            <div class="col-span-12 flex flex-wrap gap-2 mt-1">
              <button id="validerBtn" class="btn btn-solid shadow w-full sm:w-auto">Valide (28 pts)</button>
              <button id="reinitBtn" class="btn btn-outline w-full sm:w-auto">R√©initialiser</button>
              <button id="lireBtn" class="btn btn-outline w-full sm:w-auto" disabled>Lire (BibleGateway)</button>

              <div class="ml-auto flex gap-2 w-full sm:w-auto">
                <select id="pointsSelect" class="border rounded-lg px-3 py-2 w-full sm:w-auto">
                  <option value="28" selected>28 points</option>
                  <option value="12">12 points</option>
                  <option value="8">8 points (rapide)</option>
                </select>
                <button id="generateBtn" class="btn btn-solid shadow w-full sm:w-auto">G√©n√©rer IA</button>
              </div>
            </div>

            <!-- Derni√®re √©tude -->
            <div class="col-span-12">
              <div class="mt-3 text-sm text-slate-700">
                <span class="font-semibold">Derni√®re √©tude :</span>
                <span id="lastStudyInline">‚Äî</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Corps -->
        <div class="grid grid-cols-12 gap-4 lg:gap-6">
          <!-- NAV points -->
          <aside class="col-span-12 lg:col-span-4">
            <div class="card p-3 sticky top-[84px] max-h-[calc(100vh-140px)] overflow-y-auto">
              <h2 class="text-lg font-extrabold mb-2">Points d‚Äô√©tude</h2>
              <nav id="pointsNav" class="space-y-1"></nav>
            </div>
          </aside>

          <!-- CONTENU -->
          <section class="col-span-12 lg:col-span-8">
            <div class="card relative">
              <div id="busy" class="hidden absolute inset-0 bg-white/70 dark:bg-black/40 z-10 grid place-items-center">
                <div class="rounded-xl border bg-white dark:bg-neutral-900 px-4 py-3 shadow-md text-sm flex items-center gap-2">
                  <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                  <span id="busyText">G√©n√©ration‚Ä¶</span>
                </div>
              </div>
              <div id="contentArea" class="p-4 sm:p-6">
                <div id="welcome" class="text-center py-10">
                  <div class="w-16 h-16 rounded-xl bg-[var(--c50)] text-[var(--c700)] grid place-items-center mx-auto mb-3">
                    <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
                  </div>
                  <h3 class="text-lg font-bold mb-2">Bienvenue üëã</h3>
                  <p class="text-neutral-600">Je choisis un livre et un chapitre, puis je clique <b>Valide</b> pour obtenir 28 points riches, structur√©s et coh√©rents.</p>
                </div>
                <div id="sectionsHost"></div>
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button id="exportMdBtn" class="btn btn-ghost text-sm">Exporter (Markdown)</button>
              <button id="copyLinkBtn" class="btn btn-ghost text-sm">Copier le lien</button>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ==================== CONFIG ==================== */
    const API_URL_CHAT = new URL('./api/chat', location.href).toString();
    const TARGET_MIN = 2500;     // ~ caract√®res minimum par point
    const BATCH = 4;             // taille des lots
    const THEME_KEY='ui_theme8';

    /* ==================== TOUTES LES DONN√âES ==================== */
    const LIVRES_CHAP={"Gen√®se":50,"Exode":40,"L√©vitique":27,"Nombres":36,"Deut√©ronome":34,"Josu√©":24,"Juges":21,"Ruth":4,"1 Samuel":31,"2 Samuel":24,"1 Rois":22,"2 Rois":25,"1 Chroniques":29,"2 Chroniques":36,"Esdras":10,"N√©h√©mie":13,"Esther":10,"Job":42,"Psaumes":150,"Proverbes":31,"Eccl√©siaste":12,"Cantique":8,"√âsa√Øe":66,"J√©r√©mie":52,"Lamentations":5,"√âz√©chiel":48,"Daniel":12,"Os√©e":14,"Jo√´l":3,"Amos":9,"Abdias":1,"Jonas":4,"Mich√©e":7,"Nahum":3,"Habacuc":3,"Sophonie":3,"Agg√©e":2,"Zacharie":14,"Malachie":4,"Matthieu":28,"Marc":16,"Luc":24,"Jean":21,"Actes":28,"Romains":16,"1 Corinthiens":16,"2 Corinthiens":13,"Galates":6,"√âph√©siens":6,"Philippiens":4,"Colossiens":4,"1 Thessaloniciens":5,"2 Thessaloniciens":3,"1 Timoth√©e":6,"2 Timoth√©e":4,"Tite":3,"Phil√©mon":1,"H√©breux":13,"Jacques":5,"1 Pierre":5,"2 Pierre":3,"1 Jean":5,"2 Jean":1,"3 Jean":1,"Jude":1,"Apocalypse":22};

    const ALIAS={gen:'Gen√®se',gn:'Gen√®se',ex:'Exode',exo:'Exode',lev:'L√©vitique',lv:'L√©vitique',nb:'Nombres',nbr:'Nombres',deut:'Deut√©ronome',dt:'Deut√©ronome',jos:'Josu√©',jg:'Juges',ru:'Ruth','1sa':'1 Samuel','2sa':'2 Samuel','1r':'1 Rois','2r':'2 Rois','1ch':'1 Chroniques','2ch':'2 Chroniques',esd:'Esdras',neh:'N√©h√©mie',est:'Esther',ps:'Psaumes',prov:'Proverbes',eccl:'Eccl√©siaste',cant:'Cantique',es:'√âsa√Øe',jr:'J√©r√©mie',lam:'Lamentations',ez:'√âz√©chiel',dn:'Daniel',os:'Os√©e',jl:'Jo√´l',am:'Amos',abd:'Abdias',jon:'Jonas',mic:'Mich√©e',nah:'Nahum',hb:'Habacuc',so:'Sophonie',ag:'Agg√©e',za:'Zacharie',ml:'Malachie',mt:'Matthieu',mc:'Marc',lc:'Luc',jn:'Jean',ac:'Actes',rm:'Romains','1co':'1 Corinthiens','2co':'2 Corinthiens',ga:'Galates',eph:'√âph√©siens',php:'Philippiens',cl:'Colossiens','1th':'1 Thessaloniciens','2th':'2 Thessaloniciens','1ti':'1 Timoth√©e','2ti':'2 Timoth√©e',tt:'Tite',phm:'Phil√©mon',he:'H√©breux',ja:'Jacques','1p':'1 Pierre','2p':'2 Pierre','1j':'1 Jean','2j':'2 Jean','3j':'3 Jean',jud:'Jude',ap:'Apocalypse'};

    // Liste EXACTE demand√©e (sidebar + titres sections)
    const POINTS = [
      "Pri√®re d‚Äôouverture ‚Äî Invocation du Saint-Esprit pour √©clairer mon √©tude.",
      "Canon et testament ‚Äî Identifier le livre dans le canon (Ancien/Nouveau Testament).",
      "Questions du chapitre pr√©c√©dent ‚Äî Minimum 5 questions, avec r√©ponses int√©grales pour v√©rifier la compr√©hension.",
      "Titre du chapitre ‚Äî R√©sum√© doctrinal synth√©tique du passage.",
      "Contexte historique ‚Äî P√©riode, g√©opolitique, culture, avec carte visuelle localis√©e.",
      "Structure litt√©raire ‚Äî S√©quen√ßage narratif et composition interne du chapitre.",
      "Genre litt√©raire ‚Äî Type de texte (narratif, po√©tique, proph√©tique, etc.).",
      "Auteur et g√©n√©alogie ‚Äî Pr√©sentation de l‚Äôauteur et lien aux patriarches (avec arbre g√©n√©alogique).",
      "Verset-cl√© doctrinal ‚Äî Verset central du chapitre (cliquable vers BibleGateway).",
      "Analyse ex√©g√©tique ‚Äî Commentaire mot-√†-mot avec r√©f√©rences au grec/h√©breu.",
      "Analyse lexicale ‚Äî Analyse des mots-cl√©s originaux et sens doctrinal.",
      "R√©f√©rences crois√©es ‚Äî Passages parall√®les ou compl√©mentaires dans la Bible.",
      "Fondements th√©ologiques ‚Äî Doctrines majeures qui √©mergent du chapitre.",
      "Th√®me doctrinal ‚Äî Lien entre ce chapitre et les 22 grands th√®mes de la doctrine biblique.",
      "Fruits spirituels ‚Äî Vertus et attitudes inspir√©es par le chapitre.",
      "Types bibliques ‚Äî Symboles ou figures typologiques pr√©sents.",
      "Appui doctrinal ‚Äî Autres passages bibliques qui confirment l‚Äôenseignement.",
      "Comparaison entre versets ‚Äî Comparer des versets du chapitre pour mise en relief.",
      "Comparaison avec Actes 2 ‚Äî Parall√®le avec le d√©but de l‚Äô√âglise et l‚Äôaction du Saint-Esprit.",
      "Verset √† m√©moriser ‚Äî Verset essentiel √† retenir dans ma vie spirituelle.",
      "Enseignement pour l‚Äô√âglise ‚Äî Implications collectives et eccl√©siales.",
      "Enseignement pour la famille ‚Äî Valeurs √† transmettre dans le foyer chr√©tien.",
      "Enseignement pour enfants ‚Äî M√©thode simplifi√©e avec r√©cits, images, jeux.",
      "Application missionnaire ‚Äî Comment ce texte guide l‚Äô√©vang√©lisation.",
      "Application pastorale ‚Äî Conseils pour les pasteurs et enseignants.",
      "Application personnelle ‚Äî Examen de conscience et engagement individuel.",
      "Versets √† retenir ‚Äî Versets incontournables pour la pr√©dication.",
      "Pri√®re de fin ‚Äî Cl√¥ture spirituelle de l‚Äô√©tude avec reconnaissance."
    ];

    // Instructions STRICTES par point
    const INSTR = {
      1:  (b,c)=>`√âcris une pri√®re d‚Äôouverture (1 ≥·µâ personne : je/moi) li√©e √† **${b} ${c}**. Ton pastoral, r√©v√©rencieux, doctrinal, √©voquant l‚Äô≈ìuvre du Saint-Esprit. ‚â• ${TARGET_MIN} caract√®res.`,
      2:  (b,c)=>`Identifie pr√©cis√©ment la place de **${b}** dans le canon (AT/NT), p√©riode, r√¥le, public. Ajoute un petit tableau de m√©ta-donn√©es. ‚â• ${TARGET_MIN}.`,
      3:  (b,c)=>`Donne **exactement 5 questions** sur le **chapitre pr√©c√©dent** de ${b} ${c-1 || 1} avec **r√©ponses int√©grales et justifi√©es**. Liste num√©rot√©e. ‚â• ${TARGET_MIN}.`,
      4:  (b,c)=>`Propose un **titre doctrinal** synth√©tique pour ${b} ${c} puis un r√©sum√© structur√© (puces + paragraphe). ‚â• ${TARGET_MIN}.`,
      5:  (b,c)=>`Contexte historique de ${b} ${c} : √©poque, g√©opolitique, culture. Ajoute **une carte** (image Markdown !) et frise chronologique ('YYYY ‚Äî ...'). ‚â• ${TARGET_MIN}.`,
      6:  (b,c)=>`Structure litt√©raire interne de ${b} ${c} : plan en sections, transitions, inclusions. Donne un **sch√©ma** (tableau). ‚â• ${TARGET_MIN}.`,
      7:  (b,c)=>`Genre litt√©raire de ${b} ${c} (narratif, po√©tique, etc.) + implications herm√©neutiques. ‚â• ${TARGET_MIN}.`,
      8:  (b,c)=>`Auteur, date, destinataires. Ajoute **arbre g√©n√©alogique** (ASCII simple ou puces hi√©rarchiques) et liens patriarcaux. ‚â• ${TARGET_MIN}.`,
      9:  (b,c)=>`Choisis le **verset-cl√©** de ${b} ${c}. Affiche-le **en gras** + lien **BibleGateway**. Explique pourquoi il est doctrinalement central. ‚â• ${TARGET_MIN}.`,
      10: (b,c)=>`Analyse ex√©g√©tique de ${b} ${c} : progression par p√©ricope, remarques grec/h√©breu (translitt√©ration ok), notes syntaxiques. ‚â• ${TARGET_MIN}.`,
      11: (b,c)=>`Analyse lexicale : 5‚Äì8 **mots-cl√©s** de ${b} ${c} (forme, sens, usages parall√®les). Tableau comparatif inclus. ‚â• ${TARGET_MIN}.`,
      12: (b,c)=>`R√©f√©rences crois√©es : parall√®les OT/NT pertinents. Liste structur√©e avec versets **cliquables**. ‚â• ${TARGET_MIN}.`,
      13: (b,c)=>`Fondements th√©ologiques qui √©mergent de ${b} ${c} (Dieu, Christ, Esprit, salut, √âglise...). Arguments + versets cliquables. ‚â• ${TARGET_MIN}.`,
      14: (b,c)=>`Th√®me doctrinal : rattache ${b} ${c} aux **22 grands th√®mes** (cr√©er une mini-table). Justifie. ‚â• ${TARGET_MIN}.`,
      15: (b,c)=>`Fruits spirituels attendus (vertus). D√©cris **comment** les cultiver (plan pratique). ‚â• ${TARGET_MIN}.`,
      16: (b,c)=>`Types bibliques/figures : symboles christologiques, typologie, accomplissements. ‚â• ${TARGET_MIN}.`,
      17: (b,c)=>`Appui doctrinal : autres passages qui confirment ${b} ${c}. Montre la coh√©rence canonique. ‚â• ${TARGET_MIN}.`,
      18: (b,c)=>`Comparaison **entre versets** de ${b} ${c} : rapprochements, contrastes, structure. Tableau comparatif. ‚â• ${TARGET_MIN}.`,
      19: (b,c)=>`Comparaison avec **Actes 2** (Esprit, √âglise, mission). Parall√®les pr√©cis et applications. ‚â• ${TARGET_MIN}.`,
      20: (b,c)=>`Verset √† m√©moriser : affiche-le (gras, lien) + m√©thode de m√©morisation (r√©vision, pri√®re, chant). ‚â• ${TARGET_MIN}.`,
      21: (b,c)=>`Enseignement pour l‚Äô√âglise : gouvernance, liturgie, mission d‚Äôapr√®s ${b} ${c}. Plan d‚Äôactions. ‚â• ${TARGET_MIN}.`,
      22: (b,c)=>`Enseignement pour la **famille** : valeurs, rituels de Parole/pri√®re, transmission. ‚â• ${TARGET_MIN}.`,
      23: (b,c)=>`Enseignement pour **enfants** : raconter, images, jeu, activit√© cr√©ative. Inclure 1‚Äì2 images Markdown. ‚â• ${TARGET_MIN}.`,
      24: (b,c)=>`Application missionnaire : √©vang√©lisation, apolog√©tique, t√©moignage inspir√©s par ${b} ${c}. ‚â• ${TARGET_MIN}.`,
      25: (b,c)=>`Application **pastorale** : conseils clairs pour pasteurs/enseignants (pr√©dication, accompagnement). ‚â• ${TARGET_MIN}.`,
      26: (b,c)=>`Application **personnelle** : examen de conscience, engagements concrets (checklist). ‚â• ${TARGET_MIN}.`,
      27: (b,c)=>`Versets √† retenir pour la **pr√©dication** : anthologie comment√©e, tous cliquables. ‚â• ${TARGET_MIN}.`,
      28: (b,c)=>`√âcris une **pri√®re de fin** (1 ≥·µâ personne) li√©e √† **${b} ${c}**, louange + cons√©cration. ‚â• ${TARGET_MIN}.`
    };

    /* ==================== UI helpers ==================== */
    const $ = (s)=>document.querySelector(s);
    function toast(msg, kind='info', ms=3800){
      const z=document.getElementById("toasts"); const d=document.createElement('div');
      d.className='toast'; d.textContent=msg;
      d.style.background = kind==='err' ? '#ef4444' : (kind==='ok' ? '#10b981' : '#111827');
      z.appendChild(d); setTimeout(()=>{d.style.opacity='0';d.style.transform='translateY(4px)';}, ms-300);
      setTimeout(()=>d.remove(), ms);
    }
    function applyTheme(val){
      const r=document.documentElement;
      r.classList.remove('theme-indigo','theme-vin','theme-bleunuit','theme-emerald','theme-amber','theme-rose','theme-sky','theme-violet');
      r.classList.add('theme-'+(val||'indigo'));
      localStorage.setItem(THEME_KEY,val||'indigo');
    }

    /* ==================== S√©lecteurs ==================== */
    let currentLivre=null, currentChap=null;
    function openMenu(el, open){ el.classList.toggle('open', open ?? !el.classList.contains('open')); }
    function fillBooks(){
      const m = $('#livreMenu'); m.innerHTML = '';
      Object.keys(LIVRES_CHAP).forEach((name, idx)=>{
        const b = document.createElement('button');
        b.type='button'; b.textContent = `${idx+1}. ${name}`;
        b.addEventListener('click', ()=> selectBook(name, true));
        m.appendChild(b);
      });
    }
    function fillChapters(livre){
      const m = $('#chapMenu'); m.innerHTML = '';
      const max = LIVRES_CHAP[livre] || 1;
      for (let i=1;i<=max;i++){
        const b = document.createElement('button');
        b.type='button'; b.textContent = i;
        b.addEventListener('click', ()=> selectChapter(i, true));
        m.appendChild(b);
      }
    }
    function selectBook(livre, closeMenus){
      currentLivre = livre; $('#livreLabel').textContent = livre;
      $('#chapBtn').disabled = false; $('#chapLabel').textContent = 'Chapitre'; currentChap=null;
      fillChapters(livre); if (closeMenus) openMenu($('#livreMenu'), false);
      updateButtons(); updateHash(); refreshLastStudyUI(false);
    }
    function selectChapter(chap, closeMenus){
      currentChap = String(chap); $('#chapLabel').textContent = currentChap;
      if (closeMenus) openMenu($('#chapMenu'), false);
      updateButtons(); updateHash(); refreshLastStudyUI(false);
    }
    function updateButtons(){ $('#lireBtn').disabled = !(currentLivre && currentChap); }
    function updateHash(){ if (currentLivre && currentChap){ history.replaceState(null,'',`#/${encodeURIComponent(currentLivre)}/${currentChap}?point=1`); } }

    function strip(s){return (s||'').normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'');}
    function norm(s){return strip(s).toLowerCase().replace(/[^a-z0-9]/g,'');}
    function resolveBook(term){
      const k = norm(term);
      if (ALIAS[k]) return ALIAS[k];
      const first = Object.keys(ALIAS).find(a=>a.startsWith(k));
      if (first) return ALIAS[first];
      return Object.keys(LIVRES_CHAP).find(b=>norm(b).startsWith(k)) || null;
    }
    function parseRef(raw){
      const s=(raw||'').trim().replace(/\s+/g,' ');
      if(!s) return {book:null, chap:null};
      const m=s.match(/^(.+?)[\s,;]+(\d{1,3})/i);
      if(m) return {book:resolveBook(m[1]),chap:parseInt(m[2],10)};
      return {book:resolveBook(s)||null, chap:null};
    }

    /* ==================== NAV & Sections (vue unique) ==================== */
    function renderPoints(){
      const nav = $('#pointsNav'); const host = $('#sectionsHost');
      nav.innerHTML=''; host.innerHTML='';
      for(let i=1;i<=POINTS.length;i++){
        const btn=document.createElement('button');
        btn.className='sidebar-item w-full text-left'; btn.dataset.section='p'+i;
        btn.innerHTML=`<span class="badge">${i}</span><span class="font-semibold">${POINTS[i-1]}</span>`;
        btn.addEventListener('click',()=>{
          document.querySelectorAll('#pointsNav .sidebar-item').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
          btn.classList.add('active'); $('#'+btn.dataset.section)?.classList.add('active');
          $('#welcome')?.classList.add('hidden');
        });
        nav.appendChild(btn);

        const sec=document.createElement('div'); sec.id='p'+i; sec.className='content-section';
        sec.innerHTML=`<h3 class="text-xl font-extrabold mb-2">${POINTS[i-1]}</h3>
          <div class="rounded-xl border p-3">
            <div class="text-xs text-neutral-500 mb-2 flex justify-between">
              <span id="noteStatus-p${i}">En attente‚Ä¶</span>
              <span><span id="wordCount-p${i}">0</span> mots</span>
            </div>
            <div class="prose prose-sm max-w-none" id="view-p${i}"></div>
          </div>`;
        host.appendChild(sec);
      }
    }

    /* ==================== Rendu enrichi ==================== */
    function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
    function mdTables(block){
      return block.replace(/^(?:\s*\|.+\|\s*)+$/gms, tbl=>{
        const rows = tbl.trim().split('\n').map(r=>r.trim().replace(/^\||\|$/g,''));
        const trs = rows.map((r,idx)=>{
          const tds = r.split('|').map(c=>`<td class="border px-2 py-1 align-top">${escapeHtml(c.trim())}</td>`).join('');
          return `<tr class="${idx? '' : 'font-semibold bg-[var(--c50)]'}">${tds}</tr>`;
        }).join('');
        return `<div class="overflow-x-auto my-2"><table class="w-full text-sm border">${trs}</table></div>`;
      });
    }
    function mdLists(t){
      return t.replace(/^(?:\s*-\s.+\n?)+/gms, blk=>{
        const items = blk.trim().split('\n').map(l=>l.replace(/^\s*-\s?/,'').trim()).filter(Boolean);
        return `<ul class="list-disc pl-5">${items.map(i=>`<li>${i}</li>`).join('')}</ul>`;
      });
    }
    function mdImages(t){
      return t.replace(/!\[([^\]]*)\]\((https?:\/\/[^\s)]+)\)/g,(_m,alt,src)=>{
        return `<figure class="my-3"><img src="${src}" alt="${escapeHtml(alt)}" loading="lazy"><figcaption class="text-xs text-slate-500 mt-1">${escapeHtml(alt)}</figcaption></figure>`;
      });
    }
    function paragraphs(t){
      return t.split(/\n{2,}/).map(p=>`<p>${p}</p>`).join('');
    }
    function gatewayLink(book, chap, verses){
      const vMap={LSG:'LSG',BDS:'BDS',NEG1979:'NEG1979',SG21:'S21',PDV:'PDV-FR'};
      const code=vMap[$('#versionSelect').value]||'LSG';
      const ref = `${book} ${chap}${verses?(':'+verses):''}`;
      return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=${code}`;
    }
    function linkifyVerses(html){
      const bookRegex="(?:[1-3]\\s*)?(?:Gen√®se|Exode|L√©vitique|Nombres|Deut√©ronome|Josu√©|Juges|Ruth|1\\s*Samuel|2\\s*Samuel|1\\s*Rois|2\\s*Rois|1\\s*Chroniques|2\\s*Chroniques|Esdras|N√©h√©mie|Esther|Job|Psaumes|Proverbes|Eccl√©siaste|Cantique|√âsa√Øe|Esa√Øe|J√©r√©mie|Lamentations|√âz√©chiel|Ezechiel|Daniel|Os√©e|Jo√´l|Amos|Abdias|Jonas|Mich√©e|Nahum|Habacuc|Sophonie|Agg√©e|Zacharie|Malachie|Matthieu|Marc|Luc|Jean|Actes|Romains|1\\s*Corinthiens|2\\s*Corinthiens|Galates|√âph√©siens|Philippiens|Colossiens|1\\s*Thessaloniciens|2\\s*Thessaloniciens|1\\s*Timoth√©e|2\\s*Timoth√©e|Tite|Phil√©mon|H√©breux|Jacques|1\\s*Pierre|2\\s*Pierre|1\\s*Jean|2\\s*Jean|3\\s*Jean|Jude|Apocalypse)";
      const rx=new RegExp(`\\b(${bookRegex})\\s+(\\d{1,3})(?:[.:](\\d{1,3}(?:[-‚Äì]\\d{1,3})?))?\\b`,'gi');
      return html.replace(rx,(m,bk,ch,vv)=>{
        const resolved = resolveBook(bk) || bk;
        return `<a class="underline decoration-[var(--c600)] hover:text-[var(--c700)]" target="_blank" rel="noopener" href="${gatewayLink(resolved,ch,vv||'')}">${m}</a>`;
      });
    }
    function mdBold(t){ return t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>'); }
    function mdToHtml(md){
      if(!md) return '';
      let t = md.replace(/\r/g,'').trim();
      t = mdImages(t);
      t = mdTables(t);
      t = mdLists(t);
      t = mdBold(t);
      t = paragraphs(t);
      t = linkifyVerses(t);
      return t;
    }
    function renderRich(i, raw){
      const view = $('#view-p'+i);
      if(!view) return;
      const html = mdToHtml(raw||'');
      const wc   = (raw||'').trim().split(/\s+/).filter(Boolean).length;
      $('#wordCount-p'+i).textContent = wc;
      $('#noteStatus-p'+i).textContent = raw && raw.length ? 'G√©n√©r√© ‚úì' : '‚Äî';
      view.innerHTML = html;
    }

    /* ==================== Normalisation & anti-doublon ==================== */
    const BANAL_RX=/(^|\n)\s*voici\s+\d+\s+points.*$/i;
    function cleanPoint(text){ if(!text) return ''; return String(text).replace(BANAL_RX,'').trim(); }
    function normalizeToP(obj){
      const out={}; for(let i=1;i<=28;i++){ const k='p'+i; const v=(obj&&obj[k])?cleanPoint(obj[k]):''; if(v) out[k]=v; }
      return out;
    }
    function dedupe(obj){
      const seen=new Set();
      for(let i=1;i<=28;i++){
        const k='p'+i; const v=obj[k]||'';
        const n=v.replace(/\s+/g,' ').toLowerCase();
        if(seen.has(n)) obj[k]='(√Ä d√©velopper : √©viter la redite. Traiter un angle distinct pour ce point.)';
        else seen.add(n);
      }
      return obj;
    }

    /* ==================== API ==================== */
    async function callAPI(payload){
      const strongHint =
        "R√©ponds STRICTEMENT en JSON avec uniquement les cl√©s demand√©es (p1..p28 ou un sous-ensemble). "
        + "Chaque point doit respecter exactement l‚Äôintitul√© fourni et viser au moins " + TARGET_MIN + " caract√®res. "
        + "Interdis toute phrase g√©n√©rique (¬´ Voici X points‚Ä¶ ¬ª). "
        + "Autorise Markdown : **gras**, listes, tableaux |a|b|, images ![alt](url), frises 'YYYY ‚Äî ...'. "
        + "Rends les r√©f√©rences bibliques en clair (ex: Jean 3:16) ‚Äî la mise en lien sera faite c√¥t√© client.";
      const res = await fetch(API_URL_CHAT,{
        method:'POST',
        headers:{'content-type':'application/json'},
        body:JSON.stringify({...payload, hint: strongHint})
      });
      const txt=await res.text(); let data; try{ data=JSON.parse(txt); }catch{ data={content:txt}; }
      if(!res.ok){ toast('API : '+(data?.error||data?.message||('HTTP '+res.status)),'err',7000); return null; }
      return data;
    }

    function chunks(arr,size){const out=[];for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));return out;}

    async function generateBatches(indices){
      const busy=$('#busy'), busyText=$('#busyText');
      busyText.textContent='G√©n√©ration par lots‚Ä¶'; busy.classList.remove('hidden');
      try{
        for(const grp of chunks(indices,BATCH)){
          // instructions sp√©cifiques au sous-ensemble
          const schema = grp.map(n=>'p'+n);
          const perPoint = {};
          grp.forEach(n=> perPoint['p'+n] = INSTR[n](currentLivre, parseInt(currentChap,10)));
          const payload = {
            livre: currentLivre,
            chapitre: parseInt(currentChap,10),
            schema,               // force la forme des cl√©s attendues
            per_point: perPoint   // pour contraindre chaque rubrique
          };
          const data = await callAPI(payload);
          if(!data) continue;
          const obj = dedupe(normalizeToP(data));
          for(const n of grp){
            const v = obj['p'+n] || '';
            renderRich(n, v);
          }
        }
        // Focus automatique sur le premier
        document.querySelector('#pointsNav .sidebar-item')?.click();
        toast('√âtude g√©n√©r√©e.','ok');
      } finally { busy.classList.add('hidden'); }
    }

    async function generate(force28=false){
      if(!(currentLivre&&currentChap)){ toast('S√©lectionne un livre et un chapitre.','err'); return; }
      if(force28){ $('#pointsSelect').value='28'; }
      const total=parseInt($('#pointsSelect').value,10)||28;
      const all=[...Array(28)].map((_,i)=>i+1);
      const indices = (total===28) ? all : all.slice(0,total);
      await generateBatches(indices);
    }

    /* ==================== Derni√®re √©tude ==================== */
    function setLastStudy(livre, chap){ localStorage.setItem('derniere_etude', JSON.stringify({livre, chapitre:String(chap)})); refreshLastStudyUI(true); }
    function getLastStudy(){ try{ return JSON.parse(localStorage.getItem('derniere_etude')||'null'); }catch{ return null; } }
    function refreshLastStudyUI(){
      const last = getLastStudy(); const label = last ? `${last.livre} ${last.chapitre}` : '‚Äî';
      $('#lastStudyPill').textContent = `Derni√®re √©tude : ${label}`; $('#lastStudyInline').textContent = label;
    }

    /* ==================== INIT ==================== */
    document.addEventListener('DOMContentLoaded', ()=>{
      applyTheme(localStorage.getItem(THEME_KEY)||'indigo');
      $('#themeSelect').value = localStorage.getItem(THEME_KEY)||'indigo';
      $('#themeSelect').addEventListener('change',e=>applyTheme(e.target.value));

      fillBooks();
      $('#livreBtn').addEventListener('click',()=>openMenu($('#livreMenu')));
      $('#chapBtn').addEventListener('click',()=>openMenu($('#chapMenu')));

      // Recherche
      let si=null;
      $('#searchInput').addEventListener('input',()=>{ clearTimeout(si); si=setTimeout(()=>{ const r=parseRef($('#searchInput').value); if(!r.book) return; selectBook(r.book,false); if(r.chap) selectChapter(r.chap,false); },140); });
      $('#searchInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const r=parseRef($('#searchInput').value); if(!r.book){ toast('Ex : ¬´ mar 5 ¬ª, ¬´ jean 3:16 ¬ª.','err'); return; } selectBook(r.book,false); selectChapter(r.chap||1,false); } });

      // Valide ‚Üí sauvegarde + 28 points
      $('#validerBtn').addEventListener('click', async ()=>{
        if(!(currentLivre&&currentChap)){ toast('S√©lectionne un livre et un chapitre.','err'); return; }
        setLastStudy(currentLivre, currentChap); await generate(true);
      });

      // Reprendre
      $('#resumeBtn').addEventListener('click', ()=>{
        const last = getLastStudy(); if(!last){ toast('Aucune √©tude enregistr√©e.','err'); return; }
        selectBook(last.livre,false); selectChapter(parseInt(last.chapitre,10),false); toast(`Repris : ${last.livre} ${last.chapitre}`,'ok');
      });

      // R√©init / Lire / G√©n√©rer
      $('#reinitBtn').addEventListener('click',()=>{ currentLivre=null; currentChap=null; $('#livreLabel').textContent='S√©lectionner un livre'; $('#chapLabel').textContent='Chapitre'; $('#chapBtn').disabled=true; $('#lireBtn').disabled=true; $('#searchInput').value=''; history.replaceState(null,'','#'); toast('R√©initialis√©.','info'); refreshLastStudyUI(); });
      $('#lireBtn').addEventListener('click',()=>{ if(!(currentLivre&&currentChap)) return; const vMap={LSG:'LSG',BDS:'BDS',NEG1979:'NEG1979',SG21:'S21',PDV:'PDV-FR'}; const code=vMap[$('#versionSelect').value]||'LSG'; const ref=currentLivre+' '+currentChap; window.open('https://www.biblegateway.com/passage/?search='+encodeURIComponent(ref)+'&version='+code,'_blank','noopener'); });
      $('#generateBtn').addEventListener('click', ()=>generate(false));
      $('#printBtn').addEventListener('click',()=>window.print());

      // Export & lien
      $('#exportMdBtn').addEventListener('click',()=>{
        if(!(currentLivre&&currentChap)){ toast('S√©lectionne un passage.','err'); return; }
        let out=`# ${currentLivre} ${currentChap}\n\n_G√©n√©r√© : ${new Date().toLocaleString()}_\n\n`;
        for(let i=1;i<=28;i++){
          const raw = document.getElementById('view-p'+i)?.innerText || '';
          out+=`## ${i}. ${POINTS[i-1]}\n\n${raw||'_(vide)_'}\n\n`;
        }
        const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([out],{type:'text/markdown;charset=utf-8'})); a.download=`Etude_${currentLivre.replace(/\s+/g,'_')}_${currentChap}.md`; document.body.appendChild(a); a.click(); a.remove();
      });
      $('#copyLinkBtn').addEventListener('click',async()=>{
        const url=new URL(location.href); url.hash=(currentLivre&&currentChap)?`#/${encodeURIComponent(currentLivre)}/${currentChap}?point=1`:'#';
        try{ await navigator.clipboard.writeText(url.toString()); toast('Lien copi√©.','ok'); }catch{ toast('Copie impossible.','err'); }
      });

      renderPoints();
      document.querySelector('#pointsNav .sidebar-item')?.click();

      // Hash initial
      if(location.hash){
        const m=location.hash.match(/^#\/([^\/]+)\/(\d+)/);
        if(m){ selectBook(decodeURIComponent(m[1]),false); selectChapter(parseInt(m[2],10),false); }
      }
      refreshLastStudyUI();
    });
  </script>
</body>
</html>
