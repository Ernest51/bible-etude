<!DOCTYPE html>
<html lang="fr" class="h-full theme-indigo">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Étude Biblique — 28 points (strict)</title>

  <!-- IMPORTANT : CSS compilé localement -->
  <link rel="stylesheet" href="/dist/output.css" />

  <style>
    /* petits compléments hors Tailwind */
    :root{color-scheme:light dark}
    .container-xl{max-width:1200px;margin-inline:auto}
    .card{border-radius:16px}
    .badge{display:inline-grid;place-items:center;width:1.9rem;height:1.9rem;border-radius:.55rem}
    .toast{position:fixed;right:14px;bottom:14px;background:#111827;color:#fff;padding:.65rem .95rem;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.15);z-index:200;transition:opacity .25s, transform .25s}
    .sidebar-item{border:1px solid transparent;border-radius:12px;padding:.6rem .7rem;display:flex;align-items:flex-start;gap:.6rem}
    .sidebar-item:hover{background:rgb(239 246 255)}
    .sidebar-item.active{background:rgb(219 234 254);box-shadow:inset 4px 0 0 0 rgb(99 102 241)}
    .prose img{border-radius:12px;box-shadow:0 10px 24px rgba(2,6,23,.15);max-width:100%;height:auto}
    .timeline{display:grid;gap:.6rem}
    .timeline-item{display:grid;grid-template-columns:72px 1fr;gap:.6rem;align-items:start}
    .timeline-year{font-weight:800;background:rgb(219 234 254);color:rgb(30 58 138);border-radius:10px;padding:.3rem .55rem;text-align:center}
    .menu{position:absolute;left:0;right:0;z-index:40;background:#fff;border:1px solid rgb(226 232 240);border-radius:12px;box-shadow:0 14px 28px -12px rgba(2,6,23,.18);max-height:300px;overflow:auto;display:none}
    .menu.open{display:block}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div id="toasts"></div>

  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="container-xl px-3 sm:px-4">
      <div class="py-2 sm:py-3 flex flex-wrap items-center justify-between gap-2">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl grid place-items-center bg-indigo-100 text-indigo-700 shadow">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
          </div>
          <div>
            <h1 class="text-xl sm:text-2xl font-extrabold tracking-wide">Étude Biblique — 28 points</h1>
            <p class="text-[11px] sm:text-xs text-slate-600 -mt-0.5">Modèle strict, riche et doctrinal</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span class="px-3 py-1.5 rounded-lg border text-xs" id="lastStudyPill">Dernière étude : —</span>
          <button id="resumeBtn" class="px-3 py-1.5 rounded-lg border text-xs">Reprendre</button>
          <button id="printBtn" class="px-3 py-1.5 rounded-lg border text-xs">Imprimer / PDF</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 py-5 sm:py-6">
    <div class="container-xl px-3 sm:px-4">
      <!-- Sélecteurs -->
      <section class="card bg-white border border-slate-200 p-4 sm:p-6 mb-6">
        <div class="grid grid-cols-12 gap-3 sm:gap-4 items-end">
          <!-- Recherche -->
          <div class="col-span-12">
            <label class="text-sm font-semibold block mb-1">Recherche</label>
            <div class="relative">
              <svg class="w-4 h-4 text-neutral-400 absolute left-3 top-3" viewBox="0 0 24 24" fill="currentColor"><path d="M10 18a8 8 0 1 1 5.293-14.293A8 8 0 0 1 10 18zm11 3-6-6"/></svg>
              <input id="searchInput" class="w-full border rounded-lg pl-9 pr-3 py-2.5" placeholder="Tape ‘mar 5’, ‘jean 3:16’, ‘1co 13.4-7’…">
            </div>
            <p class="text-xs text-neutral-600 mt-1">Abréviations OK : mar, jn, 1co, rm… accents facultatifs.</p>
          </div>

          <!-- Livre -->
          <div class="col-span-12 sm:col-span-6 lg:col-span-5">
            <label class="text-sm font-semibold block mb-1">Livre</label>
            <div class="relative">
              <button id="livreBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between">
                <span id="livreLabel">Sélectionner un livre</span>
                <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
              </button>
              <div id="livreMenu" class="menu"></div>
            </div>
          </div>

          <!-- Chapitre -->
          <div class="col-span-6 sm:col-span-3 lg:col-span-3">
            <label class="text-sm font-semibold block mb-1">Chapitre</label>
            <div class="relative">
              <button id="chapBtn" type="button" class="w-full bg-white border rounded-lg py-2.5 px-4 flex items-center justify-between" disabled>
                <span id="chapLabel">Chapitre</span>
                <svg class="w-3.5 h-3.5 text-neutral-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 7l5 5 5-5"/></svg>
              </button>
              <div id="chapMenu" class="menu"></div>
            </div>
          </div>

          <!-- Version -->
          <div class="col-span-6 sm:col-span-3 lg:col-span-2">
            <label class="text-sm font-semibold block mb-1">Version</label>
            <select id="versionSelect" class="w-full bg-white border rounded-lg py-2.5 px-4">
              <option value="LSG" selected>LSG — Louis Segond</option>
              <option value="SG21">SG21 — Segond 21</option>
              <option value="NEG1979">NEG79 — Nouvelle Édition de Genève</option>
              <option value="BDS">BDS — La Bible du Semeur</option>
              <option value="PDV">PDV — Parole de Vie</option>
            </select>
          </div>

          <!-- Actions -->
          <div class="col-span-12 flex flex-wrap gap-2 mt-1">
            <button id="validerBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 py-2 rounded-lg shadow w-full sm:w-auto">
              Valide (28 pts)
            </button>
            <button id="reinitBtn" class="px-4 py-2 rounded-lg border w-full sm:w-auto">Réinitialiser</button>
            <button id="lireBtn" class="px-4 py-2 rounded-lg border w-full sm:w-auto" disabled>Lire (BibleGateway)</button>

            <div class="ml-auto flex gap-2 w-full sm:w-auto">
              <select id="pointsSelect" class="border rounded-lg px-3 py-2 w-full sm:w-auto">
                <option value="28" selected>28 points</option>
                <option value="12">12 points (partiel)</option>
                <option value="8">8 points (rapide)</option>
              </select>
              <button id="generateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-4 py-2 rounded-lg shadow w-full sm:w-auto">
                Générer IA
              </button>
            </div>
          </div>

          <!-- Dernière étude -->
          <div class="col-span-12">
            <div class="mt-3 text-sm text-slate-700">
              <span class="font-semibold">Dernière étude :</span>
              <span id="lastStudyInline">—</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Corps -->
      <div class="grid grid-cols-12 gap-4 lg:gap-6">
        <!-- NAV -->
        <aside class="col-span-12 lg:col-span-4">
          <div class="card bg-white border border-slate-200 p-3 sticky top-[84px] max-h-[calc(100vh-140px)] overflow-y-auto">
            <h2 class="text-lg font-extrabold mb-2">Points d’étude</h2>
            <nav id="pointsNav" class="space-y-1"></nav>
          </div>
        </aside>

        <!-- CONTENU -->
        <section class="col-span-12 lg:col-span-8">
          <div class="card bg-white border border-slate-200 relative">
            <div id="busy" class="hidden absolute inset-0 bg-white/70 z-10 grid place-items-center">
              <div class="rounded-xl border bg-white px-4 py-3 shadow text-sm flex items-center gap-2">
                <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
                <span id="busyText">Génération…</span>
              </div>
            </div>
            <div id="contentArea" class="p-4 sm:p-6">
              <div id="welcome" class="text-center py-10">
                <div class="w-16 h-16 rounded-xl bg-indigo-50 text-indigo-700 grid place-items-center mx-auto mb-3">
                  <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor"><path d="M5 4h9a4 4 0 0 1 4 4v10H7a2 2 0 0 1-2-2V4z"/><path d="M7 18h11v2H7z"/></svg>
                </div>
                <h3 class="text-lg font-bold mb-2">Bienvenue 👋</h3>
                <p class="text-neutral-600">Je choisis un livre et un chapitre, puis je clique <b>Valide</b> pour obtenir 28 points riches, strictement conformes au modèle.</p>
              </div>
              <div id="sectionsHost"></div>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button id="exportMdBtn" class="px-3 py-1.5 rounded-lg border text-sm">Exporter (Markdown)</button>
            <button id="copyLinkBtn" class="px-3 py-1.5 rounded-lg border text-sm">Copier le lien</button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    /* ====== Constantes ====== */
    const MIN_CHARS = 2500;               // objectif par rubrique
    const BATCH_SIZE = 3;                 // lots courts → meilleure densité
    const API_URL_CHAT = new URL('./api/chat', location.href).toString();
    const LAST_KEY = 'derniere_etude_v2';

    const LIVRES_CHAP={"Genèse":50,"Exode":40,"Lévitique":27,"Nombres":36,"Deutéronome":34,"Josué":24,"Juges":21,"Ruth":4,"1 Samuel":31,"2 Samuel":24,"1 Rois":22,"2 Rois":25,"1 Chroniques":29,"2 Chroniques":36,"Esdras":10,"Néhémie":13,"Esther":10,"Job":42,"Psaumes":150,"Proverbes":31,"Ecclésiaste":12,"Cantique":8,"Ésaïe":66,"Jérémie":52,"Lamentations":5,"Ézéchiel":48,"Daniel":12,"Osée":14,"Joël":3,"Amos":9,"Abdias":1,"Jonas":4,"Michée":7,"Nahum":3,"Habacuc":3,"Sophonie":3,"Aggée":2,"Zacharie":14,"Malachie":4,"Matthieu":28,"Marc":16,"Luc":24,"Jean":21,"Actes":28,"Romains":16,"1 Corinthiens":16,"2 Corinthiens":13,"Galates":6,"Éphésiens":6,"Philippiens":4,"Colossiens":4,"1 Thessaloniciens":5,"2 Thessaloniciens":3,"1 Timothée":6,"2 Timothée":4,"Tite":3,"Philémon":1,"Hébreux":13,"Jacques":5,"1 Pierre":5,"2 Pierre":3,"1 Jean":5,"2 Jean":1,"3 Jean":1,"Jude":1,"Apocalypse":22};

    const ALIAS={gen:'Genèse',gn:'Genèse',ex:'Exode',exo:'Exode',lev:'Lévitique',lv:'Lévitique',nb:'Nombres',nbr:'Nombres',deut:'Deutéronome',dt:'Deutéronome',jos:'Josué',jg:'Juges',ru:'Ruth','1sa':'1 Samuel','2sa':'2 Samuel','1r':'1 Rois','2r':'2 Rois','1ch':'1 Chroniques','2ch':'2 Chroniques',esd:'Esdras',neh:'Néhémie',est:'Esther',ps:'Psaumes',prov:'Proverbes',eccl:'Ecclésiaste',cant:'Cantique',es:'Ésaïe',jr:'Jérémie',lam:'Lamentations',ez:'Ézéchiel',dn:'Daniel',os:'Osée',jl:'Joël',am:'Amos',abd:'Abdias',jon:'Jonas',mic:'Michée',nah:'Nahum',hb:'Habacuc',so:'Sophonie',ag:'Aggée',za:'Zacharie',ml:'Malachie',mt:'Matthieu',mc:'Marc',lc:'Luc',jn:'Jean',ac:'Actes',rm:'Romains','1co':'1 Corinthiens','2co':'2 Corinthiens',ga:'Galates',eph:'Éphésiens',php:'Philippiens',cl:'Colossiens','1th':'1 Thessaloniciens','2th':'2 Thessaloniciens','1ti':'1 Timothée','2ti':'2 Timothée',tt:'Tite',phm:'Philémon',he:'Hébreux',ja:'Jacques','1p':'1 Pierre','2p':'2 Pierre','1j':'1 Jean','2j':'2 Jean','3j':'3 Jean',jud:'Jude',ap:'Apocalypse'};

    const POINTS=[
      "Prière d’ouverture — Invocation du Saint-Esprit pour éclairer mon étude.",
      "Canon et testament — Identifier le livre dans le canon (Ancien/Nouveau Testament).",
      "Questions du chapitre précédent — Minimum 5 questions, avec réponses intégrales pour vérifier la compréhension.",
      "Titre du chapitre — Résumé doctrinal synthétique du passage.",
      "Contexte historique — Période, géopolitique, culture, avec carte visuelle localisée.",
      "Structure littéraire — Séquençage narratif et composition interne du chapitre.",
      "Genre littéraire — Type de texte (narratif, poétique, prophétique, etc.).",
      "Auteur et généalogie — Présentation de l’auteur et lien aux patriarches (avec arbre généalogique).",
      "Verset-clé doctrinal — Verset central du chapitre (cliquable vers BibleGateway).",
      "Analyse exégétique — Commentaire mot-à-mot avec références au grec/hébreu.",
      "Analyse lexicale — Analyse des mots-clés originaux et sens doctrinal.",
      "Références croisées — Passages parallèles ou complémentaires dans la Bible.",
      "Fondements théologiques — Doctrines majeures qui émergent du chapitre.",
      "Thème doctrinal — Lien avec les grands thèmes de la doctrine biblique.",
      "Fruits spirituels — Vertus et attitudes inspirées par le chapitre.",
      "Types bibliques — Symboles ou figures typologiques présents.",
      "Appui doctrinal — Autres passages qui confirment l’enseignement.",
      "Comparaison entre versets — Mise en relief interne au chapitre.",
      "Comparaison avec Actes 2 — Parallèle avec l’œuvre du Saint-Esprit.",
      "Verset à mémoriser — Verset essentiel + piste de mémorisation.",
      "Enseignement pour l’Église — Implications collectives et ecclésiales.",
      "Enseignement pour la famille — Valeurs à transmettre dans le foyer.",
      "Enseignement pour enfants — Méthode simplifiée (récits, images, jeux).",
      "Application missionnaire — Orientations pour l’évangélisation.",
      "Application pastorale — Conseils pour pasteurs et enseignants.",
      "Application personnelle — Examen de conscience et engagements.",
      "Versets à retenir — Sélection pour prédication.",
      "Prière de fin — Clôture spirituelle, liée au passage."
    ];

    /* ====== Util ====== */
    const $ = s => document.querySelector(s);
    function toast(msg,kind='info',ms=3800){
      const z=$("#toasts"); const d=document.createElement('div');
      d.className='toast'; d.textContent=msg;
      d.style.background = kind==='err' ? '#ef4444' : (kind==='ok' ? '#10b981' : '#111827');
      z.appendChild(d); setTimeout(()=>{d.style.opacity='0';d.style.transform='translateY(4px)';}, ms-300);
      setTimeout(()=>d.remove(), ms);
    }
    function strip(s){return (s||'').normalize('NFD').replace(/[̀-ͯ]/g,'');}
    function norm(s){return strip(s).toLowerCase().replace(/[^a-z0-9]/g,'');}
    function resolveBook(term){
      const k = norm(term);
      if (ALIAS[k]) return ALIAS[k];
      const first = Object.keys(ALIAS).find(a=>a.startsWith(k));
      if (first) return ALIAS[first];
      return Object.keys(LIVRES_CHAP).find(b=>norm(b).startsWith(k)) || null;
    }
    function parseRef(raw){
      const s=(raw||'').trim().replace(/\s+/g,' ');
      if(!s) return {book:null, chap:null};
      const m=s.match(/^(.+?)[\s,;]+(\d{1,3})/i);
      if(m) return {book:resolveBook(m[1]),chap:parseInt(m[2],10)};
      return {book:resolveBook(s)||null, chap:null};
    }
    function gatewayLink(book, chap, verses){
      const vMap={LSG:'LSG',BDS:'BDS',NEG1979:'NEG1979',SG21:'S21',PDV:'PDV-FR'};
      const code=vMap[$('#versionSelect').value]||'LSG';
      const ref=`${book} ${chap}${verses?(':'+verses):''}`;
      return `https://www.biblegateway.com/passage/?search=${encodeURIComponent(ref)}&version=${code}`;
    }
    function linkify(html){
      const bookRegex="(?:[1-3]\\s*)?(?:Genèse|Exode|Lévitique|Nombres|Deutéronome|Josué|Juges|Ruth|1\\s*Samuel|2\\s*Samuel|1\\s*Rois|2\\s*Rois|1\\s*Chroniques|2\\s*Chroniques|Esdras|Néhémie|Esther|Job|Psaumes|Proverbes|Ecclésiaste|Cantique|Ésaïe|Esaïe|Jérémie|Lamentations|Ézéchiel|Ezechiel|Daniel|Osée|Joël|Amos|Abdias|Jonas|Michée|Nahum|Habacuc|Sophonie|Aggée|Zacharie|Malachie|Matthieu|Marc|Luc|Jean|Actes|Romains|1\\s*Corinthiens|2\\s*Corinthiens|Galates|Éphésiens|Philippiens|Colossiens|1\\s*Thessaloniciens|2\\s*Thessaloniciens|1\\s*Timothée|2\\s*Timothée|Tite|Philémon|Hébreux|Jacques|1\\s*Pierre|2\\s*Pierre|1\\s*Jean|2\\s*Jean|3\\s*Jean|Jude|Apocalypse)";
      const rx=new RegExp(`\\b(${bookRegex})\\s+(\\d{1,3})(?:[.:](\\d{1,3}(?:[-–]\\d{1,3})?))?\\b`,'gi');
      return html.replace(rx,(m,bk,ch,vv)=>{
        const resolved = resolveBook(bk) || bk;
        return `<a class="underline decoration-indigo-600 hover:text-indigo-700" target="_blank" rel="noopener" href="${gatewayLink(resolved,ch,vv||'')}">${m}</a>`;
      });
    }
    function mdToHtml(md){
      if(!md) return '';
      let t = String(md).replace(/\r/g,'').trim();
      // images
      t = t.replace(/!\[([^\]]*)\]\((https?:\/\/[^\s)]+)\)/g,(_m,alt,src)=>`<figure class="my-3"><img src="${src}" alt="${alt}" loading="lazy"><figcaption class="text-xs text-slate-500 mt-1">${alt}</figcaption></figure>`);
      // tableaux
      t = t.replace(/^(?:\s*\|.+\|\s*)+$/gms, tbl=>{
        const rows = tbl.trim().split('\n').map(r=>r.trim().replace(/^\||\|$/g,''));
        const trs = rows.map((r,idx)=>{
          const tds = r.split('|').map(c=>`<td class="border px-2 py-1 align-top">${c.trim()}</td>`).join('');
          return `<tr class="${idx? '' : 'font-semibold bg-indigo-50'}">${tds}</tr>`;
        }).join('');
        return `<div class="overflow-x-auto my-2"><table class="w-full text-sm border">${trs}</table></div>`;
      });
      // listes
      t = t.replace(/^(?:\s*-\s.+\n?)+/gms, blk=>{
        const items = blk.trim().split('\n').map(l=>l.replace(/^\s*-\s?/,'').trim()).filter(Boolean);
        return `<ul class="list-disc pl-5">${items.map(i=>`<li>${i}</li>`).join('')}</ul>`;
      });
      // gras
      t = t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
      // frises
      t = t.replace(/^(?:\s*\d{3,4}\s*[–-]\s+.+\n?){2,}$/gms, blk=>{
        const items = blk.trim().split('\n').map(l=>{
          const m=l.match(/^\s*(\d{3,4})\s*[–-]\s+(.+)$/); if(!m) return null;
          return `<div class="timeline-item"><div class="timeline-year">${m[1]}</div><div>${m[2]}</div></div>`;
        }).filter(Boolean).join('');
        return `<div class="timeline my-3">${items}</div>`;
      });
      // paragraphes + liens
      t = t.split(/\n{2,}/).map(p=>`<p>${p}</p>`).join('');
      return linkify(t);
    }

    /* ====== Sélection ====== */
    let currentLivre=null, currentChap=null;
    function fillBooks(){
      const m = $('#livreMenu'); m.innerHTML = '';
      Object.keys(LIVRES_CHAP).forEach((name, idx)=>{
        const b = document.createElement('button');
        b.type='button'; b.className='w-full text-left px-3 py-2 hover:bg-indigo-50';
        b.textContent = `${idx+1}. ${name}`;
        b.addEventListener('click', ()=> selectBook(name, true));
        m.appendChild(b);
      });
    }
    function fillChapters(livre){
      const m = $('#chapMenu'); m.innerHTML = '';
      const max = LIVRES_CHAP[livre] || 1;
      for (let i=1;i<=max;i++){
        const b = document.createElement('button');
        b.type='button'; b.className='w-full text-left px-3 py-2 hover:bg-indigo-50';
        b.textContent = i;
        b.addEventListener('click', ()=> selectChapter(i, true));
        m.appendChild(b);
      }
    }
    function openMenu(el, open){ el.classList.toggle('open', open ?? !el.classList.contains('open')); }
    function updateButtons(){ $('#lireBtn').disabled = !(currentLivre && currentChap); }
    function updateHash(){ if(currentLivre&&currentChap){ history.replaceState(null,'',`#/${encodeURIComponent(currentLivre)}/${currentChap}?point=1`); } }
    function selectBook(livre, close){
      currentLivre=livre; $('#livreLabel').textContent=livre;
      $('#chapBtn').disabled=false; $('#chapLabel').textContent='Chapitre'; currentChap=null;
      fillChapters(livre); if(close) openMenu($('#livreMenu'), false); updateButtons(); updateHash(); refreshLastUI(false);
    }
    function selectChapter(ch, close){
      currentChap=String(ch); $('#chapLabel').textContent=currentChap;
      if(close) openMenu($('#chapMenu'), false); updateButtons(); updateHash(); refreshLastUI(false);
    }

    /* ====== Rendu des 28 sections (affichage SANS doublon) ====== */
    function renderPoints(){
      const nav=$('#pointsNav'), host=$('#sectionsHost');
      nav.innerHTML=''; host.innerHTML='';
      for(let i=1;i<=POINTS.length;i++){
        const btn=document.createElement('button');
        btn.className='sidebar-item w-full text-left';
        btn.dataset.section='p'+i;
        btn.innerHTML=`<span class="badge bg-indigo-100 text-indigo-800 font-extrabold text-xs">${i}</span><span class="font-semibold">${POINTS[i-1]}</span>`;
        btn.addEventListener('click',()=>{
          document.querySelectorAll('#pointsNav .sidebar-item').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.content-section').forEach(s=>s.classList.add('hidden'));
          btn.classList.add('active'); $('#'+btn.dataset.section)?.classList.remove('hidden');
          $('#welcome')?.classList.add('hidden');
        });
        nav.appendChild(btn);

        const sec=document.createElement('div'); sec.id='p'+i; sec.className='content-section';
        sec.innerHTML=`
          <h3 class="text-xl font-extrabold mb-2">${POINTS[i-1]}</h3>
          <div class="rounded-xl border border-slate-200 p-3">
            <div class="text-xs text-slate-500 mb-2" id="meta-p${i}">En attente…</div>
            <div class="prose prose-sm max-w-none" id="view-p${i}"></div>
          </div>
        `;
        host.appendChild(sec);
      }
    }
    function showHtml(i, html, words){
      const v=$('#view-p'+i), m=$('#meta-p'+i);
      v.innerHTML = html || '<p class="text-slate-500">—</p>';
      m.textContent = (words ? `${words} mots` : '') + ' Généré ✓';
      document.querySelector('#pointsNav .sidebar-item')?.click();
    }

    /* ====== Schéma strict par point ====== */
    // Pour les points “simples” → markdown long
    function schemaMarkdown(i){ return { key:'p'+i, type:'markdown', min_chars:MIN_CHARS }; }

    // Spécifiques
    const SCHEMAS = {
      1: { key:'p1', type:'markdown', role:'priere', min_chars:400,
           strict_note:'Prière à la première personne, liée à {book} {chap}, invocation du Saint-Esprit, sans “nous”.' },
      3: { key:'p3', type:'qa5',
           example:{
             q1:"Question 1 (référence chapitre précédent)…", r1:"Réponse détaillée (≥ 400 caractères)…",
             q2:"…", r2:"…", q3:"…", r3:"…", q4:"…", r4:"…", q5:"…", r5:"…"
           }},
      5: { key:'p5', type:'markdown', fig:'map', min_chars:MIN_CHARS },
      8: { key:'p8', type:'markdown', fig:'tree', min_chars:MIN_CHARS },
      9: { key:'p9', type:'verse',
           example:{ reference:"{book} {chap}:X", texte:"…", explication:"commentaire doctrinal long (≥ 600 caractères)" } },
      10:{ key:'p10', type:'markdown', min_chars:MIN_CHARS, note:'inclure grec/hébreu avec translittération' },
      11:{ key:'p11', type:'markdown', min_chars:MIN_CHARS, note:'définir chaque mot-clé (étymologie, usage, doctrine)' },
      12:{ key:'p12', type:'list', min_items:6, min_chars_each:250 },
      14:{ key:'p14', type:'markdown', min_chars:MIN_CHARS, note:'Relier au thème doctrinal explicite' },
      16:{ key:'p16', type:'list', min_items:4, min_chars_each:300 },
      17:{ key:'p17', type:'list', min_items:6, min_chars_each:220 },
      18:{ key:'p18', type:'table', min_rows:4, cols:["Verset A","Verset B","Contraste/liaison"], min_chars_each:180 },
      19:{ key:'p19', type:'markdown', min_chars:MIN_CHARS, note:'Comparer explicitement avec Actes 2 (Esprit, Église, mission)' },
      20:{ key:'p20', type:'verse', example:{ reference:"{book} {chap}:X", texte:"…", memotech:"méthode de mémorisation" } },
      21:{ key:'p21', type:'markdown', min_chars:MIN_CHARS },
      22:{ key:'p22', type:'markdown', min_chars:MIN_CHARS },
      23:{ key:'p23', type:'markdown', min_chars:MIN_CHARS, note:'récits/jeux/visuels simples' },
      24:{ key:'p24', type:'markdown', min_chars:MIN_CHARS },
      25:{ key:'p25', type:'markdown', min_chars:MIN_CHARS, note:'Conseils pratiques pour prédication/enseignement' },
      26:{ key:'p26', type:'markdown', min_chars:MIN_CHARS },
      27:{ key:'p27', type:'list', min_items:8, min_chars_each:120 },
      28:{ key:'p28', type:'markdown', role:'priere', min_chars:400,
           strict_note:'Prière de clôture à la première personne, liée à {book} {chap}, actions de grâce + engagement.' }
    };

    function schemaFor(i){
      return SCHEMAS[i] || schemaMarkdown(i);
    }

    /* ====== Prompts renforcés ====== */
    function buildPrompt(i){
      const book=currentLivre, chap=currentChap;
      const base =
        `Tu écris la rubrique n°${i} sur **${book} ${chap}** selon ce modèle strict (1→28). `
        + `Chaque rubrique doit respecter son **format** ci-dessous et atteindre ou dépasser **${MIN_CHARS} caractères** `
        + `(ou contraintes spécifiques). Les références bibliques doivent être écrites et rester fidèles au texte. `
        + `Rends les versets explicites (nous les lierons). Interdiction absolue des phrases “Voici X points…”.`;

      const s = schemaFor(i);
      let spec = '';

      switch(s.type){
        case 'qa5':
          spec = `\nFormat JSON attendu pour p3 :\n{\n "p3": {\n  "q1": "...", "r1": "...",\n  "q2": "...", "r2": "...",\n  "q3": "...", "r3": "...",\n  "q4": "...", "r4": "...",\n  "q5": "...", "r5": "..." }\n}\n`
               + `Chaque réponse ≥ 400 caractères, issue du **chapitre précédent** ( ${book} ${parseInt(chap,10)-1} si >1 ; sinon contexte d’intro canonique).`;
          break;
        case 'verse':
          spec = `\nFormat JSON attendu : {"p${i}": {"reference":"${book} ${chap}:X","texte":"…","explication":"…"}} `
               + `avec explication doctrinale développée (≥ 600 caractères).`;
          break;
        case 'list':
          spec = `\nFormat JSON attendu : {"p${i}":[ "entrée 1 longue", "entrée 2 longue", ... ]} `
               + `(min ${s.min_items} items, ≥ ${s.min_chars_each} caractères par item).`;
          break;
        case 'table':
          spec = `\nFormat JSON attendu : {"p${i}":[ {"Verset A":"…","Verset B":"…","Contraste/liaison":"…"}, ... ]} `
               + `(min ${s.min_rows} lignes, contenu doctrinal).`;
          break;
        default: // markdown
          spec = `\nFormat JSON attendu : {"p${i}":"contenu en Markdown long (≥ ${s.min_chars||MIN_CHARS} caractères)"}`
               + (s.role==='priere' ? `\nLa prière doit être à la première personne, **liée explicitement** à ${book} ${chap}.\n` : '');
      }

      const enrich =
        `\nRappels : intégrer **gras**, listes, tableaux markdown, éventuelles frises "YYYY — …". `
        + `Garder un ton pastoral, doctrinal et cohérent. Pas de doublons, pas de phrases d’en-tête inutiles.`;

      return base + '\n' + spec + enrich;
    }

    /* ====== Appel API + validation ====== */
    async function callAI(payload){
      const res = await fetch(API_URL_CHAT,{
        method:'POST', headers:{'content-type':'application/json'},
        body:JSON.stringify(payload)
      });
      const txt=await res.text(); let data; try{ data=JSON.parse(txt); }catch{ data={content:txt}; }
      if(!res.ok){ toast('API : '+(data?.error||data?.message||('HTTP '+res.status)),'err',7000); return null; }
      return data;
    }

    function wordsCount(txt){ return (txt||'').trim().split(/\s+/).filter(Boolean).length; }

    function validatePoint(i, obj){
      const s=schemaFor(i); const k='p'+i; const v=obj && obj[k];
      if(v==null) return {ok:false, why:'clé manquante'};
      if(s.type==='qa5'){
        const keys=['q1','r1','q2','r2','q3','r3','q4','r4','q5','r5'];
        for(const key of keys){ if(!v[key] || String(v[key]).trim().length<10) return {ok:false, why:'qa5 incomplet'}; }
        return {ok:true, html:linkify(`
          <div class="space-y-3">
            ${[1,2,3,4,5].map(n=>`
              <div>
                <p><strong>Q${n}.</strong> ${v['q'+n]}</p>
                <p><em>Réponse :</em> ${v['r'+n]}</p>
              </div>`).join('')}
          </div>`), words:wordsCount(Object.values(v).join(' '))
        };
      }
      if(s.type==='verse'){
        if(!v.reference || !v.texte || !v.explication) return {ok:false, why:'verse incomplet'};
        const html = `
          <p><strong>Verset-clé :</strong> <a class="underline decoration-indigo-600"
             target="_blank" rel="noopener"
             href="${gatewayLink(currentLivre,currentChap,v.reference.split(':')[1]||'')}">${v.reference}</a></p>
          <blockquote class="border-l-4 border-slate-300 pl-3 my-2">${v.texte}</blockquote>
          ${mdToHtml(v.explication)}
        `;
        return {ok:true, html:linkify(html), words:wordsCount(v.texte+' '+v.explication)};
      }
      if(s.type==='list'){
        if(!Array.isArray(v) || v.length<(s.min_items||1)) return {ok:false, why:'liste trop courte'};
        const html = `<ul class="list-disc pl-5">${v.map(li=>`<li>${li}</li>`).join('')}</ul>`;
        const w = wordsCount(v.join(' '));
        if(s.min_chars_each){
          for(const li of v){ if((li||'').length < s.min_chars_each) return {ok:false, why:'item trop court'}; }
        }
        return {ok:true, html:linkify(html), words:w};
      }
      if(s.type==='table'){
        if(!Array.isArray(v) || v.length<(s.min_rows||1)) return {ok:false, why:'table trop courte'};
        const head = Object.keys(v[0]||{});
        const rows = v.map(r=>`<tr>${head.map(h=>`<td class="border px-2 py-1 align-top">${r[h]||''}</td>`).join('')}</tr>`).join('');
        const html = `<div class="overflow-x-auto my-2"><table class="w-full text-sm border">
          <tr class="font-semibold bg-indigo-50">${head.map(h=>`<td class="border px-2 py-1">${h}</td>`).join('')}</tr>${rows}</table></div>`;
        return {ok:true, html:linkify(html), words:wordsCount(JSON.stringify(v))};
      }
      // markdown
      const txt = String(v||'').trim();
      const min = schemaFor(i).min_chars || MIN_CHARS;
      if(txt.length < min) return {ok:false, why:`markdown trop court (${txt.length}/${min})`};
      return {ok:true, html:mdToHtml(txt), words:wordsCount(txt)};
    }

    async function generatePoint(i){
      const prompt = buildPrompt(i);
      const payload = {
        livre: currentLivre,
        chapitre: parseInt(currentChap,10),
        target_point: i,
        schema: schemaFor(i),
        hint: prompt
      };
      const data = await callAI(payload);
      if(!data) return false;
      const obj = normalizeToPxx(data, i);
      const val = validatePoint(i, obj);
      if(!val.ok){
        // relance une fois en forçant “développe davantage”
        const data2 = await callAI({...payload, retry:1, force_more:true});
        if(!data2) return false;
        const obj2 = normalizeToPxx(data2, i);
        const val2 = validatePoint(i, obj2);
        if(!val2.ok){ toast(`Point ${i}: format non conforme (${val2.why})`,'err',6000); return false; }
        showHtml(i, val2.html, val2.words); return true;
      }
      showHtml(i, val.html, val.words); return true;
    }

    function normalizeToPxx(data, idx){
      // Accepte {"pX": ...} ou content
