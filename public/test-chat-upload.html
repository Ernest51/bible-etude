<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>üîé Test /api/chat ‚Äî upload JSON</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px}
  textarea{width:100%; height:200px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  pre{background:#f6f8fa; padding:12px; border-radius:8px; overflow:auto}
  button{padding:8px 12px; margin:0 8px 8px 0}
  .row{margin:8px 0}
  a.sample{margin-right:10px}
</style>
</head>
<body>
  <h1>üîé Test /api/chat ‚Äî upload JSON</h1>

  <div class="row">
    <input type="file" id="file" accept="application/json,.json" />
    <button id="loadFile">Charger le fichier</button>
  </div>

  <div class="row">
    <a href="/req-b.json" class="sample">req-b.json</a>
    <a href="/req-c.json" class="sample">req-c.json</a>
    <a href="/req-jean-3-16.json" class="sample">req-jean-3-16.json</a>
    <a href="/req-jean-3-16-short.json" class="sample">req-jean-3-16-short.json</a>
    <button id="loadB">Charger l‚Äôexemple B</button>
    <button id="loadC">Charger l‚Äôexemple C</button>
    <button id="loadJ">Charger Jean 3:16</button>
  </div>

  <textarea id="payload"></textarea>
  <p><button id="send">POST /api/chat</button> <a href="/test-chat.html">‚¨Ö retour</a></p>

  <h3>R√©ponse</h3>
  <pre id="out">‚Äî</pre>

<script>
const $ = (id)=>document.getElementById(id);
const out = $("out"), ta = $("payload");

const exB = { book:"Gen√®se", chapter:1, verse:"", version:"LSG" };
const exC = { book:"Gen√®se", chapter:1, verse:"", version:"LSG",
  directives:{ priere_ouverture:"Ton sobre, insister sur 'Parole qui ordonne' et 'lumi√®re/t√©n√®bres', conclure par 'Par ton Esprit Saint, amen.'" }
};
const exJ = { book:"Jean", chapter:3, verse:"16", version:"LSG",
  directives:{ priere_ouverture:"Faire court, centrer sur l'amour de Dieu et la foi, conclure par 'Amen.'" }
};

function set(v){ ta.value = JSON.stringify(v, null, 2); }
set(exB);

$("loadB").onclick = ()=>set(exB);
$("loadC").onclick = ()=>set(exC);
$("loadJ").onclick = ()=>set(exJ);

$("loadFile").onclick = () => {
  const f = $("file").files?.[0];
  if (!f) { out.textContent = "Aucun fichier s√©lectionn√©."; return; }
  const reader = new FileReader();
  reader.onload = () => { ta.value = reader.result; };
  reader.onerror = () => { out.textContent = "‚ùå Lecture fichier : " + reader.error; };
  reader.readAsText(f, "utf-8");
};

$("send").onclick = async () => {
  let payload;
  try { payload = JSON.parse(ta.value || "{}"); }
  catch (e) { out.textContent = "‚ùå JSON invalide : " + e.message; return; }

  out.textContent = "Envoi...";
  try {
    const res = await fetch("/api/chat", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    try {
      const json = JSON.parse(text);
      const n = json?.data?.sections?.length ?? "‚Äî";
      out.textContent = `HTTP ${res.status} ${res.statusText} | Sections: ${n}\n\n` + JSON.stringify(json, null, 2);
    } catch {
      out.textContent = `HTTP ${res.status} ${res.statusText}\n\n` + text;
    }
  } catch (e) {
    out.textContent = "‚ùå Erreur r√©seau : " + e.message;
  }
};
</script>
</body>
</html>
