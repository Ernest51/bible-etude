<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Méditation</title>
  <meta name="description" content="Étude biblique — rubriques, PDF et liens BibleGateway." />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <!-- Polices : Inter (UI), Spectral (texte), Fraunces (titre) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Spectral:ital,wght@0,400;0,600;1,400&family=Fraunces:wght@700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f6f8; --panel:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#0891b2; --accent-600:#0e7490; --accent-700:#155e75; --accent-soft:#e0f2fe;
      --ok:#16a34a; --warn:#f59e0b; --link:#1d4ed8;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:16px 18px 14px;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:34px;line-height:1.1;letter-spacing:.2px;text-align:center;
       font-family:Fraunces,"Playfair Display","Times New Roman",serif;font-weight:800}
    main{max-width:1200px;margin:14px auto;padding:0 12px}

    .controls{display:grid;grid-template-columns:1.2fr .9fr .6fr .9fr .9fr auto auto auto auto;gap:10px;margin:12px 0;align-items:center}
    @media (max-width:1200px){.controls{grid-template-columns:1fr 1fr 1fr 1fr;grid-auto-rows:auto}.controls .wide{grid-column:1/-1}}
    input[type="text"],select{border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%;background:#fff;color:var(--text)}
    .btn{border:1px solid var(--border);background:#fff;color:#111;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.warn{background:var(--accent-600);border-color:var(--accent-600);color:#fff}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .layout{display:grid;grid-template-columns:320px 1fr;gap:12px}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}}

    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .side-head{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:800;text-align:center}
    .list{max-height:70vh;overflow:auto}
    .item{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:hover{background:#f8fafc}.item.active{background:var(--accent-soft)}
    .idx{min-width:24px;height:24px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#fff}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);margin-left:auto}
    .dot.ok{background:#16a34a}

    .editor{background:var(--panel);border:1px solid var(--border);border-radius:12px;min-height:60vh;display:flex;flex-direction:column}
    .ed-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .ed-title{font-weight:800;flex:1}.ed-body{padding:12px}
    #noteArea{display:none}
    #noteView{display:block;width:100%;min-height:460px;border:1px solid var(--border);border-radius:10px;padding:14px;font-family:Spectral,Georgia,serif;line-height:1.6;background:#fff}
    #noteView a{color:var(--link);text-decoration:underline}
    #noteMinimal{display:none;width:100%;min-height:160px;border:1px dashed var(--border);border-radius:10px;padding:14px;background:#fff}

    .links-panel{background:#fafafa;border:1px dashed var(--border);border-radius:10px;padding:8px 10px;margin-top:8px;font-size:14px}
    .links-panel.empty{display:none}
    .last-study{margin:10px 0 0 0;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:10px;font-size:14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .last-study a{color:var(--link);text-decoration:underline}

    /* Impression PDF */
    #printDoc{display:none}
    @media print{
      header,.controls,.layout,.last-study,.links-panel{display:none!important}
      #printDoc{display:block!important;color:#111;font-family:Spectral,Georgia,serif}
      #printDoc h2{margin:0 0 6px 0}
      #printDoc .sec{page-break-inside:avoid;margin:0 0 16px 0}
      #printDoc a{color:#1d4ed8;text-decoration:underline}
    }
  </style>
</head>
<body data-theme="cyan">
  <header><h1>Méditation</h1></header>

  <main>
    <div class="controls">
      <input id="searchRef" class="wide" type="text" placeholder="Rechercher (ex : Marc 5:2, Luc, 1 Jean 2:1-5)" />
      <select id="bookSelect" title="Livre"></select>
      <select id="chapterSelect" title="Chapitre"></select>
      <select id="verseSelect" title="Verset"></select>
      <select id="versionSelect" title="Version">
        <option value="LSG" selected>Louis Segond 1910 (LSG)</option>
        <option value="PDV">Parole de Vie (PDV)</option>
        <option value="S21">Segond 21 (S21)</option>
        <option value="BFC">Français Courant (BFC)</option>
      </select>
      <button id="readBtn" class="btn" type="button">Lire la Bible</button>
      <button id="generateBtn" class="btn primary" type="button">Générer</button>
      <button id="pdfOneBtn" class="btn warn" type="button" title="Exporter la rubrique en PDF">PDF (rubrique)</button>
      <button id="pdfAllBtn" class="btn warn" type="button" title="Exporter les 28 rubriques en PDF">PDF (28 points)</button>
      <a id="chatgptBtn" class="btn" href="https://chatgpt.com/" target="_blank" rel="noopener">ChatGPT</a>
    </div>

    <div id="lastStudyPanel" class="last-study" style="display:none;">
      <strong>Dernière étude :</strong>
      <span id="lastStudyText"></span>
      <a id="lastStudyOpen" href="#" target="_blank" rel="noopener">Ouvrir sur BibleGateway</a>
      <button id="lastStudyUse" class="btn" type="button">Recharger</button>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <div class="side-head">Rubrique</div>
        <div id="pointsList" class="list"></div>
      </aside>

      <section class="editor">
        <div class="ed-head">
          <div class="ed-title" id="edTitle">—</div>
          <button id="prev" class="btn" type="button">◀ Précédent</button>
          <button id="next" class="btn" type="button">Suivant ▶</button>
        </div>
        <div class="ed-body">
          <div id="noteView" contenteditable="true" spellcheck="false" aria-label="Contenu enrichi"></div>
          <div id="noteMinimal" aria-label="Résumé minimaliste"><div id="noteMinimalBody"></div></div>
          <textarea id="noteArea" placeholder="Écris ici…"></textarea>
          <div id="linksPanel" class="links-panel empty">
            <b>Liens détectés :</b>
            <div id="linksList"></div>
          </div>
        </div>
        <div class="ed-foot">
          <span class="small" id="metaInfo">Point — / 28</span>
          <span class="small">Sauvegarde auto (2s) après saisie.</span>
        </div>
      </section>
    </div>
  </main>

  <!-- Conteneur dédié à l’impression PDF -->
  <div id="printDoc"></div>

  <script>
  (function(){
    /* ---------- ÉTAT ---------- */
    const STORAGE_NOTES='notes28';
    const state={ points:[], current:0, notes: JSON.parse(localStorage.getItem(STORAGE_NOTES)||'{}') };

    /* ---------- RÉFS ---------- */
    const edTitle=$('#edTitle'), noteArea=$('#noteArea'), noteView=$('#noteView'), noteMinimal=$('#noteMinimal'), noteMinimalBody=$('#noteMinimalBody');
    const metaInfo=$('#metaInfo'), pointsList=$('#pointsList');
    const versionSelect=$('#versionSelect'), bookSelect=$('#bookSelect'), chapterSelect=$('#chapterSelect'), verseSelect=$('#verseSelect');
    const readBtn=$('#readBtn'), searchRef=$('#searchRef');
    const pdfOneBtn=$('#pdfOneBtn'), pdfAllBtn=$('#pdfAllBtn'), printDoc=$('#printDoc');

    function $(q){return document.querySelector(q);} function $all(q){return Array.from(document.querySelectorAll(q));}

    /* ---------- Gateway ---------- */
    const gatewayVersionMap={ LSG:'LSG', S21:'SG21', PDV:'LSG', BFC:'SG21' };
    function buildGatewayUrl(ref){
      const uiVersion=versionSelect.value||'LSG';
      const v=gatewayVersionMap[uiVersion]||'LSG';
      return 'https://www.biblegateway.com/passage/?search='+encodeURIComponent(ref)+'&version='+encodeURIComponent(v);
    }
    function openOnBibleGateway(ref){ window.open(buildGatewayUrl(ref),'_blank','noopener'); }

    /* ---------- Linkify références ---------- */
    const ORDER_66=["Genèse","Exode","Lévitique","Nombres","Deutéronome","Josué","Juges","Ruth","1 Samuel","2 Samuel","1 Rois","2 Rois","1 Chroniques","2 Chroniques","Esdras","Néhémie","Esther","Job","Psaumes","Proverbes","Ecclésiaste","Cantique des Cantiques","Ésaïe","Jérémie","Lamentations","Ézéchiel","Daniel","Osée","Joël","Amos","Abdias","Jonas","Michée","Nahum","Habacuc","Sophonie","Aggée","Zacharie","Malachie","Matthieu","Marc","Luc","Jean","Actes","Romains","1 Corinthiens","2 Corinthiens","Galates","Éphésiens","Philippiens","Colossiens","1 Thessaloniciens","2 Thessaloniciens","1 Timothée","2 Timothée","Tite","Philémon","Hébreux","Jacques","1 Pierre","2 Pierre","1 Jean","2 Jean","3 Jean","Jude","Apocalypse"];
    const BOOKS=ORDER_66.slice();
    const BOOKS_RE_SRC='\\b(' + BOOKS.map(b=>b.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')).join('|') + ')\\s+(\\d+)(?::\\s*(\\d+(?:\\s*[–-]\\s*\\d+)?(?:\\s*,\\s*\\d+(?:\\s*[–-]\\s*\\d+)?)*)\\s*)?';
    const BOOKS_RE=new RegExp(BOOKS_RE_SRC,'gi');
    const V_RE=/(?:^|[\s\[(«"';])v\.\s*(\d+(?:\s*[–-]\s*\d+)?(?:\s*,\s*\d+(?:\s*[–-]\s*\d+)?)*)\b/gi;
    const INHERIT_RE=/;\s*(\d+(?::\d+(?:\s*[–-]\s*\d+)?)?)\b/g;

    function decodeEntities(str){ const ta=document.createElement('textarea'); ta.innerHTML=str; return ta.value; }
    function mdBoldToStrong(str){ return str.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>'); }

    function linkifyContainer(root, currentBookChapterRef){
      const walker=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,{
        acceptNode:(node)=>{
          if(!node.nodeValue||!node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          if(node.parentElement && node.parentElement.closest('a')) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      });
      const nodes=[]; while(walker.nextNode()) nodes.push(walker.currentNode);
      nodes.forEach(textNode=>{
        const text=textNode.nodeValue; let lastBook=null,lastChapter=null; const frag=document.createDocumentFragment(); let idx=0;
        function pushText(s){ if(s) frag.appendChild(document.createTextNode(s)); }
        function pushLink(label,ref){ const a=document.createElement('a'); a.href=buildGatewayUrl(ref); a.target='_blank'; a.rel='noopener'; a.setAttribute('data-ref',ref); a.textContent=label; frag.appendChild(a); }
        text.replace(BOOKS_RE,(m,book,ch,vers,off)=>{
          pushText(text.slice(idx,off)); idx=off+m.length; lastBook=book; lastChapter=ch;
          const ref=book+' '+ch+(vers?(':'+vers.replace(/\s+/g,'').replace(/–/g,'-')):''); pushLink(m,ref);
          let tail=text.slice(idx), mInh;
          while((mInh=INHERIT_RE.exec(tail)) && (!BOOKS_RE.test(tail.slice(0,mInh.index)))){
            const seg=mInh[0], payload=mInh[1], segStart=idx+mInh.index; pushText(text.slice(idx,segStart));
            const clean=payload.replace(/\s+/g,'').replace(/–/g,'-'); let ref2;
            if(clean.includes(':')){ ref2=`${lastBook} ${clean}`; lastChapter=clean.split(':')[0]; }
            else{ const chap=lastChapter||ch; ref2=`${lastBook} ${chap}:${clean}`; }
            pushLink(seg,ref2); idx=segStart+seg.length;
          }
          INHERIT_RE.lastIndex=0; BOOKS_RE.lastIndex=0; return m;
        });
        let rest=text.slice(idx); const currentBC=(lastBook&&lastChapter)?`${lastBook} ${lastChapter}`:(currentBookChapterRef||null);
        if(currentBC){
          const parts=[]; let last=0, mV;
          while((mV=V_RE.exec(rest))){ parts.push(rest.slice(last,mV.index)); const label=mV[0].replace(/\s+/g,' ').trim(); const verses=mV[1].replace(/\s+/g,'').replace(/–/g,'-'); parts.push({ref:`${currentBC}:${verses}`,label}); last=mV.index+mV[0].length; }
          parts.push(rest.slice(last)); parts.forEach(p=>{ if(typeof p==='string') pushText(p); else pushLink(p.label,p.ref); });
        }else{ pushText(rest); }
        textNode.parentNode.replaceChild(frag,textNode);
      });
    }

    function renderEnriched(text){
      let html=decodeEntities(text||'');
      html=mdBoldToStrong(html);
      html=html.replace(/\r\n/g,"\n").split('\n').map(l=>l===''?'<br>':l).join('\n');
      noteView.innerHTML=html;

      const currentBook=(bookSelect.value||'').trim();
      const currentCh=(chapterSelect.value||'').trim();
      const currentRef=(currentBook && currentCh)?(currentBook+' '+currentCh):null;
      linkifyContainer(noteView,currentRef);

      // Liste des liens
      const links=[...noteView.querySelectorAll('a')];
      const panel=$('#linksPanel'), list=$('#linksList');
      list.innerHTML=links.map(a=>`<div><a href="${a.href}" target="_blank" rel="noopener">${a.textContent}</a></div>`).join('');
      panel.classList.toggle('empty', links.length===0);
    }

    // IMPORTANT : ouvrir les liens dans un nouvel onglet même en contenteditable
    noteView.addEventListener('click',(e)=>{
      const a=e.target.closest('a');
      if(a && a.href){ e.preventDefault(); window.open(a.href,'_blank','noopener'); }
    });

    /* ---------- Points & notes ---------- */
    function updateEditor(){
      const item=state.points[state.current]||{title:'Point '+(state.current+1)};
      edTitle.textContent=item.title||('Point '+(state.current+1));
      metaInfo.textContent='Point '+(state.current+1)+' / '+state.points.length;
      noteArea.value=state.notes[state.current]||'';
      renderEnriched(noteArea.value||'');
      highlightActive(); updateDots();
    }
    function highlightActive(){ $all('#pointsList .item').forEach((el,i)=> el.classList.toggle('active', i===state.current)); }
    function updateDots(){ $all('#pointsList .item .dot').forEach((dot,i)=>{ const ok=!!(state.notes[i]&&state.notes[i].trim()); dot.classList.toggle('ok', ok); }); }
    function buildList(){
      pointsList.innerHTML='';
      state.points.forEach((p,i)=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<span class="idx">${i+1}</span><div><div>${p.title||('Point '+(i+1))}</div></div><span class="dot"></span>`;
        row.addEventListener('click',()=>{ state.current=i; updateEditor(); });
        pointsList.appendChild(row);
      });
      updateEditor();
    }

    async function loadPoints(){
      try{
        const r=await fetch('/api/study-28',{cache:'no-store'});
        if(!r.ok) throw 0;
        const data=await r.json();
        if(Array.isArray(data)&&data.length) state.points=data;
      }catch{
        state.points=Array.from({length:28},(_,i)=>({title:'Point '+(i+1)}));
      }
      buildList();
    }

    // Navigation points
    $('#prev').addEventListener('click',()=>{ state.current=(state.current-1+state.points.length)%state.points.length; updateEditor(); });
    $('#next').addEventListener('click',()=>{ state.current=(state.current+1)%state.points.length; updateEditor(); });

    // Sauvegarde
    let saveTimer=null;
    noteArea.addEventListener('input',()=>{
      clearTimeout(saveTimer);
      saveTimer=setTimeout(()=>{
        state.notes[state.current]=noteArea.value;
        localStorage.setItem(STORAGE_NOTES, JSON.stringify(state.notes));
        updateDots();
      }, 800);
    });

    /* ---------- Sélecteurs basiques (pour lier v. détectés) ---------- */
    const CHAPTERS_66={"Genèse":50,"Exode":40,"Lévitique":27,"Nombres":36,"Deutéronome":34,"Josué":24,"Juges":21,"Ruth":4,"1 Samuel":31,"2 Samuel":24,"1 Rois":22,"2 Rois":25,"1 Chroniques":29,"2 Chroniques":36,"Esdras":10,"Néhémie":13,"Esther":10,"Job":42,"Psaumes":150,"Proverbes":31,"Ecclésiaste":12,"Cantique des Cantiques":8,"Ésaïe":66,"Jérémie":52,"Lamentations":5,"Ézéchiel":48,"Daniel":12,"Osée":14,"Joël":3,"Amos":9,"Abdias":1,"Jonas":4,"Michée":7,"Nahum":3,"Habacuc":3,"Sophonie":3,"Aggée":2,"Zacharie":14,"Malachie":4,"Matthieu":28,"Marc":16,"Luc":24,"Jean":21,"Actes":28,"Romains":16,"1 Corinthiens":16,"2 Corinthiens":13,"Galates":6,"Éphésiens":6,"Philippiens":4,"Colossiens":4,"1 Thessaloniciens":5,"2 Thessaloniciens":3,"1 Timothée":6,"2 Timothée":4,"Tite":3,"Philémon":1,"Hébreux":13,"Jacques":5,"1 Pierre":5,"2 Pierre":3,"1 Jean":5,"2 Jean":1,"3 Jean":1,"Jude":1,"Apocalypse":22};
    function initSelects(){
      bookSelect.innerHTML='<option value="">Livre…</option>'+ORDER_66.map(b=>`<option>${b}</option>`).join('');
      rebuildChapterOptions('');
      let vopts='<option value="">Verset…</option>'; for(let i=1;i<=176;i++) vopts+=`<option>${i}</option>`; verseSelect.innerHTML=vopts;
    }
    function rebuildChapterOptions(book){
      const max=CHAPTERS_66[book]||0; let html='<option value="">Chapitre…</option>'; for(let i=1;i<=max;i++) html+=`<option>${i}</option>`;
      chapterSelect.innerHTML=html;
    }
    bookSelect.addEventListener('change',()=>rebuildChapterOptions(bookSelect.value||''));

    // Lire la Bible (ouvre sur Gateway selon sélection ou recherche brute)
    readBtn.addEventListener('click', ()=>{
      const raw=(searchRef.value||'').trim();
      if(raw) return openOnBibleGateway(raw);
      const b=(bookSelect.value||'').trim(), c=(chapterSelect.value||'').trim(), v=(verseSelect.value||'').trim();
      if(!b||!c) return alert('Sélectionne un livre et un chapitre.');
      openOnBibleGateway(b+' '+c+(v?(':'+v):''));
    });

    /* ---------- PDF : rubrique & 28 points ---------- */
    function buildSectionHTML(idx, title, raw){
      // transforme le texte brut (stocké) en HTML enrichi + liens
      const wrap=document.createElement('div');
      const header=`<h2>${idx}. ${title}</h2>`;
      let html=mdBoldToStrong(decodeEntities(raw||'')).replace(/\r\n/g,"\n").split('\n').map(l=>l===''?'<br>':l).join('\n');
      wrap.innerHTML=`<div class="sec">${header}<div class="content">${html}</div></div>`;
      linkifyContainer(wrap.querySelector('.content'), (bookSelect.value&&chapterSelect.value)?(bookSelect.value+' '+chapterSelect.value):null);
      return wrap.innerHTML;
    }

    function exportCurrentPDF(){
      const item=state.points[state.current]||{title:'Point '+(state.current+1)};
      const raw=state.notes[state.current]||'';
      printDoc.innerHTML = `<header><h1 style="font-family:Fraunces,serif;margin:0 0 8px 0">Méditation — ${item.title||('Point '+(state.current+1))}</h1></header>`
        + buildSectionHTML(state.current+1, item.title||('Point '+(state.current+1)), raw);
      window.print();
      setTimeout(()=>{ printDoc.innerHTML=''; }, 300);
    }

    function exportAllPDF(){
      let html = `<header><h1 style="font-family:Fraunces,serif;margin:0 0 8px 0">Méditation — 28 rubriques</h1></header>`;
      for(let i=0;i<state.points.length;i++){
        const title=state.points[i]?.title||('Point '+(i+1));
        const raw=state.notes[i]||'';
        html += buildSectionHTML(i+1, title, raw);
      }
      printDoc.innerHTML=html;
      window.print();
      setTimeout(()=>{ printDoc.innerHTML=''; }, 300);
    }

    pdfOneBtn.addEventListener('click', exportCurrentPDF);
    pdfAllBtn.addEventListener('click', exportAllPDF);

    /* ---------- Générer (appel existant côté serveur) ---------- */
    $('#generateBtn').addEventListener('click', async ()=>{
      const b=(bookSelect.value||'').trim(), c=(chapterSelect.value||'').trim();
      if(!b||!c) return alert('Sélectionne un livre et un chapitre.');
      const url='/api/generate-study?book='+encodeURIComponent(b)+'&chapter='+encodeURIComponent(c);
      const btn=$('#generateBtn'); btn.disabled=true; btn.textContent='Génération…';
      try{
        const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0;
        const data=await r.json();
        // data.sections : [{n, content}, ...] — on remplit les 28 notes
        state.notes={};
        for(let i=0;i<28;i++) state.notes[i]='';
        (data.sections||[]).forEach(s=>{ const idx=(s.n? s.n-1:0); if(idx>=0&&idx<28){ state.notes[idx]=s.content||''; }});
        localStorage.setItem(STORAGE_NOTES, JSON.stringify(state.notes));
        updateDots(); updateEditor();
      }catch(e){ alert('Génération indisponible pour le moment.'); }
      finally{ btn.disabled=false; btn.textContent='Générer'; }
    });

    /* ---------- Init ---------- */
    (async function init(){
      initSelects();
      await loadPoints();
    })();

  })();
  </script>
</body>
</html>
