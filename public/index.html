<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Méditation</title>
  <meta name="description" content="Étude biblique — 28 rubriques, génération et liens BibleGateway." />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Spectral:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f4f6f8; --panel:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --dark:#111827; --ok:#16a34a; --accent:#0891b2; --accent-soft:#e0f2fe; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:14px 18px;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:28px;font-weight:800;text-align:center}
    main{max-width:1200px;margin:14px auto;padding:0 12px}
    .controls{display:grid;grid-template-columns:1.2fr .9fr .6fr .9fr .9fr auto auto;gap:10px;margin:12px 0}
    @media (max-width:1100px){.controls{grid-template-columns:1fr 1fr 1fr 1fr 1fr;grid-auto-rows:auto}.controls .wide{grid-column:1/-1}}
    input[type="text"],select{border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%}
    .btn{background:var(--dark);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .btn.warn{background:var(--accent)}
    .btn[disabled]{opacity:.65;cursor:not-allowed}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:12px}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}}
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .side-head{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
    .list{max-height:70vh;overflow:auto}
    .item{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:hover{background:#f8fafc}.item.active{background:var(--accent-soft)}
    .idx{min-width:24px;height:24px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#fff}
    .desc{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b;margin-left:auto}
    .dot.ok{background:var(--ok)}
    .editor{background:var(--panel);border:1px solid var(--border);border-radius:12px;min-height:60vh;display:flex;flex-direction:column}
    .ed-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .ed-title{font-weight:800;flex:1}.ed-body{padding:12px}
    textarea#noteArea{width:100%;min-height:460px;resize:vertical;border:1px solid var(--border);border-radius:10px;padding:14px;font-family:Spectral,Georgia,serif;line-height:1.6;white-space:pre-wrap}
    #noteView{display:none;width:100%;min-height:460px;border:1px solid var(--border);border-radius:10px;padding:14px;font-family:Spectral,Georgia,serif;line-height:1.6;background:#fff;outline:none}
    #noteView a{color:var(--accent);text-decoration:underline}
    .links-panel{background:#fafafa;border:1px dashed var(--border);border-radius:10px;padding:8px 10px;margin-top:8px;font-size:14px}
    .links-panel.empty{display:none}
  </style>
</head>
<body>
  <header><h1>Méditation</h1></header>

  <main>
    <div class="controls">
      <input id="searchRef" class="wide" type="text" placeholder="Rechercher (ex : Marc 5:1, 1 Jean 2, Genèse 1:1-5)" />
      <select id="bookSelect" title="Livre"></select>
      <select id="chapterSelect" title="Chapitre"></select>
      <select id="verseSelect" title="Verset"></select>
      <select id="versionSelect" title="Version">
        <option value="LSG" selected>Louis Segond 1910 (LSG)</option>
        <option value="PDV">Parole de Vie (PDV)</option>
        <option value="S21">Segond 21 (S21)</option>
        <option value="BFC">Français Courant (BFC)</option>
      </select>
      <button id="readBtn" class="btn secondary" type="button">Lire la Bible</button>
      <button id="generateBtn" class="btn warn" type="button">Générer</button>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <div class="side-head">Rubriques (28)</div>
        <div id="pointsList" class="list"></div>
      </aside>

      <section class="editor">
        <div class="ed-head">
          <div class="ed-title" id="edTitle">—</div>
          <button id="prev" class="btn secondary" type="button">◀ Précédent</button>
          <button id="next" class="btn secondary" type="button">Suivant ▶</button>
        </div>
        <div class="ed-body">
          <textarea id="noteArea" placeholder="Écris ici…"></textarea>
          <div id="noteView" contenteditable="true" spellcheck="false" aria-label="Contenu enrichi"></div>
          <div id="linksPanel" class="links-panel empty"><b>Liens détectés :</b><div id="linksList"></div></div>
        </div>
        <div class="ed-foot">
          <span class="small" id="metaInfo">Point — / 28</span>
          <span class="small">Sauvegarde auto (2s) après saisie.</span>
        </div>
      </section>
    </div>
  </main>

  <script>
  (function(){
    // ---- ÉTAT ----
    const state = { points: [], current: 0, notes: JSON.parse(localStorage.getItem('notes28')||'{}') };

    // ---- UI ----
    const edTitle = document.getElementById('edTitle');
    const noteArea = document.getElementById('noteArea');
    const noteView = document.getElementById('noteView');
    const metaInfo = document.getElementById('metaInfo');
    const pointsList = document.getElementById('pointsList');
    const generateBtn = document.getElementById('generateBtn');
    const versionSelect = document.getElementById('versionSelect');
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const verseSelect = document.getElementById('verseSelect');
    const readBtn = document.getElementById('readBtn');
    const searchRef = document.getElementById('searchRef');

    // ---- BibleGateway helpers ----
    const gatewayVersionMap = { LSG:'LSG', S21:'SG21', PDV:'LSG', BFC:'SG21' };
    function buildGatewayUrl(ref){
      const uiVersion = versionSelect.value || 'LSG';
      const v = gatewayVersionMap[uiVersion] || 'LSG';
      return 'https://www.biblegateway.com/passage/?search=' + encodeURIComponent(ref) + '&version=' + encodeURIComponent(v);
    }
    function openOnBibleGateway(ref){ window.open(buildGatewayUrl(ref), '_blank', 'noopener,noreferrer'); }

    // ---- Linkify références bibliques dans le HTML ----
    const BOOKS = ["Genèse","Exode","Lévitique","Nombres","Deutéronome","Josué","Juges","Ruth","1 Samuel","2 Samuel","1 Rois","2 Rois","1 Chroniques","2 Chroniques","Esdras","Néhémie","Esther","Job","Psaumes","Proverbes","Ecclésiaste","Cantique des Cantiques","Ésaïe","Esaïe","Jérémie","Lamentations","Ézéchiel","Ezechiel","Daniel","Osée","Joël","Amos","Abdias","Jonas","Michée","Nahum","Habacuc","Sophonie","Aggée","Zacharie","Malachie","Matthieu","Marc","Luc","Jean","Actes","Romains","1 Corinthiens","2 Corinthiens","Galates","Éphésiens","Philippiens","Colossiens","1 Thessaloniciens","2 Thessaloniciens","1 Timothée","2 Timothée","Tite","Philémon","Hébreux","Jacques","1 Pierre","2 Pierre","1 Jean","2 Jean","3 Jean","Jude","Apocalypse"];
    const BOOKS_RE = new RegExp('\\b(' + BOOKS.map(b=>b.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|') + ')\\s+(\\d+)(?::(\\d+(?:[-–]\\d+)?))?', 'g');

    function linkifyScriptureHTML(html){
      // remplace expressions (Livre Chapitre[:Verset[-Verset]]) par <a data-ref="...">
      return html.replace(BOOKS_RE, (m,book,ch,vers)=> {
        const ref = book + ' ' + ch + (vers?(':'+vers):'');
        const href = buildGatewayUrl(ref);
        return `<a href="${href}" target="_blank" rel="noopener" data-ref="${ref}">${m}</a>`;
      });
    }

    // ---- Rendu enrichi (HTML du serveur conservé) ----
    function renderEnriched(text){
      // Si le serveur a envoyé du HTML (nos sections), on NE l’échappe PAS.
      // On ne fait que transformer les références bibliques en liens.
      let html = text
        .replace(/\r\n/g,"\n")
        .replace(/&lt;strong&gt;|&lt;\/strong&gt;/g,'') // au cas où un vieux cache aurait échappé
        .split('\n').map(l => l.trim()==='' ? '<br>' : l).join('\n');
      html = linkifyScriptureHTML(html);
      noteView.innerHTML = html;

      // Liste des liens détectés (y compris ceux générés)
      const links = [...noteView.querySelectorAll('a')];
      const panel = document.getElementById('linksPanel');
      const list = document.getElementById('linksList');
      list.innerHTML = links.map(a=>`<div><a href="${a.href}" target="_blank" rel="noopener">${a.textContent}</a></div>`).join('');
      panel.classList.toggle('empty', links.length===0);
    }

    // ---- Toggle brut/enrichi ----
    const enrichToggle = document.createElement('label');
    enrichToggle.style.display='flex'; enrichToggle.style.alignItems='center'; enrichToggle.style.gap='8px';
    enrichToggle.innerHTML = `<input id="enrichToggle" type="checkbox" checked /> <span>Mode enrichi</span>`;
    document.querySelector('.controls').appendChild(enrichToggle);
    function syncView(){
      const v = noteArea.value || '';
      if(document.getElementById('enrichToggle').checked){
        noteArea.style.display='none'; noteView.style.display='block';
        renderEnriched(v);
      }else{
        noteView.style.display='none'; noteArea.style.display='block';
      }
    }
    document.addEventListener('change', (e)=>{ if(e.target && e.target.id==='enrichToggle') syncView(); });

    // ---- Persistance ----
    let saveTimer=null;
    noteArea.addEventListener('input', ()=>{
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        state.notes[state.current] = noteArea.value;
        localStorage.setItem('notes28', JSON.stringify(state.notes));
        updateProgressDots();
        syncView();
      }, 800);
    });

    // ---- Points + navigation ----
    function updateEditor(){
      const item = state.points[state.current] || { title:'Point '+(state.current+1), hint:'' };
      edTitle.textContent = item.title || ('Point '+(state.current+1));
      metaInfo.textContent = 'Point '+(state.current+1)+' / '+state.points.length;
      noteArea.value = state.notes[state.current] || '';
      syncView();
      highlightActive();
      updateProgressDots();
    }
    function highlightActive(){ [...pointsList.children].forEach((el,i)=> el.classList.toggle('active', i===state.current)); }
    function updateProgressDots(){
      [...pointsList.children].forEach((el,i)=>{
        const dot = el.querySelector('.dot');
        const ok = !!(state.notes[i] && state.notes[i].trim());
        dot.classList.toggle('ok', ok);
      });
    }
    function buildList(){
      pointsList.innerHTML='';
      state.points.forEach((p,i)=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `<span class="idx">${i+1}</span>
          <div><div>${p.title || ('Point '+(i+1))}</div>${p.hint?`<small class="desc">${p.hint}</small>`:''}</div>
          <span class="dot"></span>`;
        row.addEventListener('click', ()=>{ state.current=i; updateEditor(); });
        pointsList.appendChild(row);
      });
      updateEditor();
    }

    async function loadPoints(){
      try{
        const r = await fetch('/api/study-28');
        if(!r.ok) throw new Error();
        const data = await r.json();
        if(Array.isArray(data) && data.length) state.points = data;
      }catch{
        state.points = Array.from({length:28},(_,i)=>({title:'Point '+(i+1), hint:''}));
      }
      buildList();
    }

    // ---- Génération ----
    function setGenerating(on){
      generateBtn.disabled = on;
      generateBtn.textContent = on ? 'Génération…' : 'Générer';
    }
    function formatSection(n, title, content){
      return `### ${n}. ${title}\n\n${content}`.trim();
    }
    function renderIntoNotes(payload){
      const sec = Array.isArray(payload.sections)?payload.sections:[];
      // reset
      for(let i=0;i<state.points.length;i++) state.notes[i]='';
      sec.forEach(s=>{
        const idx = (s.n? s.n-1 : 0);
        if(idx>=0 && idx<state.points.length){
          const title = state.points[idx]?.title || ('Point '+(idx+1));
          state.notes[idx] = formatSection(s.n || (idx+1), title, s.content || '');
        }
      });
      for(let i=0;i<state.points.length;i++){
        if(!state.notes[i]){
          const title = state.points[i]?.title || ('Point '+(i+1));
          state.notes[i] = formatSection(i+1, title, '_à compléter…_');
        }
      }
      localStorage.setItem('notes28', JSON.stringify(state.notes));
      updateEditor();
    }

    async function generateStudy(){
      const book = (bookSelect.value||'').trim();
      const ch   = (chapterSelect.value||'').trim();
      if(!book || !ch){ alert('Sélectionne un livre et un chapitre.'); return; }
      const url = '/api/generate-study?book='+encodeURIComponent(book)+'&chapter='+encodeURIComponent(ch);
      setGenerating(true);
      try{
        const r = await fetch(url);
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        renderIntoNotes(data);
      }catch(e){
        alert('Génération indisponible pour le moment.');
      }finally{
        setGenerating(false);
      }
    }

    generateBtn.addEventListener('click', generateStudy);

    // ---- Lire la Bible (Gateway) ----
    readBtn.addEventListener('click', ()=>{
      const raw = (searchRef.value||'').trim().replace(/\s+/g,' ');
      if(raw){ openOnBibleGateway(raw); return; }
      const book = (bookSelect.value||'').trim();
      const ch = (chapterSelect.value||'').trim();
      const v = (verseSelect.value||'').trim();
      if(!book || !ch){ alert('Indique un livre et un chapitre.'); return; }
      const ref = book + ' ' + ch + (v?(':'+v):'');
      openOnBibleGateway(ref);
    });

    // ---- Met à jour les href quand la version change ----
    versionSelect.addEventListener('change', ()=>{
      // régénère les href pour tous les <a data-ref>
      noteView.querySelectorAll('a[data-ref]').forEach(a=>{
        a.href = buildGatewayUrl(a.getAttribute('data-ref'));
      });
    });

    // ---- Selects simples ----
    function initSelects(){
      bookSelect.innerHTML = '<option value="">Livre…</option>' + BOOKS.map(b=>`<option>${b}</option>`).join('');
      chapterSelect.innerHTML = '<option value="">Chapitre…</option>' + Array.from({length:150},(_,i)=>`<option>${i+1}</option>`).join('');
      verseSelect.innerHTML = '<option value="">Verset…</option>' + Array.from({length:176},(_,i)=>`<option>${i+1}</option>`).join('');
    }

    document.getElementById('prev').addEventListener('click', ()=>{ state.current=(state.current-1+state.points.length)%state.points.length; updateEditor(); });
    document.getElementById('next').addEventListener('click', ()=>{ state.current=(state.current+1)%state.points.length; updateEditor(); });

    // ---- Init ----
    (async function init(){
      initSelects();
      await loadPoints();
      syncView();
    })();
  })();
  </script>
</body>
</html>
