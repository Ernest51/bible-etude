<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible √âtude ‚Äî Interface</title>
  <meta name="description" content="Interface d'√©tude biblique ‚Äî mod√®le 28 points avec sauvegarde locale et export." />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    :root {
      --bg:#f5f6f8; --card:#ffffff; --text:#0f172a; --muted:#64748b; --link:#2563eb;
      --green:#16a34a; --red:#dc2626; --amber:#d97706; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:18px 20px;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:28px}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px}
    .muted{color:var(--muted)}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:14px}
    input[type="text"]{flex:1;min-width:220px;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .btn{background:#111827;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .btn.success{background:var(--green)}
    .btn.warn{background:#f59e0b}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    details.section{border:1px solid var(--border);border-radius:12px;background:#fff}
    details.section summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:600;border-bottom:1px solid var(--border)}
    details.section[open] summary{background:#f8fafc}
    .body{padding:12px}
    textarea{width:100%;min-height:130px;resize:vertical;border:1px solid var(--border);border-radius:10px;padding:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hl{background:#fffbeb;border:1px dashed #f59e0b;border-radius:10px;padding:10px}
    .small{font-size:12px}
    footer{max-width:1100px;margin:26px auto;padding:0 16px;color:var(--muted);font-size:14px}
    /* Debug footer (discret) */
    #debugBtn{margin-top:8px;background:#111827;color:#fff;border:0;border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer}
    #debugPanel{display:none;margin-top:8px;background:#0b1020;color:#e2e8f0;border:1px solid #1f2a44;border-radius:8px;padding:8px;max-height:240px;overflow:auto;white-space:pre-wrap;font-size:12px}
    .status-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;font-size:12px;color:#111}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--amber)}
    .dot.ok{background:var(--green)} .dot.ko{background:var(--red)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
    select, label.switch {font-size:12px}
    .switch {display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .switch input{accent-color:#111827}
    .next {font-size:12px}
    /* Impression: montre le contenu, cache le debug */
    @media print{
      header, .toolbar, footer .status-row, footer .controls, #debugPanel { display:none !important; }
      body{background:#fff}
      details.section{break-inside:avoid}
    }
  </style>
</head>
<body>
  <header>
    <h1>Bible √âtude</h1>
  </header>

  <main>
    <!-- Barre d‚Äôactions -->
    <div class="card toolbar">
      <div class="bar">
        <input id="refInput" type="text" placeholder="R√©f√©rence (ex : Gen√®se 1:1-5)" />
        <input id="titreInput" type="text" placeholder="Titre de l‚Äô√©tude (ex : Cr√©ation ‚Äî Gen√®se 1)" />
        <button class="btn success" id="loadModel">Charger mod√®le 28 pts</button>
        <button class="btn" id="save">üíæ Sauvegarder</button>
        <button class="btn secondary" id="clear">üßπ Vider</button>
        <button class="btn warn" id="print">üñ®Ô∏è Imprimer / PDF</button>
      </div>
      <p class="muted small">Astuce : tout est sauvegard√© en local sur ton navigateur (localStorage). Le bouton üíæ force une sauvegarde imm√©diate.</p>
    </div>

    <!-- Zone √âtude -->
    <div id="study" class="grid"></div>
  </main>

  <!-- Footer avec debug discret -->
  <footer>
    ¬© <span id="y"></span> Bible √âtude
    <div class="status-row" aria-label="Statut API">
      <span class="badge"><span id="dot-health" class="dot" aria-hidden="true"></span> health</span>
      <span class="badge"><span id="dot-chat" class="dot" aria-hidden="true"></span> chat(POST)</span>
      <span class="badge"><span id="dot-ping" class="dot" aria-hidden="true"></span> ping</span>
      <button id="debugBtn" title="Ouvrir le panneau de debug">Debug</button>
    </div>
    <div class="controls">
      <label class="switch"><input type="checkbox" id="autoToggle"> Auto</label>
      <label>Intervalle:
        <select id="autoInterval">
          <option value="5">5 min</option>
          <option value="10" selected>10 min</option>
          <option value="30">30 min</option>
        </select>
      </label>
      <span class="next">Prochain check dans <strong id="nextIn">‚Äî</strong></span>
    </div>
    <div id="debugPanel">[init]</div>
  </footer>

  <script>
    (function(){
      // ===== √âtude ‚Äî mod√®le 28 points =====
      const SECTIONS = [
        '1. Th√®me central / Titre',
        '2. R√©f√©rence & contexte imm√©diat',
        '3. Auteur / Date / Destinataires',
        '4. Contexte historique & culturel',
        '5. Structure litt√©raire du passage',
        '6. Id√©es cl√©s (bullet points)',
        '7. Mots cl√©s & termes importants (h√©breu/grec)',
        '8. Parall√®les bibliques',
        '9. Promesses / Commandements',
        '10. V√©rit√©s doctrinales',
        '11. Christ au centre (typologie, proph√©tie, accomplissement)',
        '12. R√©v√©lation sur Dieu (attributs, ≈ìuvres)',
        '13. Condition humaine / p√©ch√© / gr√¢ce',
        '14. Plan du salut (si applicable)',
        '15. Le r√¥le du Saint-Esprit dans le texte',
        '16. Pistes d‚Äôinterpr√©tation (principes herm√©neutiques)',
        '17. Erreurs d‚Äôinterpr√©tation courantes (anti-mod√®les)',
        '18. Questions de m√©ditation',
        '19. Application personnelle',
        '20. Application communautaire / √âglise',
        '21. Pri√®re de r√©ponse',
        '22. Engagement concret (cette semaine)',
        '23. T√©moignage / Partage',
        '24. Versets √† m√©moriser',
        '25. Plan d‚Äô√©tude compl√©mentaire',
        '26. R√©f√©rences de th√©ologiens / commentaires',
        '27. Notes diverses',
        '28. Synth√®se finale (une page)'
      ];

      const studyEl = document.getElementById('study');
      const refInput = document.getElementById('refInput');
      const titreInput = document.getElementById('titreInput');
      const btnModel = document.getElementById('loadModel');
      const btnSave = document.getElementById('save');
      const btnClear = document.getElementById('clear');
      const btnPrint = document.getElementById('print');

      // Storage keys
      const KEY_META = 'be_meta';  // {ref, titre}
      const KEY_NOTES = 'be_notes'; // {index: text}

      function loadFromStorage(){
        try{
          const meta = JSON.parse(localStorage.getItem(KEY_META)||'{}');
          const notes = JSON.parse(localStorage.getItem(KEY_NOTES)||'{}');
          if(meta.ref) refInput.value = meta.ref;
          if(meta.titre) titreInput.value = meta.titre;
          return {meta, notes};
        }catch{ return {meta:{}, notes:{}}; }
      }

      function saveToStorage(){
        try{
          const meta = { ref: refInput.value.trim(), titre: titreInput.value.trim() };
          const notes = {};
          document.querySelectorAll('[data-note-index]').forEach(area=>{
            notes[area.dataset.noteIndex] = area.value;
          });
          localStorage.setItem(KEY_META, JSON.stringify(meta));
          localStorage.setItem(KEY_NOTES, JSON.stringify(notes));
          toast('Sauvegard√© ‚úÖ');
        }catch(e){ console.warn('Storage error', e); }
      }

      function clearStorage(){
        localStorage.removeItem(KEY_META);
        localStorage.removeItem(KEY_NOTES);
        refInput.value = '';
        titreInput.value = '';
        renderSections({}); // reset all textareas
      }

      function toast(msg){
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.position='fixed'; t.style.right='16px'; t.style.bottom='16px';
        t.style.background='#111827'; t.style.color='#fff'; t.style.padding='10px 12px';
        t.style.borderRadius='10px'; t.style.boxShadow='0 6px 18px rgba(0,0,0,.15)'; t.style.zIndex='9999';
        document.body.appendChild(t);
        setTimeout(()=>t.remove(), 1400);
      }

      function renderSections(savedNotes){
        studyEl.innerHTML = '';
        // Bandeau titre et r√©f√©rence
        const head = document.createElement('div');
        head.className = 'card';
        head.style.marginBottom = '14px';
        head.innerHTML = `
          <div class="two">
            <div class="hl">
              <div class="small muted">R√©f√©rence</div>
              <div style="font-weight:700;font-size:18px">${refInput.value || '‚Äî'}</div>
            </div>
            <div class="hl">
              <div class="small muted">Titre</div>
              <div style="font-weight:700;font-size:18px">${titreInput.value || '‚Äî'}</div>
            </div>
          </div>
        `;
        studyEl.appendChild(head);

        // Sections (accord√©ons)
        SECTIONS.forEach((label, i)=>{
          const d = document.createElement('details');
          d.className = 'section';
          d.open = i < 4; // ouvre les premi√®res pour d√©marrer
          const s = document.createElement('summary');
          s.textContent = label;
          const body = document.createElement('div');
          body.className = 'body';
          const ta = document.createElement('textarea');
          ta.placeholder = '√âcris ici‚Ä¶';
          ta.value = (savedNotes && savedNotes[i]) || '';
          ta.dataset.noteIndex = String(i);
          ta.addEventListener('input', throttle(saveToStorage, 500));
          body.appendChild(ta);
          d.appendChild(s); d.appendChild(body);
          studyEl.appendChild(d);
        });
      }

      // simple throttle
      let throttleTimer=null;
      function throttle(fn, delay){
        return function(...args){
          if(throttleTimer) return;
          throttleTimer = setTimeout(()=>{ throttleTimer=null; fn.apply(this,args); }, delay);
        };
      }

      // Init
      (function init(){
        document.getElementById('y').textContent = new Date().getFullYear();
        const { notes } = loadFromStorage();
        renderSections(notes);

        btnModel.addEventListener('click', ()=>{ renderSections(loadFromStorage().notes); toast('Mod√®le charg√©'); });
        btnSave.addEventListener('click', saveToStorage);
        btnClear.addEventListener('click', ()=>{ if(confirm('Vider le contenu local ?')){ clearStorage(); toast('Vidage effectu√©'); } });
        btnPrint.addEventListener('click', ()=>{ saveToStorage(); window.print(); });
        refInput.addEventListener('input', throttle(saveToStorage, 500));
        titreInput.addEventListener('input', throttle(saveToStorage, 500));
      })();

      // ===== Debug (footer) identique, en mode discret =====
      const btn = document.getElementById('debugBtn');
      const panel = document.getElementById('debugPanel');
      const dotHealth = document.getElementById('dot-health');
      const dotChat = document.getElementById('dot-chat');
      const dotPing = document.getElementById('dot-ping');
      const autoToggle = document.getElementById('autoToggle');
      const autoInterval = document.getElementById('autoInterval');
      const nextIn = document.getElementById('nextIn');
      let autoTimer=null, countdownTimer=null, remainingMs=0;

      function setDot(dot, ok){
        dot.classList.remove('ok','ko');
        if (ok === true) dot.classList.add('ok'); else if (ok === false) dot.classList.add('ko');
      }
      function log(msg){
        const line = '['+new Date().toISOString()+'] '+msg;
        panel.textContent += (panel.textContent ? '\n' : '') + line;
        console.log(line);
      }
      async function ping(path, options){
        try{
          const c = new AbortController();
          const t = setTimeout(()=>c.abort(),2500);
          const r = await fetch(path, { ...(options||{}), signal:c.signal });
          clearTimeout(t);
          return r;
        }catch(e){ return { ok:false, status:0, error:String(e) }; }
      }
      async function runChecks(logToPanel=true){
        setDot(dotHealth, undefined); setDot(dotChat, undefined); setDot(dotPing, undefined);
        const r1 = await ping('/api/health'); setDot(dotHealth, !!(r1 && r1.ok)); if (logToPanel) log((r1 && r1.ok ? 'OK':'KO')+' /api/health ‚Üí '+(r1.status||0));
        const r2 = await ping('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({probe:true,ts:Date.now()})}); setDot(dotChat, !!(r2 && r2.ok)); if (logToPanel) log((r2 && r2.ok ? 'OK':'KO')+' /api/chat (POST) ‚Üí '+(r2.status||0));
        const r3 = await ping('/api/ping'); setDot(dotPing, !!(r3 && r3.ok)); if (logToPanel) log((r3 && r3.ok ? 'OK':'KO')+' /api/ping ‚Üí '+(r3.status||0));
      }
      function fmt(ms){ const s=Math.max(0,Math.floor(ms/1000)); const m=Math.floor(s/60); const ss=String(s%60).padStart(2,'0'); return m+':'+ss; }
      function clearTimers(){ if(autoTimer){clearTimeout(autoTimer);autoTimer=null;} if(countdownTimer){clearInterval(countdownTimer);countdownTimer=null;} }
      function scheduleNext(){
        clearTimers();
        if (!autoToggle.checked){ nextIn.textContent='‚Äî'; return; }
        if (document.hidden){ nextIn.textContent='pause (onglet inactif)'; return; }
        const mins=parseInt(autoInterval.value,10)||10; remainingMs=mins*60*1000;
        nextIn.textContent = fmt(remainingMs);
        countdownTimer=setInterval(()=>{ remainingMs-=1000; nextIn.textContent=fmt(remainingMs); if(remainingMs<=0){clearInterval(countdownTimer);} },1000);
        autoTimer=setTimeout(async ()=>{ const willLog = panel.style.display==='block'; if (willLog) panel.textContent='[Debug d√©marr√©‚Ä¶]'; await runChecks(willLog); scheduleNext(); }, remainingMs);
      }
      function togglePanel(){ const open=panel.style.display==='block'; if(open){ panel.style.display='none'; btn.textContent='Debug'; } else { panel.style.display='block'; btn.textContent='Fermer Debug'; panel.textContent='[Debug d√©marr√©‚Ä¶]'; runChecks(true); } }
      btn.addEventListener('click', togglePanel);
      autoToggle.addEventListener('change', scheduleNext);
      autoInterval.addEventListener('change', scheduleNext);
      document.addEventListener('visibilitychange', scheduleNext);
      document.getElementById('y').textContent = new Date().getFullYear();
      // auto OFF par d√©faut pour √©conomiser les requ√™tes
      scheduleNext();
    })();
  </script>
</body>
</html>
