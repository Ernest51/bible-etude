<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible √âtude ‚Äî 28 points</title>
  <meta name="description" content="√âtude biblique ‚Äî colonne 28 points + √©diteur central, sauvegarde locale, s√©lection Livre/Chapitre/Version." />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    :root{
      --bg:#f5f6f8; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --link:#2563eb;
      --border:#e5e7eb; --green:#16a34a; --red:#dc2626; --amber:#d97706; --dark:#111827;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    /* Barre de progression en haut du header */
    .progress-wrap{position:sticky;top:0;z-index:20;background:transparent}
    .progress{height:4px;background:#e5e7eb}
    .progress > .bar{height:100%;width:0;background:linear-gradient(90deg,#2563eb,#16a34a);transition:width .2s ease}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:12px 18px;position:sticky;top:4px;z-index:10}
    h1{margin:0;font-size:24px}
    main{max-width:1200px;margin:18px auto;padding:0 14px}
    .toolbar{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;margin:12px 0}
    .toolbar-2{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin:0 0 12px}
    .fullrow{grid-column:1 / -1}
    input[type="text"], select{border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%}
    .btn{background:var(--dark);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .btn.warn{background:#f59e0b}
    .saved{font-size:12px;color:var(--muted);align-self:center}
    .layout{display:grid;grid-template-columns:280px 1fr;gap:12px}
    @media (max-width:1000px){ .layout{grid-template-columns:1fr} .toolbar{grid-template-columns:1fr 1fr;}.toolbar-2{grid-template-columns:1fr 1fr} }
    /* Sidebar */
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .side-head{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
    .list{max-height:70vh;overflow:auto}
    .item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:last-child{border-bottom:0}
    .item:hover{background:#f8fafc}
    .item.active{background:#eef2ff}
    .idx{min-width:22px;height:22px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#fff}
    .dot{width:8px;height:8px;border-radius:999px;background:#eab308;margin-left:auto}
    .dot.ok{background:var(--green)}
    /* Editor */
    .editor{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;min-height:60vh;display:flex;flex-direction:column}
    .ed-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .ed-title{font-weight:700;flex:1}
    .ed-body{padding:12px}
    textarea{width:100%;min-height:380px;resize:vertical;border:1px solid var(--border);border-radius:10px;padding:12px}
    .ed-foot{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}
    .navbtn{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .muted{color:var(--muted)}
    footer{max-width:1200px;margin:22px auto 26px;padding:0 14px;color:var(--muted);font-size:14px}
    /* Debug footer (discret) */
    #debugBtn{margin-top:8px;background:#111827;color:#fff;border:0;border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer}
    #debugPanel{display:none;margin-top:8px;background:#0b1020;color:#e2e8f0;border:1px solid #1f2a44;border-radius:8px;padding:8px;max-height:240px;overflow:auto;white-space:pre-wrap;font-size:12px}
    .status-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;font-size:12px;color:#111}
    .mini{width:8px;height:8px;border-radius:999px;background:#d97706}
    .mini.ok{background:var(--green)} .mini.ko{background:var(--red)}
    @media print{ .progress-wrap, header, .toolbar, .toolbar-2, .sidebar, .ed-foot, footer .status-row, #debugPanel { display:none !important; } textarea{min-height:unset} }
  </style>
</head>
<body>
  <!-- Barre de progression coll√©e en haut du header -->
  <div class="progress-wrap">
    <div class="progress"><div id="progressBar" class="bar" style="width:0%"></div></div>
  </div>

  <header><h1>Bible √âtude ‚Äî 28 points</h1></header>

  <main>
    <!-- Ligne 1 : R√©f√©rence + Titre + actions -->
    <div class="toolbar">
      <input id="refInput" class="fullrow" type="text" placeholder="R√©f√©rence (ex : Gen√®se 1:1-5)" />
      <input id="titreInput" class="fullrow" type="text" placeholder="Titre de l‚Äô√©tude (ex : Cr√©ation ‚Äî Gen√®se 1)" />
      <button id="save" class="btn">üíæ Sauvegarder</button>
      <button id="clear" class="btn secondary">üßπ Vider</button>
      <button id="print" class="btn warn">üñ®Ô∏è Imprimer / PDF</button>
      <span id="savedBadge" class="saved">‚Äî</span>
    </div>

    <!-- Ligne 2 : Livre / Chapitre / Version / Dernier + Valider -->
    <div class="toolbar-2">
      <select id="bookSelect" title="Livre"></select>
      <select id="chapterSelect" title="Chapitre"></select>
      <select id="versionSelect" title="Version">
        <option value="PDV" selected>Parole de Vie (PDV)</option>
        <option value="LSG">Louis Segond 1910 (LSG)</option>
        <option value="S21">Segond 21 (S21)</option>
        <option value="BFC">Fran√ßais Courant (BFC)</option>
      </select>
      <div id="lastStudy" class="muted" style="align-self:center">Dernier : ‚Äî</div>
      <button id="validate" class="btn">Valider</button>
    </div>

    <div class="layout">
      <!-- Colonne gauche : 28 points -->
      <aside class="sidebar">
        <div class="side-head">Plan d‚Äô√©tude (28)</div>
        <div id="pointsList" class="list"></div>
      </aside>

      <!-- Colonne centrale : √©diteur -->
      <section class="editor">
        <div class="ed-head">
          <div class="ed-title" id="edTitle">‚Äî</div>
          <button id="prev" class="navbtn">‚óÄ Pr√©c√©dent</button>
          <button id="next" class="navbtn">Suivant ‚ñ∂</button>
        </div>
        <div class="ed-body">
          <textarea id="noteArea" placeholder="√âcris ici‚Ä¶"></textarea>
        </div>
        <div class="ed-foot">
          <span class="muted" id="metaInfo">Point ‚Äî / 28</span>
          <span class="muted">Sauvegarde auto (2s) apr√®s saisie.</span>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer + debug discret -->
  <footer>
    ¬© <span id="y"></span> Bible √âtude
    <div class="status-row" aria-label="Statut API">
      <span class="badge"><span id="dot-health" class="mini" aria-hidden="true"></span> health</span>
      <span class="badge"><span id="dot-chat" class="mini" aria-hidden="true"></span> chat(POST)</span>
      <span class="badge"><span id="dot-ping" class="mini" aria-hidden="true"></span> ping</span>
      <button id="debugBtn" title="Ouvrir le panneau de debug">Debug</button>
    </div>
    <div id="debugPanel">[init]</div>
  </footer>

  <script>
    (function(){
      // ===== Data: 66 livres + nb chapitres =====
      const BOOKS = [
        ["Gen√®se",50],["Exode",40],["L√©vitique",27],["Nombres",36],["Deut√©ronome",34],
        ["Josu√©",24],["Juges",21],["Ruth",4],["1 Samuel",31],["2 Samuel",24],
        ["1 Rois",22],["2 Rois",25],["1 Chroniques",29],["2 Chroniques",36],["Esdras",10],
        ["N√©h√©mie",13],["Esther",10],["Job",42],["Psaumes",150],["Proverbes",31],
        ["Eccl√©siaste",12],["Cantique des cantiques",8],["√âsa√Øe",66],["J√©r√©mie",52],["Lamentations",5],
        ["√âz√©chiel",48],["Daniel",12],["Os√©e",14],["Jo√´l",3],["Amos",9],
        ["Abdias",1],["Jonas",4],["Mich√©e",7],["Nahoum",3],["Habacuc",3],
        ["Sophonie",3],["Agg√©e",2],["Zacharie",14],["Malachie",4],
        ["Matthieu",28],["Marc",16],["Luc",24],["Jean",21],["Actes",28],
        ["Romains",16],["1 Corinthiens",16],["2 Corinthiens",13],["Galates",6],["√âph√©siens",6],
        ["Philippiens",4],["Colossiens",4],["1 Thessaloniciens",5],["2 Thessaloniciens",3],["1 Timoth√©e",6],
        ["2 Timoth√©e",4],["Tite",3],["Phil√©mon",1],["H√©breux",13],["Jacques",5],
        ["1 Pierre",5],["2 Pierre",3],["1 Jean",5],["2 Jean",1],["3 Jean",1],
        ["Jude",1],["Apocalypse",22]
      ];

      // ===== 28 sections =====
      const SECTIONS = [
        'Th√®me central / Titre','R√©f√©rence & contexte imm√©diat','Auteur / Date / Destinataires','Contexte historique & culturel',
        'Structure litt√©raire du passage','Id√©es cl√©s (bullet points)','Mots cl√©s & termes importants (h√©breu/grec)','Parall√®les bibliques',
        'Promesses / Commandements','V√©rit√©s doctrinales','Christ au centre (typologie, proph√©tie, accomplissement)','R√©v√©lation sur Dieu (attributs, ≈ìuvres)',
        'Condition humaine / p√©ch√© / gr√¢ce','Plan du salut (si applicable)','R√¥le du Saint-Esprit','Pistes d‚Äôinterpr√©tation (herm√©neutique)',
        'Erreurs d‚Äôinterpr√©tation (anti-mod√®les)','Questions de m√©ditation','Application personnelle','Application communautaire / √âglise',
        'Pri√®re de r√©ponse','Engagement concret (semaine)','T√©moignage / Partage','Versets √† m√©moriser',
        'Plan d‚Äô√©tude compl√©mentaire','R√©f√©rences de th√©ologiens / commentaires','Notes diverses','Synth√®se finale (une page)'
      ];
      const N = SECTIONS.length;

      // ===== Elements =====
      const refInput = document.getElementById('refInput');
      const titreInput = document.getElementById('titreInput');
      const savedBadge = document.getElementById('savedBadge');
      const bookSelect = document.getElementById('bookSelect');
      const chapterSelect = document.getElementById('chapterSelect');
      const versionSelect = document.getElementById('versionSelect');
      const lastStudy = document.getElementById('lastStudy');
      const validateBtn = document.getElementById('validate');

      const pointsList = document.getElementById('pointsList');
      const edTitle = document.getElementById('edTitle');
      const noteArea = document.getElementById('noteArea');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const metaInfo = document.getElementById('metaInfo');
      const progressBar = document.getElementById('progressBar');

      // Storage keys
      const KEY_META = 'be_meta';
      const KEY_NOTES = 'be_notes';
      const KEY_LAST  = 'be_last'; // {book,chapter,version}

      // State
      let current = 0;
      let notes = {};
      let autosaveTimer = null;

      // ===== Helpers =====
      function fmtIndex(i){ return (i+1) + '. ' + SECTIONS[i]; }
      function toastSaved(txt){
        savedBadge.textContent = txt + ' ‚úÖ ' + new Date().toLocaleTimeString();
        clearTimeout(toastSaved._t);
        toastSaved._t = setTimeout(()=> savedBadge.textContent='‚Äî', 2000);
      }
      function saveStorage(){
        try{
          const meta = { ref: refInput.value.trim(), titre: titreInput.value.trim() };
          localStorage.setItem(KEY_META, JSON.stringify(meta));
          localStorage.setItem(KEY_NOTES, JSON.stringify(notes));
          renderSidebarDots();
          toastSaved('Sauvegard√©');
        }catch{}
      }
      function loadStorage(){
        try{
          const meta = JSON.parse(localStorage.getItem(KEY_META)||'{}');
          const data = JSON.parse(localStorage.getItem(KEY_NOTES)||'{}');
          const last = JSON.parse(localStorage.getItem(KEY_LAST)||'{}');
          notes = data || {};
          if (meta.ref) refInput.value = meta.ref;
          if (meta.titre) titreInput.value = meta.titre;
          if (last.book && last.chapter){
            lastStudy.textContent = `Dernier : ${last.book} ${last.chapter} (${last.version||'‚Äî'})`;
          }
          return {last};
        }catch{ return {last:{}}; }
      }
      function clearStorage(){
        localStorage.removeItem(KEY_META);
        localStorage.removeItem(KEY_NOTES);
        refInput.value=''; titreInput.value=''; notes={}; renderSidebarDots(); noteArea.value='';
        toastSaved('Vidage');
      }

      // Progress bar control (placeholder ‚Äì anim simple lors de Valider)
      function setProgress(p){ progressBar.style.width = Math.max(0, Math.min(100, p)) + '%'; }
      async function fakePrep(){
        setProgress(10);
        await new Promise(r=>setTimeout(r,120));
        setProgress(55);
        await new Promise(r=>setTimeout(r,120));
        setProgress(100);
        setTimeout(()=> setProgress(0), 350);
      }

      // ===== UI renders =====
      function renderBooks(){
        bookSelect.innerHTML = '';
        BOOKS.forEach(([name, ch])=>{
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name; opt.dataset.ch = ch;
          bookSelect.appendChild(opt);
        });
      }
      function renderChapters(){
        chapterSelect.innerHTML = '';
        const sel = bookSelect.selectedOptions[0];
        const ch = sel ? parseInt(sel.dataset.ch,10) : 1;
        for(let i=1;i<=ch;i++){
          const opt=document.createElement('option'); opt.value=String(i); opt.textContent=String(i);
          chapterSelect.appendChild(opt);
        }
      }
      function renderSidebar(){
        pointsList.innerHTML = '';
        SECTIONS.forEach((label, i)=>{
          const row = document.createElement('div');
          row.className = 'item' + (i===current ? ' active' : '');
          row.dataset.idx = i;
          row.innerHTML = `
            <span class="idx">${i+1}</span>
            <span>${label}</span>
            <span class="dot ${notes[i] && notes[i].trim() ? 'ok':''}"></span>
          `;
          row.addEventListener('click', ()=>{ if(current!==i) select(i); });
          pointsList.appendChild(row);
        });
      }
      function renderSidebarDots(){
        document.querySelectorAll('.list .item').forEach(el=>{
          const i = Number(el.dataset.idx);
          const dot = el.querySelector('.dot');
          if (!dot) return;
          if (notes[i] && notes[i].trim()) dot.classList.add('ok'); else dot.classList.remove('ok');
        });
      }
      function select(i){
        notes[current] = noteArea.value;
        saveStorage();
        current = i;
        document.querySelectorAll('.list .item').forEach(el=> el.classList.toggle('active', Number(el.dataset.idx)===current));
        edTitle.textContent = fmtIndex(current);
        noteArea.value = notes[current] || '';
        metaInfo.textContent = `Point ${current+1} / ${N}`;
        noteArea.focus();
      }

      // ===== Events =====
      noteArea.addEventListener('input', ()=>{
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(()=>{ notes[current] = noteArea.value; saveStorage(); }, 2000);
      });
      document.getElementById('save').addEventListener('click', ()=>{ notes[current]=noteArea.value; saveStorage(); });
      document.getElementById('clear').addEventListener('click', ()=>{ if(confirm('Vider le contenu local ?')) clearStorage(); });
      document.getElementById('print').addEventListener('click', ()=>{ notes[current]=noteArea.value; saveStorage(); window.print(); });
      document.getElementById('y').textContent = new Date().getFullYear();

      refInput.addEventListener('input', ()=>{ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveStorage, 800); });
      titreInput.addEventListener('input', ()=>{ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveStorage, 800); });

      bookSelect.addEventListener('change', renderChapters);

      validateBtn.addEventListener('click', async ()=>{
        const book = bookSelect.value;
        const chap = chapterSelect.value;
        const ver  = versionSelect.value;
        // Met √† jour R√©f√©rence + Titre si vide
        if (!refInput.value.trim()) refInput.value = `${book} ${chap}`;
        if (!titreInput.value.trim()) titreInput.value = `${book} ${chap} (${ver})`;
        // M√©morise "Dernier"
        localStorage.setItem(KEY_LAST, JSON.stringify({book, chapter: chap, version: ver}));
        lastStudy.textContent = `Dernier : ${book} ${chap} (${ver})`;
        // (Plus tard: d√©clencher g√©n√©ration auto des 28 points ici)
        await fakePrep(); // animation barre de progression (placeholder)
        // Assure l‚ÄôUI des 28 points pr√™te
        renderSidebar(); select(0);
        saveStorage();
      });

      prevBtn.addEventListener('click', ()=> select( (current-1+N)%N ));
      nextBtn.addEventListener('click', ()=> select( (current+1)%N ));

      // ===== Init =====
      const { last } = loadStorage();
      renderBooks();
      // S√©lection initiale (dernier ou d√©faut)
      if (last.book){
        const idx = BOOKS.findIndex(([n])=> n===last.book);
        if (idx>=0) bookSelect.selectedIndex = idx;
      }
      renderChapters();
      if (last.chapter){
        const cIdx = Math.max(0, Math.min(chapterSelect.options.length-1, Number(last.chapter)-1));
        chapterSelect.selectedIndex = cIdx;
      }
      if (last.version){ versionSelect.value = last.version; }
      renderSidebar(); select(0);

      // ===== Debug discret (footer) =====
      const btn = document.getElementById('debugBtn');
      const panel = document.getElementById('debugPanel');
      const dotHealth = document.getElementById('dot-health');
      const dotChat = document.getElementById('dot-chat');
      const dotPing = document.getElementById('dot-ping');

      function setMini(dot, ok){
        dot.classList.remove('ok','ko');
        if (ok===true) dot.classList.add('ok'); else if (ok===false) dot.classList.add('ko');
      }
      function log(msg){
        const line = '['+new Date().toISOString()+'] '+msg;
        panel.textContent += (panel.textContent ? '\n' : '') + line;
        console.log(line);
      }
      async function ping(path, options){
        try{
          const c = new AbortController(); const t=setTimeout(()=>c.abort(),2500);
          const r = await fetch(path,{...(options||{}),signal:c.signal}); clearTimeout(t); return r;
        }catch(e){ return {ok:false,status:0,error:String(e)}; }
      }
      async function runChecks(){
        setMini(dotHealth, undefined); setMini(dotChat, undefined); setMini(dotPing, undefined);
        const r1 = await ping('/api/health'); setMini(dotHealth, !!(r1&&r1.ok)); log((r1&&r1.ok?'OK':'KO')+' /api/health ‚Üí '+(r1.status||0));
        const r2 = await ping('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({probe:true})}); setMini(dotChat, !!(r2&&r2.ok)); log((r2&&r2.ok?'OK':'KO')+' /api/chat (POST) ‚Üí '+(r2.status||0));
        const r3 = await ping('/api/ping'); setMini(dotPing, !!(r3&&r3.ok)); log((r3&&r3.ok?'OK':'KO')+' /api/ping ‚Üí '+(r3.status||0));
      }
      btn.addEventListener('click', ()=>{
        const open = panel.style.display==='block';
        if(open){ panel.style.display='none'; btn.textContent='Debug'; }
        else{ panel.style.display='block'; btn.textContent='Fermer Debug'; panel.textContent='[Debug d√©marr√©‚Ä¶]'; runChecks(); }
      });
    })();
  </script>
</body>
</html>
