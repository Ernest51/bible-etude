/* bible-buttons.js
   - "Valider" OUVRE BibleGateway selon le livre + chapitre sélectionnés.
   - "Lire la Bible" fait la même chose (raccourci).
   - Compatible avec l'ancre cachée #readLink si un ancien code l'utilise.
*/

(function () {
  function $(sel) { return document.querySelector(sel); }

  // Récupération robuste des champs existants dans ton index
  function getBook() {
    const el = $('#bookSelect') || $('#book') || document.querySelector('select[title="Livre"]');
    return (el && el.value) ? el.value.trim() : '';
  }
  function getChapter() {
    const el = $('#chapterSelect') || $('#chapter') || document.querySelector('select[title="Chapitre"], input[title="Chapitre"]');
    const v = el && (el.value || el.textContent) ? String(el.value || el.textContent).trim() : '';
    return (/^\d+$/.test(v) && parseInt(v,10) > 0) ? v : '1';
  }
  function getSearchRef() {
    const el = $('#searchRef');
    return el && el.value ? el.value.trim() : '';
  }
  function getVersion() {
    const el = $('#versionSelect');
    return el && el.value ? el.value : 'LSG';
  }

  function toGatewayURLFromPieces(book, chap, version) {
    const q = encodeURIComponent(`${book} ${chap}`);
    return `https://www.biblegateway.com/passage/?search=${q}&version=${encodeURIComponent(version||'LSG')}`;
  }

  // Support "searchRef" si l’utilisateur tape directement "Jean 3:16" par exemple
  function parseRefFromSearchRef(s) {
    // Très simple : "Livre chap[:vers]" => on garde Livre + chap
    // On ne bloque pas si le format est inattendu : on retourne null
    const m = s.match(/^(.+?)\s+(\d+)(?::\d+)?\s*$/i);
    if (!m) return null;
    return { book: m[1].trim(), chap: m[2].trim() };
  }

  function openBibleGateway() {
    const version = getVersion();
    const typed = getSearchRef();
    let book = getBook();
    let chap = getChapter();

    if (typed) {
      const ref = parseRefFromSearchRef(typed);
      if (ref) { book = ref.book; chap = ref.chap; }
    }
    if (!book) { book = 'Genèse'; }
    if (!chap) { chap = '1'; }

    const url = toGatewayURLFromPieces(book, chap, version);

    // Compat rétro : clique sur #readLink s'il existe
    const a = $('#readLink');
    if (a) {
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.click();
      return;
    }
    window.open(url, '_blank', 'noopener');
  }

  function bind() {
    const validateBtn = $('#validate');
    const readBtn = $('#readBtn');
    if (validateBtn) validateBtn.addEventListener('click', openBibleGateway);
    if (readBtn) readBtn.addEventListener('click', openBibleGateway);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
