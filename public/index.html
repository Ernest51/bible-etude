<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Étude — 28 points</title>
  <meta name="description" content="Étude biblique — 28 rubriques personnalisées, recherche livre/chapitre/verset, sauvegarde locale." />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    :root{
      --bg:#f5f6f8; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --link:#2563eb;
      --border:#e5e7eb; --green:#16a34a; --red:#dc2626; --amber:#d97706; --dark:#111827;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    /* Barre de progression */
    .progress-wrap{position:sticky;top:0;z-index:20;background:transparent}
    .progress{height:4px;background:#e5e7eb}
    .progress>.bar{height:100%;width:0;background:linear-gradient(90deg,#2563eb,#16a34a);transition:width .2s ease}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:12px 18px;position:sticky;top:4px;z-index:10}
    h1{margin:0;font-size:22px}
    main{max-width:1200px;margin:18px auto;padding:0 14px}

    /* Barre de contrôle */
    .controls{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto auto auto;gap:10px;margin:12px 0}
    @media (max-width:1100px){ .controls{grid-template-columns:1fr 1fr 1fr 1fr 1fr; } .controls .wide{grid-column:1/-1} }
    input[type="text"], select{border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%}
    .btn{background:var(--dark);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;white-space:nowrap}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .btn.warn{background:#f59e0b}
    .small{font-size:12px;color:var(--muted);align-self:center}

    .layout{display:grid;grid-template-columns:320px 1fr;gap:12px}
    @media (max-width:1000px){ .layout{grid-template-columns:1fr} }

    /* Sidebar (rubriques) */
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .side-head{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
    .list{max-height:70vh;overflow:auto}
    .item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:last-child{border-bottom:0}
    .item:hover{background:#f8fafc}
    .item.active{background:#eef2ff}
    .idx{min-width:24px;height:24px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#fff}
    .dot{width:8px;height:8px;border-radius:999px;background:#eab308;margin-left:auto}
    .dot.ok{background:var(--green)}
    .desc{display:block;font-size:12px;color:var(--muted);margin-top:2px}

    /* Éditeur */
    .editor{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;min-height:60vh;display:flex;flex-direction:column}
    .ed-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .ed-title{font-weight:700;flex:1}
    .ed-body{padding:12px}
    textarea{width:100%;min-height:420px;resize:vertical;border:1px solid var(--border);border-radius:10px;padding:12px}
    .ed-foot{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}
    .navbtn{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    footer{max-width:1200px;margin:22px auto 26px;padding:0 14px;color:var(--muted);font-size:14px}

    /* Debug footer */
    #debugBtn{margin-top:8px;background:#111827;color:#fff;border:0;border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer}
    #debugPanel{display:none;margin-top:8px;background:#0b1020;color:#e2e8f0;border:1px solid #1f2a44;border-radius:8px;padding:8px;max-height:240px;overflow:auto;white-space:pre-wrap;font-size:12px}
    .status-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;font-size:12px;color:#111}
    .mini{width:8px;height:8px;border-radius:999px;background:#d97706}
    .mini.ok{background:var(--green)} .mini.ko{background:var(--red)}

    @media print{ .progress-wrap, header, .controls, .sidebar, .ed-foot, footer .status-row, #debugPanel { display:none !important; } textarea{min-height:unset} }
  </style>
</head>
<body>
  <!-- Barre de progression -->
  <div class="progress-wrap">
    <div class="progress"><div id="progressBar" class="bar" style="width:0%"></div></div>
  </div>
  <header><h1>Bible Étude — 28 points</h1></header>

  <main>
    <!-- Barre de contrôle -->
    <div class="controls">
      <input id="searchRef" class="wide" type="text" placeholder="Rechercher (ex : Marc 5:1, 1 Jean 2, Genèse 1:1-5)" />
      <select id="bookSelect" title="Livre"></select>
      <select id="chapterSelect" title="Chapitre"></select>
      <select id="verseSelect" title="Verset"></select>
      <select id="versionSelect" title="Version">
        <option value="PDV" selected>Parole de Vie (PDV)</option>
        <option value="LSG">Louis Segond 1910 (LSG)</option>
        <option value="S21">Segond 21 (S21)</option>
        <option value="BFC">Français Courant (BFC)</option>
      </select>

      <!-- Bouton Valider = BibleGateway uniquement -->
      <button id="validate" class="btn" type="button">Valider</button>

      <!-- NOUVEAU bouton Générer = appelle /api/chat -->
      <button id="generateBtn" class="btn warn" type="button">Générer</button>

      <a id="readLink" class="btn secondary" href="#" target="_blank" rel="noopener">Lire la Bible</a>
      <span id="lastStudy" class="small">Dernier : —</span>
    </div>

    <div class="layout">
      <!-- Colonne gauche : rubriques -->
      <aside class="sidebar">
        <div class="side-head">Rubriques (28)</div>
        <div id="pointsList" class="list"></div>
      </aside>

      <!-- Colonne centrale : éditeur -->
      <section class="editor">
        <div class="ed-head">
          <div class="ed-title" id="edTitle">—</div>
          <button id="prev" class="navbtn" type="button">◀ Précédent</button>
          <button id="next" class="navbtn" type="button">Suivant ▶</button>
        </div>
        <div class="ed-body">
          <textarea id="noteArea" placeholder="Écris ici…"></textarea>
        </div>
        <div class="ed-foot">
          <span class="small" id="metaInfo">Point — / 28</span>
          <span class="small">Sauvegarde auto (2s) après saisie.</span>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer + debug -->
  <footer>
    © <span id="y"></span> Bible Étude
    <div class="status-row" aria-label="Statut API">
      <span class="badge"><span id="dot-health" class="mini" aria-hidden="true"></span> health</span>
      <span class="badge"><span id="dot-chat" class="mini" aria-hidden="true"></span> chat(POST)</span>
      <span class="badge"><span id="dot-ping" class="mini" aria-hidden="true"></span> ping</span>
      <button id="debugBtn" title="Ouvrir le panneau de debug" type="button">Debug</button>
    </div>
    <div id="debugPanel">[init]</div>
  </footer>

  <script>
    (function(){
      // ===== 66 livres (fr) + nb chapitres =====
      const BOOKS = [
        ["Genèse",50],["Exode",40],["Lévitique",27],["Nombres",36],["Deutéronome",34],
        ["Josué",24],["Juges",21],["Ruth",4],["1 Samuel",31],["2 Samuel",24],
        ["1 Rois",22],["2 Rois",25],["1 Chroniques",29],["2 Chroniques",36],["Esdras",10],
        ["Néhémie",13],["Esther",10],["Job",42],["Psaumes",150],["Proverbes",31],
        ["Ecclésiaste",12],["Cantique des cantiques",8],["Ésaïe",66],["Jérémie",52],["Lamentations",5],
        ["Ézéchiel",48],["Daniel",12],["Osée",14],["Joël",3],["Amos",9],
        ["Abdias",1],["Jonas",4],["Michée",7],["Nahoum",3],["Habacuc",3],
        ["Sophonie",3],["Aggée",2],["Zacharie",14],["Malachie",4],
        ["Matthieu",28],["Marc",16],["Luc",24],["Jean",21],["Actes",28],
        ["Romains",16],["1 Corinthiens",16],["2 Corinthiens",13],["Galates",6],["Éphésiens",6],
        ["Philippiens",4],["Colossiens",4],["1 Thessaloniciens",5],["2 Thessaloniciens",3],["1 Timothée",6],
        ["2 Timothée",4],["Tite",3],["Philémon",1],["Hébreux",13],["Jacques",5],
        ["1 Pierre",5],["2 Pierre",3],["1 Jean",5],["2 Jean",1],["3 Jean",1],
        ["Jude",1],["Apocalypse",22]
      ];

      // Alias pour la recherche (simplifiés)
      const ALIAS = {
        "gen":"Genèse","gene":"Genèse","genese":"Genèse","exo":"Exode","lev":"Lévitique","nom":"Nombres","nb":"Nombres","deut":"Deutéronome","deu":"Deutéronome",
        "jos":"Josué","jug":"Juges","rut":"Ruth","1sam":"1 Samuel","2sam":"2 Samuel","1sa":"1 Samuel","2sa":"2 Samuel",
        "1rois":"1 Rois","2rois":"2 Rois","1roi":"1 Rois","2roi":"2 Rois","1chr":"1 Chroniques","2chr":"2 Chroniques",
        "esd":"Esdras","neh":"Néhémie","est":"Esther","job":"Job","ps":"Psaumes","psa":"Psaumes","prov":"Proverbes","ecc":"Ecclésiaste","cant":"Cantique des cantiques",
        "esa":"Ésaïe","isa":"Ésaïe","jer":"Jérémie","lam":"Lamentations","ez":"Ézéchiel","eze":"Ézéchiel","dan":"Daniel","osee":"Osée","joel":"Joël","amos":"Amos",
        "abd":"Abdias","jon":"Jonas","mic":"Michée","nah":"Nahoum","hab":"Habacuc","soph":"Sophonie","agg":"Aggée","zac":"Zacharie","mal":"Malachie",
        "mat":"Matthieu","mt":"Matthieu","mar":"Marc","mc":"Marc","mr":"Marc","luc":"Luc","lc":"Luc","jean":"Jean","jn":"Jean","act":"Actes","rom":"Romains",
        "1cor":"1 Corinthiens","2cor":"2 Corinthiens","gal":"Galates","eph":"Éphésiens","phi":"Philippiens","col":"Colossiens",
        "1th":"1 Thessaloniciens","2th":"2 Thessaloniciens","1tim":"1 Timothée","2tim":"2 Timothée","tit":"Tite","phm":"Philémon","heb":"Hébreux",
        "jac":"Jacques","jacques":"Jacques","1pi":"1 Pierre","2pi":"2 Pierre","1jean":"1 Jean","2jean":"2 Jean","3jean":"3 Jean","jud":"Jude","apo":"Apocalypse","apoc":"Apocalypse","ap":"Apocalypse"
      };

      // 28 rubriques par défaut (écrasées par l’API)
      let RUBRIQUES = [
        { t:"Prière d’ouverture", d:"Invocation du Saint-Esprit pour éclairer l’étude." },
        { t:"Canon et testament", d:"Identification du livre selon le canon biblique." },
        { t:"Questions du chapitre précédent", d:"(Min. 5) Réponses intégrales, éléments de compréhension exigés." },
        { t:"Titre du chapitre", d:"Résumé doctrinal synthétique du chapitre étudié." },
        { t:"Contexte historique", d:"Période, géopolitique, culture, carte de l’époque." },
        { t:"Structure littéraire", d:"Séquençage narratif et composition interne." },
        { t:"Genre littéraire", d:"Narratif, poétique, prophétique, etc." },
        { t:"Auteur et généalogie", d:"Lien aux patriarches, éléments biographiques." },
        { t:"Verset-clé doctrinal", d:"Verset central du chapitre (lien cliquable)." },
        { t:"Analyse exégétique", d:"Commentaire mot-à-mot (grec/hébreu)." },
        { t:"Analyse lexicale", d:"Mots-clés originaux et sens doctrinal." },
        { t:"Références croisées", d:"Passages parallèles / complémentaires." },
        { t:"Fondements théologiques", d:"Doctrines majeures du chapitre." },
        { t:"Thème doctrinal", d:"Lien avec les 22 grands thèmes doctrinaux." },
        { t:"Fruits spirituels", d:"Vertus et attitudes inspirées par le chapitre." },
        { t:"Types bibliques", d:"Symboles / figures typologiques." },
        { t:"Appui doctrinal", d:"Autres passages qui renforcent l’enseignement." },
        { t:"Comparaison entre versets", d:"Mise en relief au sein du chapitre." },
        { t:"Comparaison avec Actes 2", d:"Parallèle avec le début de l’Église." },
        { t:"Verset à mémoriser", d:"Verset essentiel à retenir." },
        { t:"Enseignement pour l’Église", d:"Implications collectives / ecclésiales." },
        { t:"Enseignement pour la famille", d:"Valeurs à transmettre dans le foyer." },
        { t:"Enseignement pour enfants", d:"Approche simplifiée, jeux, récits, visuels." },
        { t:"Application missionnaire", d:"Comment le texte guide l’évangélisation." },
        { t:"Application pastorale", d:"Conseils pour ministres / enseignants." },
        { t:"Application personnelle", d:"Examen de conscience et engagement." },
        { t:"Versets à retenir", d:"Incontournables pour prédication pastorale." },
        { t:"Prière de fin", d:"Clôture spirituelle avec reconnaissance." }
      ];
      const N = RUBRIQUES.length;

      // Éléments
      const progressBar = document.getElementById('progressBar');
      const searchRef = document.getElementById('searchRef');
      const bookSelect = document.getElementById('bookSelect');
      const chapterSelect = document.getElementById('chapterSelect');
      const verseSelect = document.getElementById('verseSelect');
      const versionSelect = document.getElementById('versionSelect');
      const validateBtn = document.getElementById('validate');
      const generateBtn = document.getElementById('generateBtn');
      const readLink = document.getElementById('readLink');
      const lastStudy = document.getElementById('lastStudy');

      const pointsList = document.getElementById('pointsList');
      const edTitle = document.getElementById('edTitle');
      const noteArea = document.getElementById('noteArea');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const metaInfo = document.getElementById('metaInfo');

      const KEY_META='be_meta', KEY_NOTES='be_notes', KEY_LAST='be_last';
      let current=0, notes={};
      let autosaveTimer=null, autoTimer=null;

      function setProgress(p){ progressBar.style.width = Math.max(0,Math.min(100,p))+'%'; }
      async function fakePrep(){ setProgress(15); await wait(120); setProgress(55); await wait(120); setProgress(100); setTimeout(()=>setProgress(0),260); }
      function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }

      function renderBooks(){
        bookSelect.innerHTML='';
        BOOKS.forEach(([name,ch])=>{
          const o=document.createElement('option'); o.value=name; o.textContent=name; o.dataset.ch=ch; bookSelect.appendChild(o);
        });
      }
      function renderChapters(){
        chapterSelect.innerHTML='';
        const ch = bookSelect.selectedOptions[0] ? parseInt(bookSelect.selectedOptions[0].dataset.ch,10) : 1;
        for(let i=1;i<=ch;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); chapterSelect.appendChild(o); }
      }
      function renderVerses(max=60){
        verseSelect.innerHTML=''; const m=Math.max(1,Math.min(200,max));
        for(let i=1;i<=m;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); verseSelect.appendChild(o); }
      }
      function updateReadLink(){
        const ref = `${bookSelect.value} ${chapterSelect.value}:${verseSelect.value}`;
        const ver = versionSelect.value;
        const url = 'https://www.biblegateway.com/passage/?search=' + encodeURIComponent(ref) + '&version=' + encodeURIComponent(ver);
        readLink.href = url;
      }

      // ===== Helpers =====
      function norm(s){ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\./g,'').trim(); }
      function parseSearch(q){
        q = q.trim();
        const m = q.match(/^([\d]?\s*[A-Za-zÀ-ÿ'’\.\s]+)\s+(\d+)(?::(\d+))?/);
        if(!m) return null;
        let rawBook = norm(m[1].replace(/\s+/g,' ').trim());
        rawBook = rawBook.replace(/\s+/g,'');
        let book = null;
        for (const [name] of BOOKS) { if (norm(name)===norm(m[1]).trim()) { book=name; break; } }
        if (!book && ALIAS[rawBook]) book = ALIAS[rawBook];
        if (!book){
          const cand = BOOKS.find(([name])=> norm(name).startsWith(norm(m[1]).trim()));
          if (cand) book=cand[0];
        }
        if (!book) return null;
        const chap = parseInt(m[2],10);
        const vers = m[3] ? parseInt(m[3],10) : null;
        return { book, chap, vers };
      }

      function applySelection(sel){
        if(!sel) return;
        const idx = BOOKS.findIndex(([n])=> n===sel.book);
        if (idx>=0) bookSelect.selectedIndex = idx;
        renderChapters();
        const chMax = bookSelect.selectedOptions[0] ? parseInt(bookSelect.selectedOptions[0].dataset.ch,10):1;
        const chap = Math.max(1, Math.min(chMax, sel.chap||1));
        chapterSelect.value = String(chap);
        renderVerses(sel.book==="Psaumes" ? 200 : 60);
        if (sel.vers){ verseSelect.value = String(sel.vers); }
        updateReadLink();
      }

      function buildReference(){ // champ libre prioritaire
        const typed = (searchRef.value || '').trim();
        if (typed) return typed;
        const b = bookSelect.value, c = chapterSelect.value, v = verseSelect.value;
        // auto-génération : Livre + Chapitre suffisent
        return c ? `${b} ${c}` : b;
      }

      function applyStudyFromApi(sections, reference){
        if (!Array.isArray(sections) || sections.length === 0) return false;
        RUBRIQUES = sections.slice(0,28).map((s,i)=>({
          t: String(s.title || `Point ${i+1}`),
          d: Array.isArray(s.verses) ? s.verses.join(' · ') : String(reference || '')
        }));
        notes = {};
        sections.slice(0,28).forEach((s,i)=>{ notes[i] = String(s.content || ''); });
        return true;
      }

      function renderSidebar(){
        pointsList.innerHTML='';
        RUBRIQUES.forEach((r,i)=>{
          const row=document.createElement('div');
          row.className='item'+(i===current?' active':'' );
          row.dataset.idx=i;
          row.innerHTML = `<span class="idx">${i+1}</span><div><div>${r.t}</div><span class="desc">${r.d||''}</span></div><span class="dot ${notes[i]&&notes[i].trim()?'ok':''}"></span>`;
          row.addEventListener('click', ()=>{ if(current!==i) select(i); });
          pointsList.appendChild(row);
        });
      }
      function renderSidebarDots(){
        document.querySelectorAll('.list .item').forEach(el=>{
          const i=Number(el.dataset.idx), dot=el.querySelector('.dot');
          if(!dot) return;
          if (notes[i] && notes[i].trim()) dot.classList.add('ok'); else dot.classList.remove('ok');
        });
      }
      function select(i){
        notes[current]=noteArea.value;
        saveStorage();
        current=i;
        document.querySelectorAll('.list .item').forEach(el=> el.classList.toggle('active', Number(el.dataset.idx)===current));
        edTitle.textContent = `${i+1}. ${RUBRIQUES[i].t}`;
        noteArea.value = notes[i] || '';
        metaInfo.textContent = `Point ${i+1} / ${N}`;
        noteArea.focus();
      }

      function saveStorage(){
        try{
          const meta = JSON.parse(localStorage.getItem(KEY_META)||'{}');
          localStorage.setItem(KEY_META, JSON.stringify({
            ref: meta.ref || '', titre: meta.titre || ''
          }));
          localStorage.setItem(KEY_NOTES, JSON.stringify(notes));
          renderSidebarDots();
        }catch{}
      }

      // ===== Initialisation UI
      document.getElementById('y').textContent = new Date().getFullYear();
      renderBooks(); renderChapters(); renderVerses(); updateReadLink();
      renderSidebar(); select(0);

      // Recherche intelligente (input)
      searchRef.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          const sel=parseSearch(searchRef.value);
          if (sel){ applySelection(sel); autoGenerate(); }
        }
      });
      searchRef.addEventListener('blur', ()=>{
        const sel=parseSearch(searchRef.value);
        if (sel){ applySelection(sel); autoGenerate(); }
      });

      // ===== Bouton VALIDER → BibleGateway seulement
      validateBtn.addEventListener('click', ()=>{
        updateReadLink();
        // mémorise dernier consulté (BibleGateway)
        try {
          const book=bookSelect.value, chap=chapterSelect.value, vers=verseSelect.value, ver=versionSelect.value;
          localStorage.setItem(KEY_LAST, JSON.stringify({book, chapter:chap, verse:vers, version:ver}));
          lastStudy.textContent = `Dernier : ${book} ${chap||1} (${ver})`;
        } catch {}
        window.open(readLink.href, '_blank', 'noopener');
      });

      // ===== Bouton GÉNÉRER → appelle /api/chat et remplit l’étude
      generateBtn.addEventListener('click', async ()=>{ await generateStudy(); });

      // ===== Auto-génération : dès qu’on a Livre + Chapitre
      function autoGenerate(){
        clearTimeout(autoTimer);
        autoTimer = setTimeout(async ()=>{
          const hasBook = !!bookSelect.value;
          const hasChapter = !!chapterSelect.value;
          const typed = (searchRef.value||'').trim();
          if ((hasBook && hasChapter) && !typed) { // si l’utilisateur n’a pas forcé une saisie libre
            await generateStudy();
          }
        }, 300);
      }
      bookSelect.addEventListener('change', ()=>{ renderChapters(); renderVerses(bookSelect.value==="Psaumes"?200:60); updateReadLink(); autoGenerate(); });
      chapterSelect.addEventListener('change', ()=>{ updateReadLink(); autoGenerate(); });
      verseSelect.addEventListener('change', ()=>{ updateReadLink(); });

      // Navigation points
      prevBtn.addEventListener('click', ()=> select((current-1+N)%N));
      nextBtn.addEventListener('click', ()=> select((current+1)%N));

      // Autosave notes
      noteArea.addEventListener('input', ()=>{
        clearTimeout(autosaveTimer);
        autosaveTimer=setTimeout(()=>{ notes[current]=noteArea.value; saveStorage(); }, 2000);
      });

      // Charger “dernier étudié” (sélection UI, pas génération auto)
      (function(){
        try{
          const last=JSON.parse(localStorage.getItem(KEY_LAST)||'{}');
          if(last.book){
            applySelection({book:last.book, chap:Number(last.chapter)||1, vers:Number(last.verse)||1});
            versionSelect.value = last.version || versionSelect.value;
            lastStudy.textContent = `Dernier : ${last.book} ${last.chapter||1} (${last.version||versionSelect.value})`;
          }
        }catch{}
      })();

      // Lien lecture initial
      updateReadLink();

      // ===== Debug discret (footer)
      const btnDbg = document.getElementById('debugBtn');
      const panel = document.getElementById('debugPanel');
      const dotHealth = document.getElementById('dot-health');
      const dotChat = document.getElementById('dot-chat');
      const dotPing = document.getElementById('dot-ping');

      function setMini(dot, ok){ dot.classList.remove('ok','ko'); if(ok===true) dot.classList.add('ok'); else if(ok===false) dot.classList.add('ko'); }
      function log(msg){ const line='['+new Date().toISOString()+'] '+msg; panel.textContent += (panel.textContent?'\n':'')+line; console.log(line); }
      async function ping(path, options){ try{ const c=new AbortController(); const t=setTimeout(()=>c.abort(),2500); const r=await fetch(path,{...(options||{}),signal:c.signal}); clearTimeout(t); return r; }catch(e){ return {ok:false,status:0,error:String(e)}; } }
      async function runChecks(){
        setMini(dotHealth,undefined); setMini(dotChat,undefined); setMini(dotPing,undefined);
        const r1=await ping('/api/health'); setMini(dotHealth,!!(r1&&r1.ok)); log((r1&&r1.ok?'OK':'KO')+' /api/health → '+(r1.status||0));
        const r2=await ping('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({probe:true})}); setMini(dotChat,!!(r2&&r2.ok)); log((r2&&r2.ok?'OK':'KO')+' /api/chat (POST) → '+(r2.status||0));
        const r3=await ping('/api/ping'); setMini(dotPing,!!(r3&&r3.ok)); log((r3&&r3.ok?'OK':'KO')+' /api/ping → '+(r3.status||0));
      }
      btnDbg.addEventListener('click', ()=>{ const open=panel.style.display==='block'; if(open){ panel.style.display='none'; btnDbg.textContent='Debug'; } else { panel.style.display='block'; btnDbg.textContent='Fermer Debug'; panel.textContent='[Debug démarré…]'; runChecks(); } });

      // ===== Génération (fonction principale)
      async function generateStudy(){
        const ref = buildReference();
        if (!ref) { alert("Choisis un Livre + Chapitre (ou saisis une référence ex: Marc 5:1-20)"); return; }

        await fakePrep(); // petite animation en haut

        // Appel API (GET)
        let payload = null, resp = null;
        try {
          const url = `/api/chat?q=${encodeURIComponent(ref)}&templateId=v28-standard`;
          resp = await fetch(url, { method: 'GET' });
          try { payload = await resp.json(); } catch { payload = { ok:false, error:'Réponse non JSON' }; }
        } catch (e) {
          payload = { ok:false, error: 'Erreur réseau: '+(e?.message || e) };
        }

        if (!resp || !resp.ok || !payload?.ok) {
          if (panel) {
            panel.style.display = 'block'; btnDbg.textContent = 'Fermer Debug';
            panel.textContent += `\n[API KO] /api/chat → ${(resp && resp.status) || 0}\n` + JSON.stringify(payload, null, 2);
          }
          alert(payload?.error || `Erreur HTTP ${resp ? resp.status : 0}`);
          return;
        }

        const data = payload.data || payload;
        const ok = applyStudyFromApi(data.sections || [], data.reference || ref);
        if (!ok) { alert("Réponse API inattendue (sections manquantes)"); return; }

        // Mémoriser “dernier étudié”
        try {
          const book=bookSelect.value, chap=chapterSelect.value, vers=verseSelect.value, ver=versionSelect.value;
          localStorage.setItem(KEY_LAST, JSON.stringify({book, chapter:chap, verse:vers, version:ver}));
          lastStudy.textContent = `Dernier : ${data.reference || `${book} ${chap}`} (${ver})`;
        } catch {}

        // Rafraîchir l’UI avec les 28 rubriques + notes préremplies
        renderSidebar(); select(0);
      }
    })();
  </script>
  <!-- Aucun script externe pour éviter les conflits -->
</body>
</html>
