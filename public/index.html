<!doctype html>
<html lang="fr" data-theme="cyan">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Étude Biblique — Méditation</title>

  <!-- (Optionnel) ta feuille Tailwind si tu l’utilises -->
  <link rel="stylesheet" href="/dist/output.css" />

  <style>
    :root { --brand:#06b6d4; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --border:#e5e7eb; }
    body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--ink); background:#f8fafc; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px 16px 64px; }
    header { padding: 14px 0; background: #fff; border-bottom: 1px solid var(--border); }
    header .brand { display:flex; align-items:center; gap:10px; font-weight:700; color: var(--ink); }
    header .brand .dot { width:10px; height:10px; border-radius:50%; background:var(--brand); display:inline-block; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .btn { background:var(--brand); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    input, select { border:1px solid var(--border); border-radius:8px; padding:8px 10px; }
    .stack { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .muted { color:var(--muted); font-size:12px; }
  </style>
</head>

<body>
  <!-- Barre -->
  <header>
    <div class="container">
      <div class="brand">
        <span class="dot"></span>
        <span>Étude Biblique — Méditation</span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- ======== TON APP EXISTANTE ======== -->
    <section class="card" style="margin-bottom:16px">
      <h2 style="margin:0 0 10px">Application</h2>
      <div id="app"></div>
    </section>

    <!-- Scripts de ton app (inchangés) -->
    <script defer src="/app-loader.js"></script>
    <script defer src="/app.js"></script>

    <!-- ======== CONTROLS (Option A) ======== -->
    <section class="card" style="margin-top:16px">
      <h2 style="margin:0 0 12px">Sélection</h2>
      <div class="stack" style="margin-bottom:8px">
        <!-- Livre -->
        <select data-field="book" aria-label="Livre">
          <option value="">— Livre —</option>
          <!-- AT (extraits, complète si tu veux) -->
          <option>Genèse</option><option>Exode</option><option>Lévitique</option>
          <option>Nombres</option><option>Deutéronome</option>
          <option>Josué</option><option>Juges</option><option>Ruth</option>
          <option>1 Samuel</option><option>2 Samuel</option>
          <option>1 Rois</option><option>2 Rois</option>
          <option>1 Chroniques</option><option>2 Chroniques</option>
          <option>Esdras</option><option>Néhémie</option><option>Esther</option>
          <option>Job</option><option>Psaumes</option><option>Proverbes</option>
          <option>Ecclésiaste</option><option>Cantique des cantiques</option>
          <option>Ésaïe</option><option>Jérémie</option><option>Lamentations</option>
          <option>Ézéchiel</option><option>Daniel</option>
          <option>Osée</option><option>Joël</option><option>Amos</option><option>Abdias</option>
          <option>Jonas</option><option>Michée</option><option>Nahoum</option>
          <option>Habacuc</option><option>Sophonie</option><option>Aggée</option>
          <option>Zacharie</option><option>Malachie</option>
          <!-- NT -->
          <option>Matthieu</option><option>Marc</option><option>Luc</option><option>Jean</option>
          <option>Actes</option><option>Romains</option>
          <option>1 Corinthiens</option><option>2 Corinthiens</option>
          <option>Galates</option><option>Éphésiens</option><option>Philippiens</option>
          <option>Colossiens</option>
          <option>1 Thessaloniciens</option><option>2 Thessaloniciens</option>
          <option>1 Timothée</option><option>2 Timothée</option>
          <option>Tite</option><option>Philémon</option><option>Hébreux</option>
          <option>Jacques</option>
          <option>1 Pierre</option><option>2 Pierre</option>
          <option>1 Jean</option><option>2 Jean</option><option>3 Jean</option>
          <option>Jude</option><option>Apocalypse</option>
        </select>

        <!-- Chapitre -->
        <select data-field="chapter" aria-label="Chapitre" style="width:140px">
          <option value="">— Chapitre —</option>
          <!-- 1..150 -->
          <script>
            // Remplit 1..150 côté client pour rester statique côté fichier
            document.currentScript.insertAdjacentHTML(
              'beforebegin',
              Array.from({length:150}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')
            );
          </script>
        </select>

        <!-- Versets (optionnel) -->
        <input data-field="verses" placeholder="Versets (ex : 1-3,7)" style="width:180px" />
        <button id="btn-read" class="btn">Lire la Bible</button>
        <span id="sel-status" class="muted"></span>
      </div>
    </section>

    <!-- ======== WIDGET EXPLICATION (autonome) ======== -->
    <section class="card" id="explain-widget" style="margin-top:16px">
      <h2 style="margin:0 0 12px">Lecture + Explication</h2>
      <div id="x-out"></div>
    </section>

    <!-- JS du widget + API publique -->
    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const out = $("#x-out");

        function card(html) {
          return `<div style="border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;margin:10px 0;background:#fff">${html}</div>`;
        }

        function renderExplain(data) {
          const { reference, items } = data;
          const head = `<h3 style="margin:6px 0 10px;color:#0e7490">${reference}</h3>`;
          const blocks = items.map((it) => {
            const verse = it.v ? `<div style="font-weight:700;color:#334155">v.${it.v}</div>` : "";
            return card(`
              ${verse}
              <p style="margin:6px 0 10px;color:#111827">${it.text}</p>
              <div class="explain-html" style="color:#1f2937">${it.html}</div>
            `);
          }).join("");
          out.innerHTML = head + blocks;
        }

        async function runExplain({ book, chapter, verse }) {
          out.innerHTML = card(`<p class="muted">Chargement…</p>`);
          try {
            const qs = new URLSearchParams({ book, chapter, verse });
            const r = await fetch(`/api/explain?${qs.toString()}`);
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            if (!j.ok) throw new Error(j.error || "Erreur inconnue");
            renderExplain(j.data);
          } catch (e) {
            out.innerHTML = card(`<p style="color:#b91c1c"><strong>Oops :</strong> ${String(e.message || e)}</p>`);
          }
        }

        // API publique pour ton app existante
        window.renderMeditationExplain = (book, chapter, verse = "") =>
          runExplain({ book, chapter, verse });
      })();
    </script>

    <!-- ======== BRIDGE Option A (relie tes sélecteurs au bouton) ======== -->
    <script>
      (function () {
        const $ = (s, r=document) => r.querySelector(s);
        const status = $('#sel-status');

        function getVal(sel){
          const el = $(sel);
          return el ? (el.value || el.textContent || "").trim() : "";
        }

        function getInputs(){
          const book    = getVal('[data-field="book"]');
          const chapter = getVal('[data-field="chapter"]');
          const verse   = getVal('[data-field="verses"]'); // optionnel
          return { book, chapter, verse };
        }

        function run(){
          const { book, chapter, verse } = getInputs();
          if (!book || !chapter) {
            status.textContent = "Livre et chapitre requis.";
            return;
          }
          status.textContent = "";
          if (typeof window.renderMeditationExplain !== "function") {
            status.textContent = "Composant d'explication indisponible.";
            return;
          }
          window.renderMeditationExplain(book, chapter, verse || "");
        }

        // Bouton principal
        $('#btn-read')?.addEventListener('click', run);

        // UX: Enter dans le champ versets
        document.querySelector('[data-field="verses"]')?.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter') run();
        });
      })();
    </script>
  </main>
</body>
</html>
