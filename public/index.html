<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible √âtude ‚Äî 28 points</title>
  <meta name="description" content="Interface d'√©tude biblique ‚Äî colonne 28 points + √©diteur central, sauvegarde locale." />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    :root{
      --bg:#f5f6f8; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --link:#2563eb;
      --border:#e5e7eb; --green:#16a34a; --red:#dc2626; --amber:#d97706;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:16px 18px;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:26px}
    main{max-width:1200px;margin:18px auto;padding:0 14px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 12px}
    input[type="text"]{border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .grow{flex:1 1 260px;min-width:240px}
    .btn{background:#111827;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:#111;border:1px solid var(--border)}
    .btn.warn{background:#f59e0b}
    .saved{font-size:12px;color:var(--muted);align-self:center}
    .layout{display:grid;grid-template-columns:280px 1fr;gap:12px}
    @media (max-width:1000px){ .layout{grid-template-columns:1fr} }
    /* Sidebar */
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .side-head{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:700}
    .list{max-height:70vh;overflow:auto}
    .item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:last-child{border-bottom:0}
    .item:hover{background:#f8fafc}
    .item.active{background:#eef2ff}
    .idx{min-width:22px;height:22px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#fff}
    .dot{width:8px;height:8px;border-radius:999px;background:#eab308;margin-left:auto}
    .dot.ok{background:var(--green)}
    /* Editor */
    .editor{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden;min-height:60vh;display:flex;flex-direction:column}
    .ed-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .ed-title{font-weight:700;flex:1}
    .ed-body{padding:12px}
    textarea{width:100%;min-height:380px;resize:vertical;border:1px solid var(--border);border-radius:10px;padding:12px}
    .ed-foot{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}
    .navbtn{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    .muted{color:var(--muted)}
    footer{max-width:1200px;margin:22px auto 26px;padding:0 14px;color:var(--muted);font-size:14px}
    /* Debug footer (discret) */
    #debugBtn{margin-top:8px;background:#111827;color:#fff;border:0;border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer}
    #debugPanel{display:none;margin-top:8px;background:#0b1020;color:#e2e8f0;border:1px solid #1f2a44;border-radius:8px;padding:8px;max-height:240px;overflow:auto;white-space:pre-wrap;font-size:12px}
    .status-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 8px;font-size:12px;color:#111}
    .mini{width:8px;height:8px;border-radius:999px;background:#d97706}
    .mini.ok{background:var(--green)} .mini.ko{background:var(--red)}
    @media print{ header, .toolbar, .sidebar, .ed-foot, footer .status-row, #debugPanel { display:none !important; } textarea{min-height:unset} }
  </style>
</head>
<body>
  <header><h1>Bible √âtude ‚Äî 28 points</h1></header>

  <main>
    <!-- Toolbar -->
    <div class="toolbar">
      <input id="refInput" class="grow" type="text" placeholder="R√©f√©rence (ex : Gen√®se 1:1-5)" />
      <input id="titreInput" class="grow" type="text" placeholder="Titre de l‚Äô√©tude (ex : Cr√©ation ‚Äî Gen√®se 1)" />
      <button id="save" class="btn">üíæ Sauvegarder</button>
      <button id="clear" class="btn secondary">üßπ Vider</button>
      <button id="print" class="btn warn">üñ®Ô∏è Imprimer / PDF</button>
      <span id="savedBadge" class="saved">‚Äî</span>
    </div>

    <div class="layout">
      <!-- Colonne gauche : 28 points -->
      <aside class="sidebar">
        <div class="side-head">Plan d‚Äô√©tude (28)</div>
        <div id="pointsList" class="list"></div>
      </aside>

      <!-- Colonne centrale : √©diteur -->
      <section class="editor">
        <div class="ed-head">
          <div class="ed-title" id="edTitle">‚Äî</div>
          <button id="prev" class="navbtn">‚óÄ Pr√©c√©dent</button>
          <button id="next" class="navbtn">Suivant ‚ñ∂</button>
        </div>
        <div class="ed-body">
          <textarea id="noteArea" placeholder="√âcris ici‚Ä¶"></textarea>
        </div>
        <div class="ed-foot">
          <span class="muted" id="metaInfo">Point ‚Äî / 28</span>
          <span class="muted">Astuce : sauvegarde auto toutes les 2s apr√®s saisie.</span>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer + debug discret -->
  <footer>
    ¬© <span id="y"></span> Bible √âtude
    <div class="status-row" aria-label="Statut API">
      <span class="badge"><span id="dot-health" class="mini" aria-hidden="true"></span> health</span>
      <span class="badge"><span id="dot-chat" class="mini" aria-hidden="true"></span> chat(POST)</span>
      <span class="badge"><span id="dot-ping" class="mini" aria-hidden="true"></span> ping</span>
      <button id="debugBtn" title="Ouvrir le panneau de debug">Debug</button>
    </div>
    <div id="debugPanel">[init]</div>
  </footer>

  <script>
    (function(){
      // ===== Donn√©es & constantes =====
      const SECTIONS = [
        'Th√®me central / Titre','R√©f√©rence & contexte imm√©diat','Auteur / Date / Destinataires','Contexte historique & culturel',
        'Structure litt√©raire du passage','Id√©es cl√©s (bullet points)','Mots cl√©s & termes importants (h√©breu/grec)','Parall√®les bibliques',
        'Promesses / Commandements','V√©rit√©s doctrinales','Christ au centre (typologie, proph√©tie, accomplissement)','R√©v√©lation sur Dieu (attributs, ≈ìuvres)',
        'Condition humaine / p√©ch√© / gr√¢ce','Plan du salut (si applicable)','R√¥le du Saint-Esprit','Pistes d‚Äôinterpr√©tation (herm√©neutique)',
        'Erreurs d‚Äôinterpr√©tation (anti-mod√®les)','Questions de m√©ditation','Application personnelle','Application communautaire / √âglise',
        'Pri√®re de r√©ponse','Engagement concret (semaine)','T√©moignage / Partage','Versets √† m√©moriser',
        'Plan d‚Äô√©tude compl√©mentaire','R√©f√©rences de th√©ologiens / commentaires','Notes diverses','Synth√®se finale (une page)'
      ];
      const N = SECTIONS.length;

      // ===== √âl√©ments =====
      const refInput = document.getElementById('refInput');
      const titreInput = document.getElementById('titreInput');
      const pointsList = document.getElementById('pointsList');
      const edTitle = document.getElementById('edTitle');
      const noteArea = document.getElementById('noteArea');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const savedBadge = document.getElementById('savedBadge');
      const metaInfo = document.getElementById('metaInfo');

      // Storage keys
      const KEY_META = 'be_meta';
      const KEY_NOTES = 'be_notes';

      // √âtat
      let current = 0; // index du point s√©lectionn√©
      let notes = {}; // {index: text}
      let autosaveTimer = null;

      // ===== Helpers =====
      function fmtIndex(i){ return (i+1) + '. ' + SECTIONS[i]; }
      function loadStorage(){
        try{
          const meta = JSON.parse(localStorage.getItem(KEY_META)||'{}');
          const data = JSON.parse(localStorage.getItem(KEY_NOTES)||'{}');
          notes = data || {};
          if (meta.ref) refInput.value = meta.ref;
          if (meta.titre) titreInput.value = meta.titre;
        }catch{}
      }
      function saveStorage(){
        try{
          const meta = { ref: refInput.value.trim(), titre: titreInput.value.trim() };
          localStorage.setItem(KEY_META, JSON.stringify(meta));
          localStorage.setItem(KEY_NOTES, JSON.stringify(notes));
          showSaved('Sauvegard√©');
          renderSidebarDots();
        }catch{}
      }
      function showSaved(txt){
        savedBadge.textContent = txt + ' ‚úÖ ' + new Date().toLocaleTimeString();
        clearTimeout(showSaved._t);
        showSaved._t = setTimeout(()=>{ savedBadge.textContent='‚Äî'; }, 2000);
      }
      function renderSidebar(){
        pointsList.innerHTML = '';
        SECTIONS.forEach((label, i)=>{
          const row = document.createElement('div');
          row.className = 'item' + (i===current ? ' active' : '');
          row.dataset.idx = i;
          row.innerHTML = `
            <span class="idx">${i+1}</span>
            <span>${label}</span>
            <span class="dot ${notes[i] && notes[i].trim() ? 'ok':''}"></span>
          `;
          row.addEventListener('click', ()=>{
            if (current !== i) { select(i); }
          });
          pointsList.appendChild(row);
        });
      }
      function renderSidebarDots(){
        // Met √† jour uniquement les pastilles selon contenu
        document.querySelectorAll('.list .item').forEach(el=>{
          const i = Number(el.dataset.idx);
          const dot = el.querySelector('.dot');
          if (!dot) return;
          if (notes[i] && notes[i].trim()) dot.classList.add('ok'); else dot.classList.remove('ok');
        });
      }
      function select(i){
        // Sauvegarde le point courant avant de changer
        notes[current] = noteArea.value;
        saveStorage();

        current = i;
        document.querySelectorAll('.list .item').forEach(el=> el.classList.toggle('active', Number(el.dataset.idx)===current));
        edTitle.textContent = fmtIndex(current);
        noteArea.value = notes[current] || '';
        metaInfo.textContent = `Point ${current+1} / ${N}`;
        noteArea.focus();
      }

      // ===== Events =====
      noteArea.addEventListener('input', ()=>{
        // autosave 2s apr√®s saisie
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(()=>{
          notes[current] = noteArea.value;
          saveStorage();
        }, 2000);
      });

      refInput.addEventListener('input', ()=>{ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveStorage, 800); });
      titreInput.addEventListener('input', ()=>{ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveStorage, 800); });

      document.getElementById('save').addEventListener('click', ()=>{
        notes[current] = noteArea.value; saveStorage();
      });

      document.getElementById('clear').addEventListener('click', ()=>{
        if (!confirm('Vider le contenu local (r√©f√©rence, titre et notes) ?')) return;
        localStorage.removeItem(KEY_META);
        localStorage.removeItem(KEY_NOTES);
        refInput.value=''; titreInput.value='';
        notes = {}; renderSidebarDots();
        noteArea.value=''; showSaved('Vidage');
      });

      document.getElementById('print').addEventListener('click', ()=>{
        notes[current] = noteArea.value; saveStorage();
        window.print();
      });

      prevBtn.addEventListener('click', ()=> select( (current-1+N)%N ));
      nextBtn.addEventListener('click', ()=> select( (current+1)%N ));

      // ===== Init =====
      document.getElementById('y').textContent = new Date().getFullYear();
      loadStorage();
      renderSidebar();
      select(current);

      // ===== Debug discret (pied de page) =====
      const btn = document.getElementById('debugBtn');
      const panel = document.getElementById('debugPanel');
      const dotHealth = document.getElementById('dot-health');
      const dotChat = document.getElementById('dot-chat');
      const dotPing = document.getElementById('dot-ping');

      function setMini(dot, ok){
        dot.classList.remove('ok','ko');
        if (ok===true) dot.classList.add('ok'); else if (ok===false) dot.classList.add('ko');
      }
      function log(msg){
        const line = '['+new Date().toISOString()+'] '+msg;
        panel.textContent += (panel.textContent ? '\n' : '') + line;
        console.log(line);
      }
      async function ping(path, options){
        try{
          const c = new AbortController(); const t=setTimeout(()=>c.abort(),2500);
          const r = await fetch(path,{...(options||{}),signal:c.signal}); clearTimeout(t); return r;
        }catch(e){ return {ok:false,status:0,error:String(e)}; }
      }
      async function runChecks(){
        setMini(dotHealth, undefined); setMini(dotChat, undefined); setMini(dotPing, undefined);
        const r1 = await ping('/api/health'); setMini(dotHealth, !!(r1&&r1.ok)); log((r1&&r1.ok?'OK':'KO')+' /api/health ‚Üí '+(r1.status||0));
        const r2 = await ping('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({probe:true})}); setMini(dotChat, !!(r2&&r2.ok)); log((r2&&r2.ok?'OK':'KO')+' /api/chat (POST) ‚Üí '+(r2.status||0));
        const r3 = await ping('/api/ping'); setMini(dotPing, !!(r3&&r3.ok)); log((r3&&r3.ok?'OK':'KO')+' /api/ping ‚Üí '+(r3.status||0));
      }
      btn.addEventListener('click', ()=>{
        const open = panel.style.display==='block';
        if(open){ panel.style.display='none'; btn.textContent='Debug'; }
        else{ panel.style.display='block'; btn.textContent='Fermer Debug'; panel.textContent='[Debug d√©marr√©‚Ä¶]'; runChecks(); }
      });
    })();
  </script>
</body>
</html>
