<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bible Étude — Générateur (28 rubriques)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; padding: 24px; background: #0b0c10; color: #e6e6e6; }
    .app { max-width: 1100px; margin: 0 auto; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input, select, button { padding: 10px 12px; border-radius: 10px; border: 1px solid #2b2e34; background: #15171c; color: #e6e6e6; }
    button { cursor: pointer; }
    button.primary { background: #2e6ef7; border-color: #2e6ef7; }
    button.secondary { background: #20232b; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 18px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
    .card { background: #121318; border: 1px solid #262a31; border-radius: 14px; padding: 12px; }
    .title { display: flex; align-items: center; gap: 8px; font-weight: 600; }
    .diode { width: 10px; height: 10px; border-radius: 999px; background: #ffb020; /* orange par défaut */ box-shadow: 0 0 0 2px #1b1f27 inset; }
    .diode.green { background: #18c37e; }
    .muted { color: #9aa3b2; font-size: 12px; }
    textarea { width: 100%; min-height: 120px; background: #0f1116; color: #e6e6e6; border: 1px solid #262a31; border-radius: 10px; padding: 8px; }
    .footer { margin-top: 16px; font-size: 12px; color: #8a93a7; }
  </style>
</head>
<body>
  <div class="app">
    <h1>Bible Étude — Générateur 28 rubriques</h1>
    <div class="row" style="margin-bottom: 12px;">
      <label>Livre <input id="book" placeholder="Genèse" /></label>
      <label>Chapitre <input id="chapter" placeholder="1" /></label>
      <label>Densité
        <select id="density">
          <option value="500">500</option>
          <option value="1500" selected>1500</option>
          <option value="2500">2500</option>
        </select>
      </label>
      <button class="primary" id="btn-generate">Générer</button>
      <button class="secondary" id="btn-reset">Reset</button>
    </div>
    <div class="muted">Règles: appel POST /api/generate-study, options.length ∈ 500/1500/2500. Diodes vertes si contenu, Reset → toutes orange. Aucune CORS, même origine.</div>

    <div id="cards" class="grid"></div>

    <div class="footer">“Dernière étude” est mémorisée localement après génération et n’est pas effacée par Reset.</div>
  </div>

  <script>
    const cardsEl = document.getElementById('cards');
    const state = {
      book: '',
      chapter: '',
      density: 1500,
      sections: Array.from({ length: 28 }, (_, i) => ({ id: i + 1, title: `Rubrique ${i + 1}`, content: '' })),
    };

    const bookEl = document.getElementById('book');
    const chapterEl = document.getElementById('chapter');
    const densityEl = document.getElementById('density');
    const btnGen = document.getElementById('btn-generate');
    const btnReset = document.getElementById('btn-reset');

    function render() {
      cardsEl.innerHTML = '';
      state.sections.forEach((s) => {
        const card = document.createElement('div');
        card.className = 'card';
        const title = document.createElement('div');
        title.className = 'title';
        const diode = document.createElement('div');
        diode.className = 'diode' + (s.content && s.content.trim() ? ' green' : '');
        const tspan = document.createElement('span');
        tspan.textContent = `${s.id}. ${s.title}`;
        title.appendChild(diode);
        title.appendChild(tspan);
        const ta = document.createElement('textarea');
        ta.value = s.content || '';
        ta.addEventListener('input', (e) => {
          s.content = e.target.value;
          diode.className = 'diode' + (s.content && s.content.trim() ? ' green' : '');
        });
        card.appendChild(title);
        card.appendChild(ta);
        cardsEl.appendChild(card);
      });
    }

    function resetUI() {
      state.sections = state.sections.map(s => ({ ...s, content: '' }));
      render(); // diodes reviennent à orange
      bookEl.value = '';
      chapterEl.value = '';
      densityEl.value = '1500';
    }

    async function onGenerate() {
      const book = (bookEl.value || 'Genèse').trim();
      const chapter = (chapterEl.value || '1').trim();
      const density = Number(densityEl.value);
      const passage = `${book} ${chapter}`;

      try {
        const r = await fetch('/api/generate-study', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ passage, options: { length: density } })
        });
        const data = await r.json();
        const sections = (data && data.study && Array.isArray(data.study.sections)) ? data.study.sections : [];
        if (sections.length === 28) {
          state.sections = sections.map(s => ({ id: s.id, title: s.title || `Rubrique ${s.id}`, content: s.content || '' }));
          render();
          // Mémorise la dernière étude (non effacée par Reset)
          localStorage.setItem('Dernière étude', JSON.stringify({ passage, density, ts: new Date().toISOString() }));
        } else {
          alert('Réponse invalide: sections.length != 28');
        }
      } catch (e) {
        alert('Erreur de génération: ' + e.message);
      }
    }

    bookEl.addEventListener('input', () => (state.book = bookEl.value));
    chapterEl.addEventListener('input', () => (state.chapter = chapterEl.value));
    densityEl.addEventListener('change', () => (state.density = Number(densityEl.value)));
    btnGen.addEventListener('click', onGenerate);
    btnReset.addEventListener('click', resetUI);

    // Initial render
    render();
  </script>
</body>
</html>
