<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Méditation</title>
  <meta name="description" content="Étude biblique — rubriques, génération, PDF, liens BibleGateway, thème et mémoire d’étude." />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <!-- Polices -->
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@700;800&family=Manrope:wght@400;600;700&family=Literata:opsz,wght@14..72,400;14..72,700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fa; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --accent:#0891b2; --accent-600:#0e7490; --accent-700:#155e75; --accent-soft:#e0f2fe;
      --ok:#16a34a; --warn:#f59e0b; --link:#1d4ed8; --radius:14px; --title-size:clamp(26px,3.6vw,40px);
      --editor-max: 920px; --ui-font:'Manrope',Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; --body-font:'Literata',Georgia,serif;
    }
    [data-theme="cyan"]  { --accent:#0891b2; --accent-600:#0e7490; --accent-700:#155e75; --accent-soft:#e0f2fe; --bg:#f3fafc; }
    [data-theme="violet"]{ --accent:#7c3aed; --accent-600:#6d28d9; --accent-700:#5b21b6; --accent-soft:#ede9fe; --bg:#f8f6ff; }
    [data-theme="vert"]  { --accent:#059669; --accent-600:#047857; --accent-700:#065f46; --accent-soft:#dcfce7; --bg:#f5fbf7; }
    [data-theme="rouge"] { --accent:#dc2626; --accent-600:#b91c1c; --accent-700:#991b1b; --accent-soft:#fee2e2; --bg:#fff7f7; }
    [data-theme="mauve"] { --accent:#a855f7; --accent-600:#9333ea; --accent-700:#7e22ce; --accent-soft:#f3e8ff; --bg:#fbf7ff; }
    [data-theme="indigo"]{ --accent:#4f46e5; --accent-600:#4338ca; --accent-700:#3730a3; --accent-soft:#e0e7ff; --bg:#f5f6ff; }
    [data-theme="ambre"] { --accent:#d97706; --accent-600:#b45309; --accent-700:#92400e; --accent-soft:#fef3c7; --bg:#fff9ef; }
    [data-theme="slate"] { --accent:#334155; --accent-600:#1f2937; --accent-700:#0f172a; --accent-soft:#e2e8f0; --bg:#f3f5f8; }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--ui-font)}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:18px 18px;position:sticky;top:0;z-index:10}
    h1{margin:0;line-height:1.1;letter-spacing:.2px;text-align:center;font-family:Fraunces,serif;font-weight:800;font-size:var(--title-size);color:#0f172a}
    main{max-width:1280px;margin:16px auto;padding:0 14px}

    .controls{display:grid;grid-template-columns:1.2fr .9fr .6fr .9fr .9fr auto auto auto auto auto auto;gap:10px;margin:12px 0;align-items:center}
    @media (max-width:1200px){.controls{grid-template-columns:1fr 1fr 1fr 1fr 1fr;grid-auto-rows:auto}.controls .wide{grid-column:1/-1}}
    @media (max-width:680px){.controls{grid-template-columns:1fr 1fr;gap:8px}.controls .wide{grid-column:1/-1}}
    input[type="text"],select{border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:100%;background:#fff;color:var(--text);min-height:42px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;min-height:42px}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.secondary{background:#fff;color:var(--accent-700);border:1px solid var(--accent-600)}
    .btn.warn{background:var(--accent-600);color:#fff}
    .btn.linklike{background:#fff;border:1px solid var(--border);color:#111}
    .mobile-only{display:none}
    @media (max-width:680px){.mobile-only{display:inline-block}}

    .theme-wrap{grid-column:1/-1;display:flex;align-items:center;gap:10px}
    .theme-label{font-size:13px;color:var(--muted);min-width:90px}
    .theme-bar{position:relative;flex:1;height:24px;border-radius:10px;border:1px solid var(--border);
      background:linear-gradient(90deg,#0891b2 0%, #7c3aed 14.28%, #059669 28.56%, #dc2626 42.84%, #a855f7 57.12%, #4f46e5 71.4%, #d97706 85.68%, #334155 100%);cursor:ew-resize;overflow:hidden}
    .theme-thumb{position:absolute;top:2px;bottom:2px;width:18px;border-radius:8px;background:#fff;border:2px solid var(--accent-700);box-shadow:0 1px 3px rgba(0,0,0,.15);transform:translateX(-50%);transition:left .08s ease}

    .layout{display:grid;grid-template-columns:330px 1fr;gap:14px;align-items:start}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}}
    .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .side-head{padding:12px;border-bottom:1px solid var(--border);font-weight:800;text-align:center}
    .list{max-height:70vh;overflow:auto}
    .item{display:grid;grid-template-columns:28px 1fr 12px;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:hover{background:#f8fafc}.item.active{background:var(--accent-soft)}
    .idx{min-width:24px;height:24px;border-radius:999px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:12px;background:#fff;justify-self:center}
    .item>div{text-align:center;line-height:1.2}.item>div>div{font-weight:700;letter-spacing:.2px}
    .desc{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);margin-left:auto;justify-self:end}.dot.ok{background:var(--ok)}

    .editor{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);min-height:60vh;display:flex;flex-direction:column}
    .ed-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .ed-title{font-weight:800;flex:1;text-align:center}
    .ed-body{padding:18px 14px}
    #noteView{display:block;width:100%;min-height:460px;border:1px solid var(--border);border-radius:12px;padding:22px;background:#fff;outline:none;font-family:var(--body-font);font-size:18px;line-height:1.85;max-width:var(--editor-max);margin:0 auto}
    #noteView a{color:var(--link);text-decoration:underline;text-underline-offset:2px}
    #noteMinimal{display:none;width:100%;min-height:160px;border:1px dashed var(--border);border-radius:12px;padding:14px;background:#fff;font-family:var(--ui-font);line-height:1.55;color:#111;max-width:var(--editor-max);margin:0 auto}
    #noteMinimal .hint{font-size:12px;color:var(--muted);margin-bottom:8px;display:block}
    .links-panel{background:#fafafa;border:1px dashed var(--border);border-radius:12px;padding:10px;margin-top:10px;font-size:14px;max-width:var(--editor-max);margin-left:auto;margin-right:auto}
    .links-panel.empty{display:none}
    .last-study{margin:10px 0 0 0;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:12px;font-size:14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .last-study a{color:var(--link);text-decoration:underline}
    .ed-foot{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center;flex-wrap:wrap}

    #printDoc{display:none}
    @media print{
      header,.controls,.layout,.links-panel,.last-study{display:none!important}
      #printDoc{display:block!important;color:#111;font-family:var(--body-font);margin:0 14mm}
      #printDoc header{margin-bottom:12px;border-bottom:1px solid #e5e7eb;padding-bottom:8px}
      #printDoc h2{margin:0 0 8px 0;font-size:20px}
      #printDoc .sec{page-break-inside:avoid;margin:0 0 16px 0}
      #printDoc a{color:#1d4ed8;text-decoration:underline}
    }
  </style>
</head>
<body data-theme="cyan">
  <header><h1>Méditation</h1></header>

  <main>
    <div class="controls">
      <input id="searchRef" class="wide" type="text" placeholder="Rechercher (ex : Marc 5:2, Luc, 1 Jean 2:1-5)" />
      <!-- Bouton mobile uniquement -->
      <button id="applySearchBtn" class="btn primary mobile-only" type="button" title="Appliquer la recherche">Valider</button>

      <select id="bookSelect" title="Livre"></select>
      <select id="chapterSelect" title="Chapitre"></select>
      <select id="verseSelect" title="Verset"></select>
      <select id="versionSelect" title="Version">
        <option value="LSG" selected>Louis Segond 1910 (LSG)</option>
        <option value="PDV">Parole de Vie (PDV)</option>
        <option value="S21">Segond 21 (S21)</option>
        <option value="BFC">Français Courant (BFC)</option>
      </select>

      <button id="readBtn" class="btn secondary" type="button">Lire la Bible</button>
      <button id="generateBtn" class="btn primary" type="button">Générer</button>
      <button id="pdfCurrentBtn" class="btn warn" type="button">PDF (rubrique)</button>
      <button id="pdfAllBtn" class="btn warn" type="button">PDF (28 rubriques)</button>
      <a class="btn linklike" href="https://chatgpt.com/" target="_blank" rel="noopener">ChatGPT</a>
      <button id="resetBtn" class="btn secondary" type="button">Réinitialiser</button>

      <!-- Palette thème -->
      <div class="theme-wrap">
        <div class="theme-label">Thème</div>
        <div id="themeBar" class="theme-bar" title="Glisse pour changer de thème">
          <div id="themeThumb" class="theme-thumb" style="left:6.25%"></div>
        </div>
      </div>
    </div>

    <div id="lastStudyPanel" class="last-study" style="display:none;">
      <strong>Dernière étude :</strong>
      <span id="lastStudyText"></span>
      <a id="lastStudyOpen" href="#" target="_blank" rel="noopener">Ouvrir sur BibleGateway</a>
      <button id="lastStudyUse" class="btn secondary" type="button">Recharger</button>
    </div>

    <div class="layout">
      <aside class="sidebar">
        <div class="side-head">Rubrique</div>
        <div id="pointsList" class="list"></div>
      </aside>

      <section class="editor">
        <div class="ed-head">
          <div class="ed-title" id="edTitle">—</div>
          <button id="prev" class="btn secondary" type="button">◀ Précédent</button>
          <button id="next" class="btn secondary" type="button">Suivant ▶</button>
        </div>
        <div class="ed-body">
          <div id="noteView" contenteditable="true" spellcheck="false" aria-label="Contenu enrichi"></div>
          <div id="noteMinimal" aria-label="Résumé de la rubrique (mode minimaliste)">
            <span class="hint">Résumé (~350 caractères) de la rubrique en cours</span>
            <div id="noteMinimalBody"></div>
          </div>
          <textarea id="noteArea" placeholder="Écris ici…"></textarea>
          <div id="linksPanel" class="links-panel empty"><b>Liens détectés :</b><div id="linksList"></div></div>
        </div>
        <div class="ed-foot">
          <span class="small" id="metaInfo">Point — / 28</span>
          <span class="small">Sauvegarde auto (2s) après saisie.</span>
        </div>
      </section>
    </div>
  </main>

  <div id="printDoc"></div>

  <script>
  (function(){
    const STORAGE_NOTES='notes28', STORAGE_LAST='lastStudy', STORAGE_THEME='theme8';
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    const noteView=$('#noteView'), noteMinimal=$('#noteMinimal'), noteMinimalBody=$('#noteMinimalBody');
    const bookSelect=$('#bookSelect'), chapterSelect=$('#chapterSelect'), verseSelect=$('#verseSelect'), versionSelect=$('#versionSelect');
    const searchRef=$('#searchRef'), readBtn=$('#readBtn'), generateBtn=$('#generateBtn'), applyBtn=$('#applySearchBtn');
    const pdfCurrentBtn=$('#pdfCurrentBtn'), pdfAllBtn=$('#pdfAllBtn'), resetBtn=$('#resetBtn');
    const pointsList=$('#pointsList'), edTitle=$('#edTitle'), metaInfo=$('#metaInfo');
    const themeBar=$('#themeBar'), themeThumb=$('#themeThumb'); const printDoc=$('#printDoc');
    const state={ points:[], current:0, notes: JSON.parse(localStorage.getItem(STORAGE_NOTES)||'{}') };

    /* Thèmes */
    const THEMES=["cyan","violet","vert","rouge","mauve","indigo","ambre","slate"];
    function applyTheme(name){ if(!THEMES.includes(name)) name="cyan"; document.body.setAttribute('data-theme',name); localStorage.setItem(STORAGE_THEME,name); positionThumb(name); }
    function positionThumb(name){ const idx=THEMES.indexOf(name), step=100/8; themeThumb.style.left=(step*idx+step/2)+'%'; }
    function themeAtX(clientX){ const r=themeBar.getBoundingClientRect(); let x=Math.min(Math.max(clientX-r.left,0),r.width-1); const idx=Math.floor((x/r.width)*8); return THEMES[Math.max(0,Math.min(7,idx))]; }
    let dragging=false; themeBar.addEventListener('pointerdown',e=>{dragging=true;themeBar.setPointerCapture(e.pointerId);applyTheme(themeAtX(e.clientX));});
    themeBar.addEventListener('pointermove',e=>{if(dragging)applyTheme(themeAtX(e.clientX));});
    themeBar.addEventListener('pointerup',e=>{dragging=false;themeBar.releasePointerCapture(e.pointerId);});
    themeBar.addEventListener('pointerleave',()=>{dragging=false;});
    applyTheme(localStorage.getItem(STORAGE_THEME)||'cyan');

    /* 66 livres & chapitres */
    const ORDER_66=["Genèse","Exode","Lévitique","Nombres","Deutéronome","Josué","Juges","Ruth","1 Samuel","2 Samuel","1 Rois","2 Rois","1 Chroniques","2 Chroniques","Esdras","Néhémie","Esther","Job","Psaumes","Proverbes","Ecclésiaste","Cantique des Cantiques","Ésaïe","Jérémie","Lamentations","Ézéchiel","Daniel","Osée","Joël","Amos","Abdias","Jonas","Michée","Nahum","Habacuc","Sophonie","Aggée","Zacharie","Malachie","Matthieu","Marc","Luc","Jean","Actes","Romains","1 Corinthiens","2 Corinthiens","Galates","Éphésiens","Philippiens","Colossiens","1 Thessaloniciens","2 Thessaloniciens","1 Timothée","2 Timothée","Tite","Philémon","Hébreux","Jacques","1 Pierre","2 Pierre","1 Jean","2 Jean","3 Jean","Jude","Apocalypse"];
    const CHAPTERS_66={"Genèse":50,"Exode":40,"Lévitique":27,"Nombres":36,"Deutéronome":34,"Josué":24,"Juges":21,"Ruth":4,"1 Samuel":31,"2 Samuel":24,"1 Rois":22,"2 Rois":25,"1 Chroniques":29,"2 Chroniques":36,"Esdras":10,"Néhémie":13,"Esther":10,"Job":42,"Psaumes":150,"Proverbes":31,"Ecclésiaste":12,"Cantique des Cantiques":8,"Ésaïe":66,"Jérémie":52,"Lamentations":5,"Ézéchiel":48,"Daniel":12,"Osée":14,"Joël":3,"Amos":9,"Abdias":1,"Jonas":4,"Michée":7,"Nahum":3,"Habacuc":3,"Sophonie":3,"Aggée":2,"Zacharie":14,"Malachie":4,"Matthieu":28,"Marc":16,"Luc":24,"Jean":21,"Actes":28,"Romains":16,"1 Corinthiens":16,"2 Corinthiens":13,"Galates":6,"Éphésiens":6,"Philippiens":4,"Colossiens":4,"1 Thessaloniciens":5,"2 Thessaloniciens":3,"1 Timothée":6,"2 Timothée":4,"Tite":3,"Philémon":1,"Hébreux":13,"Jacques":5,"1 Pierre":5,"2 Pierre":3,"1 Jean":5,"2 Jean":1,"3 Jean":1,"Jude":1,"Apocalypse":22};

    function initSelects(){ bookSelect.innerHTML='<option value="">Livre…</option>'+ORDER_66.map(b=>`<option>${b}</option>`).join(''); rebuildChapterOptions('Genèse'); rebuildVerseOptions(); }
    function rebuildChapterOptions(book){ const max=CHAPTERS_66[book]||0; let html='<option value="">Chapitre…</option>'; for(let i=1;i<=max;i++) html+=`<option>${i}</option>`; chapterSelect.innerHTML=html; if(max>0) chapterSelect.value='1'; }
    function rebuildVerseOptions(){ let html='<option value="">Verset…</option>'; for(let i=1;i<=176;i++) html+=`<option>${i}</option>`; verseSelect.innerHTML=html; }
    function setSelectValue(sel,val){ const opt=[...sel.options].find(o=>o.value===val||o.textContent===val); if(opt) sel.value=opt.value; }

    /* BibleGateway */
    const gatewayVersionMap={ LSG:'LSG', S21:'SG21', PDV:'LSG', BFC:'SG21' };
    function buildGatewayUrl(ref){ const uiVersion=versionSelect.value||'LSG'; const v=gatewayVersionMap[uiVersion]||'LSG'; return 'https://www.biblegateway.com/passage/?search='+encodeURIComponent(ref)+'&version='+encodeURIComponent(v); }
    function openOnBibleGateway(ref){ window.open(buildGatewayUrl(ref),'_blank','noopener'); }

    /* Linkification (inchangé, simplifié) */
    const BOOKS=ORDER_66.slice();
    const BOOKS_RE=new RegExp('\\b(' + BOOKS.map(b=>b.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')).join('|') + ')\\s+(\\d+)(?::\\s*(\\d+(?:\\s*[–-]\\s*\\d+)?(?:\\s*,\\s*\\d+(?:\\s*[–-]\\s*\\d+)?)*)\\s*)?','gi');
    function decodeEntities(str){ const ta=document.createElement('textarea'); ta.innerHTML=str; return ta.value; }
    function mdBoldToStrong(str){ return str.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>'); }
    function stripTags(s){ return String(s||'').replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim(); }
    function minimal350(text){ let t=decodeEntities(text||''); t=t.replace(/^\s*###\s*\d+\.\s*[^\n]+\n*/,''); t=t.replace(/\*\*(.+?)\*\*/g,'$1'); t=stripTags(t); return t.length<=350?t:(t.slice(0,349).trim()+'…'); }
    function linkifyContainer(root,currentRef){ const nodes=[...root.childNodes]; nodes.forEach(n=>{ if(n.nodeType!==Node.TEXT_NODE) return; const text=n.nodeValue; let idx=0; const frag=document.createDocumentFragment(); text.replace(BOOKS_RE,(m,book,ch,vers,off)=>{ if(off>idx) frag.appendChild(document.createTextNode(text.slice(idx,off))); const ref=book+' '+ch+(vers?(':'+vers.replace(/\s+/g,'').replace(/–/g,'-')):''); const a=document.createElement('a'); a.href=buildGatewayUrl(ref); a.target='_blank'; a.rel='noopener'; a.textContent=m; frag.appendChild(a); idx=off+m.length; return m; }); if(idx<text.length) frag.appendChild(document.createTextNode(text.slice(idx))); if(frag.childNodes.length) n.parentNode.replaceChild(frag,n); }); }

    /* Enrichi/minimal */
    const enrichToggle=document.createElement('label'); enrichToggle.style.display='flex'; enrichToggle.style.alignItems='center'; enrichToggle.style.gap='8px'; enrichToggle.innerHTML=`<input id="enrichToggle" type="checkbox" checked /> <span>Mode enrichi</span>`; document.querySelector('.controls').appendChild(enrichToggle);
    const noteArea=$('#noteArea');
    const stateNotesKey=STORAGE_NOTES; let stateNotes=JSON.parse(localStorage.getItem(stateNotesKey)||'{}');
    function renderEnriched(text){ let html=decodeEntities(text||''); html=mdBoldToStrong(html); html=html.replace(/\r\n/g,"\n").split('\n').map(l=>l===''?'<br>':l).join('\n'); noteView.innerHTML=html; const currentRef=(bookSelect.value&&chapterSelect.value)?`${bookSelect.value} ${chapterSelect.value}`:null; if(currentRef) linkifyContainer(noteView,currentRef); const links=[...noteView.querySelectorAll('a')]; const panel=$('#linksPanel'), list=$('#linksList'); list.innerHTML=links.map(a=>`<div><a href="${a.href}" target="_blank" rel="noopener">${a.textContent}</a></div>`).join(''); panel.classList.toggle('empty',links.length===0); }
    function syncView(){ const raw=stateNotes[state.current]||''; if($('#enrichToggle').checked){ noteMinimal.style.display='none'; noteView.style.display='block'; renderEnriched(raw);}else{ noteView.style.display='none'; noteMinimal.style.display='block'; noteMinimalBody.textContent=minimal350(raw);} }
    document.addEventListener('change',(e)=>{ if(e.target && e.target.id==='enrichToggle') syncView(); });
    noteArea.addEventListener('input',()=>{ clearTimeout(window._svT); window._svT=setTimeout(()=>{ stateNotes[state.current]=noteArea.value; localStorage.setItem(stateNotesKey,JSON.stringify(stateNotes)); updateDots(); syncView(); },800); });

    /* Points (chargés depuis /api/study-28 si dispo) */
    function updateDots(){ $$('#pointsList .item .dot').forEach((dot,i)=>{ const ok=!!(stateNotes[i]&&stateNotes[i].trim()); dot.classList.toggle('ok',ok); }); }
    function highlightActive(){ $$('#pointsList .item').forEach((el,i)=> el.classList.toggle('active', i===state.current)); }
    function updateEditor(){ const item=state.points[state.current]||{title:'Point '+(state.current+1),hint:''}; $('#edTitle').textContent=item.title||('Point '+(state.current+1)); metaInfo.textContent='Point '+(state.current+1)+' / '+state.points.length; noteArea.value=stateNotes[state.current]||''; syncView(); highlightActive(); updateDots(); }
    function buildList(){ pointsList.innerHTML=''; state.points.forEach((p,i)=>{ const row=document.createElement('div'); row.className='item'; row.innerHTML=`<span class="idx">${i+1}</span><div><div>${p.title||('Point '+(i+1))}</div>${p.hint?`<small class="desc">${p.hint}</small>`:''}</div><span class="dot"></span>`; row.addEventListener('click',()=>{state.current=i;updateEditor();}); pointsList.appendChild(row); }); updateEditor(); }
    async function loadPoints(){ try{ const r=await fetch('/api/study-28',{cache:'no-store'}); if(r.ok){ const d=await r.json(); if(Array.isArray(d)&&d.length) state.points=d; } }catch{} if(!state.points.length){ state.points=Array.from({length:28},(_,i)=>({title:'Point '+(i+1),hint:''})); } buildList(); }

    /* Recherche intelligente */
    const NAME_MAP=(()=>{ const norm=s=>s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,''); const map={}; ORDER_66.forEach(n=>{ map[norm(n)]=n; map[norm(n.replace('É','E').replace('é','e'))]=n; }); Object.assign(map,{ps:'Psaumes',psaumes:'Psaumes',prov:'Proverbes',cantique:'Cantique des Cantiques',cantiques:'Cantique des Cantiques',esaie:'Ésaïe',ephesiens:'Éphésiens',philip:'Philippiens',apoc:'Apocalypse'}); return{norm,map}; })();
    function parseSearch(input){ if(!input) return null; const {norm,map}=NAME_MAP; const raw=input.trim().replace(/\u00A0/g,' '); const m=/^([\p{L}\s'.0-9]+?)(?:\s+(\d+))?(?:\s*[:.,]\s*(\d+(?:-\d+)?(?:\s*,\s*\d+(?:-\s*\d+)?)*)\s*)?$/iu.exec(raw); if(!m) return null; let bookGuess=(m[1]||'').trim(); let key=norm(bookGuess).replace(/\./g,'').replace(/^(\d)\s*/,'$1'); let book=map[key]; if(!book){ const matches=ORDER_66.map(n=>[n,NAME_MAP.norm(n)]).filter(([n,nk])=>nk.startsWith(key)); if(matches.length) book=matches.sort((a,b)=>b[1].length-a[1].length)[0][0]; } if(!book) return null; const chapter=m[2]?parseInt(m[2],10):1; const max=CHAPTERS_66[book]||0; const safeChapter=Math.min(Math.max(chapter,1),max||1); const verse=(m[3]||'').trim(); let firstVerse=''; if(verse){ const vMatch=/^(\d+)/.exec(verse.replace(/\s+/g,'')); if(vMatch) firstVerse=vMatch[1]; } return {book,chapter:String(safeChapter),verse:firstVerse}; }
    function applySearch(ref){ const res=parseSearch(ref); if(!res) return false; setSelectValue(bookSelect,res.book); rebuildChapterOptions(res.book); setSelectValue(chapterSelect,res.chapter); rebuildVerseOptions(); if(res.verse) setSelectValue(verseSelect,res.verse); // mémorise Dernière étude
      localStorage.setItem(STORAGE_LAST, JSON.stringify({book:res.book,chapter:res.chapter,verse:res.verse||'',ts:Date.now()})); renderLastStudyPanel(); return true; }
    searchRef.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); applySearch(searchRef.value); }});
    searchRef.addEventListener('blur',()=> applySearch(searchRef.value));
    // NOUVEAU : bouton mobile “Valider”
    applyBtn.addEventListener('click',()=>{ applySearch(searchRef.value)||alert('Indique un livre valide (ex: Marc 5:2)'); });

    /* Lire la Bible (ouvre selon les sélecteurs mis à jour par la recherche/valider) */
    readBtn.addEventListener('click',()=>{ const b=(bookSelect.value||'').trim(), c=(chapterSelect.value||'').trim(), v=(verseSelect.value||'').trim(); if(!b||!c){ alert('Indique un livre et un chapitre.'); return; } openOnBibleGateway(b+' '+c+(v?(':'+v):'')); });

    /* Génération (backend) */
    function setGenerating(on){ generateBtn.disabled=on; generateBtn.textContent=on?'Génération…':'Générer'; }
    function formatSection(n,title,content){ return `### ${n}. ${title}\n\n${content}`.trim(); }
    function renderIntoNotes(payload){ const sec=Array.isArray(payload.sections)?payload.sections:[]; localStorage.removeItem(STORAGE_NOTES); stateNotes={}; for(let i=0;i<state.points.length;i++) stateNotes[i]=''; sec.forEach(s=>{ const idx=(s.n? s.n-1:0); if(idx>=0&&idx<state.points.length){ const title=state.points[idx]?.title||('Point '+(idx+1)); stateNotes[idx]=formatSection(s.n||(idx+1),title,s.content||''); } }); for(let i=0;i<state.points.length;i++){ if(!stateNotes[i]){ const title=state.points[i]?.title||('Point '+(i+1)); stateNotes[i]=formatSection(i+1,title,'_à compléter…_'); } } localStorage.setItem(STORAGE_NOTES,JSON.stringify(stateNotes)); updateEditor();
      const b=(bookSelect.value||'').trim(), c=(chapterSelect.value||'').trim(), v=(verseSelect.value||'').trim(); localStorage.setItem(STORAGE_LAST, JSON.stringify({book:b,chapter:c,verse:v,ts:Date.now()})); renderLastStudyPanel(); }
    generateBtn.addEventListener('click', async ()=>{ const b=(bookSelect.value||'').trim(), c=(chapterSelect.value||'').trim(); if(!b||!c){ alert('Sélectionne un livre et un chapitre.'); return; } setGenerating(true); try{ const r=await fetch('/api/generate-study?book='+encodeURIComponent(b)+'&chapter='+encodeURIComponent(c),{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); const data=await r.json(); renderIntoNotes(data); }catch(e){ alert('Génération indisponible pour le moment.'); } finally{ setGenerating(false); } });

    /* Dernière étude panel */
    function renderLastStudyPanel(){ const raw=localStorage.getItem(STORAGE_LAST); const lastPanel=$('#lastStudyPanel'); if(!raw){ lastPanel.style.display='none'; return; } const {book,chapter,verse}=JSON.parse(raw); if(!book||!chapter){ lastPanel.style.display='none'; return; } $('#lastStudyText').textContent=book+' '+chapter+(verse?(':'+verse):''); $('#lastStudyOpen').href=buildGatewayUrl(book+' '+chapter+(verse?(':'+verse):'')); lastPanel.style.display='flex'; $('#lastStudyUse').onclick=()=>{ setSelectValue(bookSelect,book); rebuildChapterOptions(book); setSelectValue(chapterSelect,String(chapter)); rebuildVerseOptions(); if(verse){ setSelectValue(verseSelect,String(verse).split(',')[0].split('-')[0]); } }; }
    /* Reset */
    function doReset(){ localStorage.removeItem(STORAGE_NOTES); stateNotes={}; $('#noteArea').value=''; noteView.innerHTML=''; noteMinimalBody.textContent=''; $$('#pointsList .item .dot').forEach(dot=>dot.classList.remove('ok')); state.current=0; updateEditor(); }
    resetBtn.addEventListener('click',()=>{ if(confirm('Réinitialiser l’étude en cours ?')) doReset(); });

    /* PDF */
    function mdToHtml(md){ let html=decodeEntities(md||''); html=mdBoldToStrong(html); html=html.replace(/\r\n/g,"\n").split('\n').map(l=>l===''?'<br>':l).join('\n'); const wrap=document.createElement('div'); wrap.innerHTML=html; const current=(bookSelect.value&&chapterSelect.value)?`${bookSelect.value} ${chapterSelect.value}`:null; if(current) linkifyContainer(wrap,current); return wrap.innerHTML; }
    function makePrintableHtml(title, sections){ return `<header><h1 style="font-family:Fraunces,serif;margin:0 0 6px 0;font-size:28px">${title}</h1><div style="color:#64748b;font-size:13px">Export PDF — ${new Date().toLocaleString()}</div></header>`+sections.map(s=>`<section class="sec"><h2>${s.heading}</h2><div>${s.html}</div></section>`).join(''); }
    function exportCurrentToPdf(){ const idx=state.current, raw=stateNotes[idx]||'', title=state.points[idx]?.title||('Point '+(idx+1)); const html=mdToHtml(raw); printDoc.innerHTML=makePrintableHtml(`Rubrique — ${title}`,[{heading:title,html}]); window.print(); printDoc.innerHTML=''; }
    function exportAllToPdf(){ const sections=[]; for(let i=0;i<state.points.length;i++){ const t=state.points[i]?.title||('Point '+(i+1)); const raw=stateNotes[i]||''; sections.push({heading:`${i+1}. ${t}`, html:mdToHtml(raw)}); } printDoc.innerHTML=makePrintableHtml('Étude — 28 rubriques', sections); window.print(); printDoc.innerHTML=''; }
    pdfCurrentBtn.addEventListener('click',exportCurrentToPdf); pdfAllBtn.addEventListener('click',exportAllToPdf);

    /* Init */
    (async function init(){ initSelects(); await loadPoints(); renderLastStudyPanel(); })();
  })();
  </script>
</body>
</html>
