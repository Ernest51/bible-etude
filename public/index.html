<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Étude Biblique — Méditation</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { DEFAULT: '#06b6d4', dark: '#0e7490' } }
        }
      }
    }
  </script>

  <meta name="color-scheme" content="light" />
</head>

<body class="bg-slate-50 text-slate-900 antialiased">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center gap-3">
      <span class="inline-block w-2.5 h-2.5 rounded-full bg-brand"></span>
      <h1 class="text-lg font-semibold">Étude Biblique — Méditation</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-8 space-y-6">
    <!-- ======== TON APP EXISTANTE ======== -->
    <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
      <h2 class="text-base font-semibold mb-3 text-slate-800">Application</h2>
      <div id="app"></div>
    </section>

    <!-- Scripts de ton app (inchangés) -->
    <script defer src="/app-loader.js"></script>
    <script defer src="/app.js"></script>

    <!-- ======== CONTROLS (data-field) ======== -->
    <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
      <h2 class="text-base font-semibold mb-4 text-slate-800">Sélection</h2>

      <div class="flex flex-wrap items-end gap-3">
        <!-- Livre -->
        <div class="min-w-[220px]">
          <label class="block text-xs font-medium text-slate-600 mb-1">Livre</label>
          <select data-field="book" aria-label="Livre"
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
            <option value="">— Livre —</option>
            <!-- AT -->
            <option>Genèse</option><option>Exode</option><option>Lévitique</option>
            <option>Nombres</option><option>Deutéronome</option>
            <option>Josué</option><option>Juges</option><option>Ruth</option>
            <option>1 Samuel</option><option>2 Samuel</option>
            <option>1 Rois</option><option>2 Rois</option>
            <option>1 Chroniques</option><option>2 Chroniques</option>
            <option>Esdras</option><option>Néhémie</option><option>Esther</option>
            <option>Job</option><option>Psaumes</option><option>Proverbes</option>
            <option>Ecclésiaste</option><option>Cantique des cantiques</option>
            <option>Ésaïe</option><option>Jérémie</option><option>Lamentations</option>
            <option>Ézéchiel</option><option>Daniel</option>
            <option>Osée</option><option>Joël</option><option>Amos</option><option>Abdias</option>
            <option>Jonas</option><option>Michée</option><option>Nahoum</option>
            <option>Habacuc</option><option>Sophonie</option><option>Aggée</option>
            <option>Zacharie</option><option>Malachie</option>
            <!-- NT -->
            <option>Matthieu</option><option>Marc</option><option>Luc</option><option>Jean</option>
            <option>Actes</option><option>Romains</option>
            <option>1 Corinthiens</option><option>2 Corinthiens</option>
            <option>Galates</option><option>Éphésiens</option><option>Philippiens</option>
            <option>Colossiens</option>
            <option>1 Thessaloniciens</option><option>2 Thessaloniciens</option>
            <option>1 Timothée</option><option>2 Timothée</option>
            <option>Tite</option><option>Philémon</option><option>Hébreux</option>
            <option>Jacques</option>
            <option>1 Pierre</option><option>2 Pierre</option>
            <option>1 Jean</option><option>2 Jean</option><option>3 Jean</option>
            <option>Jude</option><option>Apocalypse</option>
          </select>
        </div>

        <!-- Chapitre -->
        <div class="w-[160px]">
          <label class="block text-xs font-medium text-slate-600 mb-1">Chapitre</label>
          <select data-field="chapter" aria-label="Chapitre"
                  class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
            <option value="">— Chapitre —</option>
            <script>
              document.currentScript.insertAdjacentHTML(
                'beforebegin',
                Array.from({length:150}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')
              );
            </script>
          </select>
        </div>

        <!-- Versets (optionnel) -->
        <div class="w-[200px]">
          <label class="block text-xs font-medium text-slate-600 mb-1">Versets (ex : 1-3,7)</label>
          <input data-field="verses" placeholder="ex : 1-3,7"
                 class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand" />
        </div>

        <!-- Boutons -->
        <div class="flex items-center gap-2 pb-1">
          <button id="btn-read"
                  class="inline-flex items-center gap-2 rounded-xl bg-brand px-4 py-2.5 text-white text-sm font-semibold shadow-sm hover:bg-brand/90 focus:outline-none focus:ring-2 focus:ring-brand/30">
            Lire la Bible
          </button>
          <button id="btn-plan"
                  class="inline-flex items-center gap-2 rounded-xl bg-slate-800 px-4 py-2.5 text-white text-sm font-semibold shadow-sm hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400/30">
            Plan détaillé (28 rubriques)
          </button>
        </div>

        <p id="sel-status" class="text-xs text-slate-500"></p>
      </div>
    </section>

    <!-- ======== PANNEAU : Lecture + Explication ======== -->
    <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-semibold text-slate-800">Lecture + Explication</h2>
        <span class="text-xs text-slate-500">HTML sécurisé (p, strong, em, ul, ol, li, a)</span>
      </div>
      <div id="x-out" class="prose prose-slate max-w-none"></div>
    </section>

    <!-- ======== PANNEAU : Plan détaillé (28 rubriques) ======== -->
    <section class="bg-white border border-slate-200 rounded-2xl shadow-sm p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-semibold text-slate-800">Plan détaillé</h2>
        <span class="text-xs text-slate-500">Extraits pédagogiques + renvois BibleGateway</span>
      </div>
      <div id="plan-out" class="space-y-3"></div>
    </section>

    <!-- ======== JS WIDGET EXPLICATION + API publique ======== -->
    <script>
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const out = $("#x-out");

        const card = (inner) =>
          `<div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">${inner}</div>`;

        function renderExplain(data) {
          const { reference, items } = data;
          const head =
            `<h3 class="text-lg font-semibold text-brand-dark mb-3">${reference}</h3>`;
          const blocks = items.map((it) => {
            const v = it.v ? `<div class="text-slate-700 font-semibold">v.${it.v}</div>` : "";
            return card(`
              ${v}
              <p class="mt-2 mb-3 text-slate-800">${it.text}</p>
              <div class="prose prose-slate max-w-none">${it.html}</div>
            `);
          }).join("");
          out.innerHTML = head + blocks;
        }

        async function runExplain({ book, chapter, verse }) {
          out.innerHTML = card(`<p class="text-sm text-slate-500">Chargement…</p>`);
          try {
            const qs = new URLSearchParams({ book, chapter, verse });
            const r = await fetch(`/api/explain?${qs.toString()}`);
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            if (!j.ok) throw new Error(j.error || "Erreur inconnue");
            renderExplain(j.data);
          } catch (e) {
            out.innerHTML = card(
              `<p class="text-sm text-rose-700"><strong>Oops :</strong> ${String(e.message || e)}</p>`
            );
          }
        }

        // API publique pour ton app existante
        window.renderMeditationExplain = (book, chapter, verse = "") =>
          runExplain({ book, chapter, verse });
      })();
    </script>

    <!-- ======== JS : BRIDGE Sélecteurs → Boutons ======== -->
    <script>
      (function () {
        const $ = (s, r=document) => r.querySelector(s);
        const status = $('#sel-status');

        const getVal = (sel) => {
          const el = $(sel);
          return el ? String(el.value || el.textContent || "").trim() : "";
        };

        function getInputs(){
          return {
            book:    getVal('[data-field="book"]'),
            chapter: getVal('[data-field="chapter"]'),
            verse:   getVal('[data-field="verses"]')
          };
        }

        function tryExplain(){
          const { book, chapter, verse } = getInputs();
          if (!book || !chapter) { status.textContent = "Livre et chapitre requis."; return; }
          status.textContent = "";
          if (typeof window.renderMeditationExplain !== "function") {
            status.textContent = "Composant d'explication indisponible."; return;
          }
          window.renderMeditationExplain(book, chapter, verse || "");
        }

        async function tryPlan(){
          const planOut = document.getElementById('plan-out');
          const { book, chapter, verse } = getInputs();
          if (!book || !chapter) { status.textContent = "Livre et chapitre requis."; return; }
          status.textContent = "";
          planOut.innerHTML =
            `<div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
               <p class="text-sm text-slate-500">Chargement du plan…</p>
             </div>`;

          try {
            // /api/chat.js attend POST { book, chapter, verse?, version?, directives? }
            const r = await fetch('/api/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ book, chapter, verse })
            });
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            if (!j.ok) throw new Error(j.error || 'Erreur inconnue');

            const { reference, sections } = j.data || {};
            const head =
              `<h3 class="text-lg font-semibold text-brand-dark mb-3">${reference || (book + " " + chapter)}</h3>`;

            const blocks = (sections || []).map(sec => {
              // sec: { id, title, content (HTML sûr depuis l’API) }
              return `
                <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="inline-flex justify-center items-center w-6 h-6 text-xs font-semibold rounded-full bg-brand/10 text-brand">${sec.id}</span>
                    <h4 class="text-base font-semibold text-slate-800">${sec.title}</h4>
                  </div>
                  <div class="prose prose-slate max-w-none text-sm leading-6">
                    ${sec.content}
                  </div>
                </div>
              `;
            }).join('');

            planOut.innerHTML = head + blocks;
          } catch (e) {
            planOut.innerHTML =
              `<div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
                 <p class="text-sm text-rose-700"><strong>Oops :</strong> ${String(e.message || e)}</p>
               </div>`;
          }
        }

        // Boutons
        $('#btn-read')?.addEventListener('click', tryExplain);
        $('#btn-plan')?.addEventListener('click', tryPlan);

        // Entrée dans le champ versets => lecture
        document.querySelector('[data-field="verses"]')?.addEventListener('keydown', (e)=>{
          if(e.key==='Enter') tryExplain();
        });
      })();
    </script>
  </main>
</body>
</html>
