<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bible Étude</title>
  <meta name="description" content="Étude biblique — site simple et rapide" />
  <link rel="icon" href="data:," />
  <style>
    :root { --bg:#f5f6f8; --card:#ffffff; --text:#0f172a; --muted:#64748b; --link:#2563eb; --green:#16a34a; --red:#dc2626; --amber:#d97706; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.06);padding:18px 20px;position:sticky;top:0}
    h1{margin:0;font-size:28px}
    main{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:18px}
    p{margin:0 0 10px}
    .muted{color:var(--muted)}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    footer{max-width:900px;margin:32px auto 24px;padding:0 16px;color:var(--muted);font-size:14px}
    /* Debug footer */
    #debugBtn{margin-top:8px;background:#111827;color:#fff;border:0;border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer}
    #debugPanel{display:none;margin-top:8px;background:#0b1020;color:#e2e8f0;border:1px solid #1f2a44;border-radius:8px;padding:8px;max-height:240px;overflow:auto;white-space:pre-wrap;font-size:12px}
    .status-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:4px 8px;font-size:12px;color:#111}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--amber)}
    .dot.ok{background:var(--green)}
    .dot.ko{background:var(--red)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
    select, label.switch {font-size:12px}
    .switch {display:inline-flex;align-items:center;gap:6px;cursor:pointer}
    .switch input{accent-color:#111827}
    .next {font-size:12px}
  </style>
</head>
<body>
  <header><h1>Bible Étude</h1></header>

  <main>
    <div class="card">
      <h2 style="margin:0 0 8px">Bienvenue</h2>
      <p class="muted">Base propre prête pour la mise en prod.</p>
      <p style="margin-top:12px">
        API en ligne :
        <a href="/api/health">/api/health</a> ·
        <a href="/api/chat">/api/chat</a> ·
        <a href="/api/ping">/api/ping</a>
      </p>
    </div>
  </main>

  <footer>
    © <span id="y"></span> Bible Étude
    <div class="status-row" aria-label="Statut API">
      <span class="badge"><span id="dot-health" class="dot" aria-hidden="true"></span> health</span>
      <span class="badge"><span id="dot-chat" class="dot" aria-hidden="true"></span> chat(POST)</span>
      <span class="badge"><span id="dot-ping" class="dot" aria-hidden="true"></span> ping</span>
      <button id="debugBtn" title="Ouvrir le panneau de debug">Debug</button>
    </div>
    <div class="controls">
      <label class="switch"><input type="checkbox" id="autoToggle" checked> Auto</label>
      <label>Intervalle:
        <select id="autoInterval">
          <option value="5">5 min</option>
          <option value="10" selected>10 min</option>
          <option value="30">30 min</option>
        </select>
      </label>
      <span class="next">Prochain check dans <strong id="nextIn">—</strong></span>
    </div>
    <div id="debugPanel">[init]</div>
  </footer>

  <script>
    (function(){
      document.getElementById('y').textContent = new Date().getFullYear();

      const btn = document.getElementById('debugBtn');
      const panel = document.getElementById('debugPanel');
      const dotHealth = document.getElementById('dot-health');
      const dotChat = document.getElementById('dot-chat');
      const dotPing = document.getElementById('dot-ping');

      const autoToggle = document.getElementById('autoToggle');
      const autoInterval = document.getElementById('autoInterval');
      const nextIn = document.getElementById('nextIn');

      let autoTimer = null;
      let countdownTimer = null;
      let remainingMs = 0;

      function setDot(dot, ok){
        dot.classList.remove('ok','ko');
        if (ok === true) dot.classList.add('ok');
        else if (ok === false) dot.classList.add('ko');
        // undefined → ambre
      }

      function log(msg){
        const line = '['+new Date().toISOString()+'] '+msg;
        panel.textContent += (panel.textContent ? '\n' : '') + line;
        console.log(line);
      }

      async function ping(path, options){
        try{
          const c = new AbortController();
          const t = setTimeout(()=>c.abort(),2500);
          const r = await fetch(path, { ...(options||{}), signal:c.signal });
          clearTimeout(t);
          return r;
        }catch(e){
          return { ok:false, status:0, error:String(e) };
        }
      }

      async function runChecks(logToPanel = true){
        setDot(dotHealth, undefined);
        setDot(dotChat, undefined);
        setDot(dotPing, undefined);

        const r1 = await ping('/api/health');
        setDot(dotHealth, !!(r1 && r1.ok));
        if (logToPanel) log((r1 && r1.ok ? 'OK' : 'KO') + ' /api/health → ' + (r1.status||0));

        const r2 = await ping('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({probe:true, ts:Date.now()}) });
        setDot(dotChat, !!(r2 && r2.ok));
        if (logToPanel) log((r2 && r2.ok ? 'OK' : 'KO') + ' /api/chat (POST) → ' + (r2.status||0));

        const r3 = await ping('/api/ping');
        setDot(dotPing, !!(r3 && r3.ok));
        if (logToPanel) log((r3 && r3.ok ? 'OK' : 'KO') + ' /api/ping → ' + (r3.status||0));
      }

      function fmt(ms){
        const s = Math.max(0, Math.floor(ms/1000));
        const m = Math.floor(s/60);
        const ss = String(s%60).padStart(2,'0');
        return m + ':' + ss;
      }

      function clearTimers(){
        if (autoTimer){ clearTimeout(autoTimer); autoTimer = null; }
        if (countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
      }

      function scheduleNext(){
        clearTimers();
        if (!autoToggle.checked){ nextIn.textContent = '—'; return; }
        if (document.hidden){ nextIn.textContent = 'pause (onglet inactif)'; return; }

        const mins = parseInt(autoInterval.value, 10) || 10;
        remainingMs = mins * 60 * 1000;

        nextIn.textContent = fmt(remainingMs);
        countdownTimer = setInterval(()=>{
          remainingMs -= 1000;
          nextIn.textContent = fmt(remainingMs);
          if (remainingMs <= 0){ clearInterval(countdownTimer); }
        }, 1000);

        autoTimer = setTimeout(async ()=>{
          const willLog = panel.style.display === 'block';
          if (willLog) panel.textContent = '[Debug démarré…]';
          await runChecks(willLog);
          scheduleNext();
        }, remainingMs);
      }

      function togglePanel(){
        const open = panel.style.display==='block';
        if(open){ panel.style.display='none'; btn.textContent='Debug'; }
        else{
          panel.style.display='block'; btn.textContent='Fermer Debug';
          panel.textContent='[Debug démarré…]';
          runChecks(true);
        }
      }

      btn.addEventListener('click', togglePanel);
      autoToggle.addEventListener('change', scheduleNext);
      autoInterval.addEventListener('change', scheduleNext);
      document.addEventListener('visibilitychange', scheduleNext);

      scheduleNext(); // auto ON par défaut
    })();
  </script>
</body>
</html>
