<!doctype html>
<meta charset="utf-8" />
<title>Test /api/study-28 ‚Üí 28 sections</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 860px; margin: 2rem auto; padding: 0 1rem; }
  h1 { margin: 0 0 1rem; }
  form { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-bottom: 1rem; }
  form label { display: grid; gap: .25rem; font-size: .9rem; }
  input, select, button { padding: .5rem .6rem; font-size: 1rem; }
  .row-span-2 { grid-column: 1 / -1; }
  .ok { color: #0a7; }
  .err { color: #c00; white-space: pre-wrap; }
  .meta { font-size: .95rem; color: #444; margin: .5rem 0 1rem; }
  .sec { border-top: 1px solid #eee; padding: .9rem 0; }
  .sec h3 { margin: 0 0 .25rem; font-size: 1.05rem; }
  .verses { font-size: .85rem; color: #666; }
</style>

<h1>Test rapide : /api/study-28 ‚Üí 28 sections</h1>

<form id="f">
  <label> Livre
    <input name="book" value="Gen√®se" required />
  </label>
  <label> Chapitre
    <input name="chapter" value="1" required />
  </label>
  <label> Versets (optionnel)
    <input name="verse" placeholder="ex: 1-5 ou 3,7" />
  </label>
  <label> Traduction (label libre)
    <input name="translation" value="JND" />
  </label>
  <label class="row-span-2"> Bible ID (optionnel)
    <input name="bibleId" value="a93a92589195411f-01" />
  </label>
  <button type="submit">üß™ Lancer l‚Äô√©tude (28 points)</button>
</form>

<div id="status"></div>
<div id="out"></div>

<script>
const $ = s => document.querySelector(s);
const statusBox = $("#status");
const out = $("#out");
$("#f").addEventListener("submit", async (e) => {
  e.preventDefault();
  out.innerHTML = "";
  statusBox.textContent = "‚è≥ g√©n√©ration en cours‚Ä¶";
  const fd = new FormData(e.currentTarget);
  const book = fd.get("book") || "";
  const chapter = fd.get("chapter") || "";
  const verse = fd.get("verse") || "";
  const translation = fd.get("translation") || "JND";
  const bibleId = fd.get("bibleId") || "";

  const usp = new URLSearchParams({ book, chapter, translation });
  if (verse) usp.set("verse", verse);
  if (bibleId) usp.set("bibleId", bibleId);

  try {
    const res = await fetch(`/api/study-28?` + usp.toString());
    const j = await res.json();
    if (!j.ok) {
      statusBox.innerHTML = `<div class="err">‚ö†Ô∏è Erreur\n${(j.error || "R√©ponse invalide")}</div>`;
      return;
    }
    const data = j.data || {};
    const sections = data.sections || [];
    statusBox.innerHTML = `<div class="ok">‚úÖ √âtude de ${data.meta?.reference || (book+" "+chapter)} ‚Äî ${sections.length} sections</div>
      <div class="meta">OSIS: ${data.meta?.osis || "?"} ¬∑ Trad: ${data.meta?.translation || translation}</div>`;

    if (!sections.length) {
      out.innerHTML = `<div class="err">‚ö†Ô∏è aucune section</div>`;
      return;
    }

    out.innerHTML = sections.map(s => `
      <div class="sec">
        <h3>${s.index}. ${s.title}</h3>
        <p>${s.content}</p>
        ${Array.isArray(s.verses) && s.verses.length ? `<div class="verses">Versets: ${s.verses.join(", ")}</div>` : ""}
      </div>
    `).join("");
  } catch (e2) {
    statusBox.innerHTML = `<div class="err">‚ö†Ô∏è Exception: ${e2?.message || e2}</div>`;
  }
});
</script>
