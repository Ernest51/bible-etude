<!doctype html>
<meta charset="utf-8" />
<title>Test rapide : /api/study-28 ‚Üí 28 sections</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 24px; background:#f8f9fb; }
  form { display:grid; gap:8px; grid-template-columns: 160px 1fr; max-width: 760px; background:#fff; padding:16px; border-radius:12px; border:1px solid #e9e9ef}
  label { color:#444; font-size:14px; align-self:center;}
  input, select, button { padding:10px; font-size:14px; border:1px solid #ddd; border-radius:8px; }
  button { grid-column: 1 / -1; background:#111; color:#fff; cursor:pointer; }
  .row { display:contents; }
  h2 { margin-top: 24px; }
  pre { background:#0a0a0a; color:#d5eaff; padding:16px; border-radius:12px; overflow:auto; }
  .sections { margin-top:16px; background:#fff; border:1px solid #e9e9ef; border-radius:12px; padding:12px; }
  .item { padding:8px 0; border-top:1px dashed #eee; }
  .item:first-child { border-top:none; }
  .title { font-weight:600; }
  .ref { color:#666; font-size:12px; }
</style>

<h1>Test rapide : /api/study-28 ‚Üí JSON (28 sections)</h1>

<form id="f">
  <div class="row">
    <label>Livre :</label>
    <input id="book" value="Gen√®se" />
  </div>
  <div class="row">
    <label>Chapitre :</label>
    <input id="chapter" value="1" />
  </div>
  <div class="row">
    <label>Versets (optionnel) :</label>
    <input id="verses" placeholder="ex: 1-5 ou 3,7 (laisser vide = chapitre entier)" />
  </div>
  <div class="row">
    <label>Traduction (label libre) :</label>
    <input id="translation" value="JND" />
  </div>
  <div class="row">
    <label>Bible ID (override) :</label>
    <input id="bibleId" placeholder="ex: a93a92589195411f-01 (JND) / ID LSG quand dispo" />
  </div>
  <button>üß™ Lancer l‚Äô√©tude (28 points)</button>
</form>

<h2>R√©sum√© sections</h2>
<div id="summary" class="sections">‚Äî</div>

<h2>JSON brut</h2>
<pre id="raw">‚Äî</pre>

<script>
  const form = document.getElementById("f");
  const out  = document.getElementById("raw");
  const sum  = document.getElementById("summary");

  function renderSummary(data) {
    try {
      const ref = data?.reference || "";
      const tr  = data?.translation || "";
      const sections = Array.isArray(data?.sections) ? data.sections : [];
      if (!sections.length) { sum.textContent = "‚ö†Ô∏è Aucune section trouv√©e"; return; }
      sum.innerHTML = `<div class="ref"><strong>√âtude de ${ref} (${tr})</strong></div>` +
        sections.map(s => `<div class="item"><div class="title">${s.index}. ${s.title}</div><div>${s.content}</div></div>`).join("");
    } catch {
      sum.textContent = "‚ö†Ô∏è Affichage r√©sum√© impossible";
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    out.textContent = "Chargement‚Ä¶";
    sum.textContent = "Chargement‚Ä¶";

    const payload = {
      book: document.getElementById("book").value.trim(),
      chapter: document.getElementById("chapter").value.trim(),
      verses: document.getElementById("verses").value.trim(),
      translation: document.getElementById("translation").value.trim(),
      bibleId: document.getElementById("bibleId").value.trim()
    };

    try {
      const res = await fetch("/api/study-28", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      const t = await res.text();
      out.textContent = t;

      let j = {};
      try { j = JSON.parse(t); } catch {}
      if (j?.ok && j?.data) {
        renderSummary(j.data);
      } else if (j?.reference || j?.sections) {
        // Si l‚ÄôAPI renvoie directement l‚Äôobjet √©tude (ok non pr√©sent)
        renderSummary(j);
      } else {
        sum.textContent = "‚ö†Ô∏è R√©ponse vide ou invalide";
      }
    } catch (err) {
      out.textContent = "Erreur r√©seau: " + err.message;
      sum.textContent = "‚ö†Ô∏è Erreur r√©seau";
    }
  });
</script>
