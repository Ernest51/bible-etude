<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Test — Étude verset par verset (Rubrique 0)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:18px;line-height:1.6}
    h1{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    input,button{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
    button{cursor:pointer}
    .ok{color:#16a34a;font-weight:700}
    .ko{color:#b91c1c;font-weight:700}
    .warn{color:#eab308;font-weight:700}
    .box{border:1px solid #e2e8f0;border-radius:12px;padding:12px;margin-top:12px;background:#fff}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
    .muted{color:#64748b}
    .list{display:grid;grid-template-columns:1fr;gap:8px}
    .item{border:1px solid #e2e8f0;border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <h1>Test — Étude verset par verset (Rubrique 0)</h1>
  <p>Ce test vérifie l’endpoint <code>/api/verses</code> (ou <code>/api/verse</code>) et la présence d’explications par verset (<code>noteHTML</code>).</p>

  <div class="row">
    <label>Livre : <input id="book" value="Genèse" style="width:140px"></label>
    <label>Chapitre : <input id="chapter" type="number" value="1" min="1" style="width:80px"></label>
    <label>Nombre de versets : <input id="count" type="number" value="31" min="1" max="200" style="width:90px"></label>
    <button id="run">Lancer le test</button>
  </div>

  <div id="out" class="box"></div>
  <div id="list" class="list"></div>

  <script>
    const out = document.getElementById('out');
    const list = document.getElementById('list');

    function setOut(html){ out.innerHTML = html; }
    function li(html){
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = html;
      list.appendChild(div);
    }

    async function fetchJsonPreferVerses(url){
      // Tente /api/verses puis fallback sur /api/verse
      let r = await fetch(url);
      let ct = (r.headers.get('content-type')||'').toLowerCase();
      if (!ct.includes('application/json')) {
        // peut être une erreur HTML Vercel; on réessaie /api/verse
        const alt = url.replace('/api/verses', '/api/verse');
        r = await fetch(alt);
        ct = (r.headers.get('content-type')||'').toLowerCase();
      }
      const text = await r.text();
      if (!ct.includes('application/json')) throw new Error('Réponse non-JSON\n\n' + text.slice(0,300));
      try { return JSON.parse(text); } catch (e) { throw new Error('JSON invalide: ' + e.message + '\n' + text.slice(0,300)); }
    }

    async function run(){
      list.innerHTML = '';
      setOut('<span class="muted">Test en cours…</span>');

      const book = document.getElementById('book').value.trim() || 'Genèse';
      const chapter = Math.max(1, parseInt(document.getElementById('chapter').value,10) || 1);
      const count = Math.max(1, Math.min(parseInt(document.getElementById('count').value,10) || 31, 200));

      const url = `/api/verses?book=${encodeURIComponent(book)}&chapter=${encodeURIComponent(chapter)}&count=${encodeURIComponent(count)}`;

      try{
        const data = await fetchJsonPreferVerses(url);

        if (!data || !Array.isArray(data.verses)) {
          setOut(`<span class="ko">❌ KO — Schéma inattendu</span><br><code>${JSON.stringify(data).slice(0,600)}</code>`);
          return;
        }

        const n = data.verses.length;
        const source = data.source || 'n/a';
        const version = data.version || 'n/a';

        if (n === 0) {
          setOut(`<span class="ko">❌ KO — Seulement ${n} verset(s) (source: ${source})</span>`);
          return;
        }

        // au moins une noteHTML sur les 5 premiers versets
        const first5 = data.verses.slice(0, Math.min(5, n));
        const hasNote = first5.some(v => v && typeof v.noteHTML === 'string' && v.noteHTML.trim().length > 0);

        let statusLine = '';
        if (hasNote) statusLine = `<span class="ok">✅ OK — ${n} versets (source: ${source}, version: ${version})</span>`;
        else statusLine = `<span class="warn">⚠️ ${n} versets mais aucune <code>noteHTML</code> dans les 5 premiers (source: ${source}, version: ${version})</span>`;

        setOut(`${statusLine}`);

        // listing compact de quelques versets
        data.verses.slice(0, Math.min(n, count)).forEach(v => {
          const ref = `${book} ${chapter}:${v.v}`;
          const yh = `https://www.bible.com/fr/bible/93/${(data.youversionBase||'').split('/').pop()||''}`;
          li(`
            <div><strong>${ref}</strong> — <a href="${yh || '#'}" target="_blank" rel="noopener">YouVersion</a></div>
            <div class="muted">${(v.text||'— (texte indisponible ici, voir YouVersion)')}</div>
            <div>${v.noteHTML ? v.noteHTML : '<em class="muted">noteHTML manquante</em>'}</div>
          `);
        });

      } catch(e){
        setOut(`<span class="ko">❌ Erreur: ${e.message}</span>`);
      }
    }

    document.getElementById('run').addEventListener('click', run);
    // auto-run par défaut (pratique en déploiement)
    run();
  </script>
</body>
</html>
