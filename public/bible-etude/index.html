// /public/bible-etude/tester.js
(function(){
  function showErr(e){
    try{
      const box = document.getElementById("err");
      if (!box) return;
      box.style.display = "block";
      const msg = (e && e.stack) ? e.stack : String(e && e.message || e);
      box.textContent = "Erreur: " + msg;
      console.error(e);
    }catch{}
  }

  function ready(fn){
    if (document.readyState === "complete" || document.readyState === "interactive"){
      setTimeout(fn, 0);
    } else {
      document.addEventListener("DOMContentLoaded", fn);
    }
  }

  ready(function init(){
    try{
      const $ = (id) => document.getElementById(id);

      // Vérifie la présence des éléments requis
      const reqIds = ["bookA","bookB","chapA","chapB","versA","versB","versionSel","btnRun","btnSwap","table","details","jsonA","jsonB","apiStatus","refA","refB"];
      for (const id of reqIds){
        if (!$(id)) throw new Error(`Élément manquant dans le DOM: #${id}`);
      }

      // Livres
      const BOOKS = [
        ["Genèse", 50],["Exode", 40],["Lévitique", 27],["Nombres", 36],["Deutéronome", 34],
        ["Josué", 24],["Juges", 21],["Ruth", 4],["1 Samuel", 31],["2 Samuel", 24],
        ["1 Rois", 22],["2 Rois", 25],["1 Chroniques", 29],["2 Chroniques", 36],["Esdras", 10],
        ["Néhémie", 13],["Esther", 10],["Job", 42],["Psaumes", 150],["Proverbes", 31],
        ["Ecclésiaste", 12],["Cantique des cantiques", 8],["Ésaïe", 66],["Jérémie", 52],["Lamentations", 5],
        ["Ézéchiel", 48],["Daniel", 12],["Osée", 14],["Joël", 3],["Amos", 9],
        ["Abdias", 1],["Jonas", 4],["Michée", 7],["Nahoum", 3],["Habacuc", 3],
        ["Sophonie", 3],["Aggée", 2],["Zacharie", 14],["Malachie", 4],
        ["Matthieu", 28],["Marc", 16],["Luc", 24],["Jean", 21],["Actes", 28],
        ["Romains", 16],["1 Corinthiens", 16],["2 Corinthiens", 13],["Galates", 6],["Éphésiens", 6],
        ["Philippiens", 4],["Colossiens", 4],["1 Thessaloniciens", 5],["2 Thessaloniciens", 3],["1 Timothée", 6],
        ["2 Timothée", 4],["Tite", 3],["Philémon", 1],["Hébreux", 13],["Jacques", 5],
        ["1 Pierre", 5],["2 Pierre", 3],["1 Jean", 5],["2 Jean", 1],["3 Jean", 1],
        ["Jude", 1],["Apocalypse", 22],
      ];

      function fillBooks(sel) {
        if (!sel) throw new Error("Select introuvable pour fillBooks");
        sel.innerHTML = "";
        for (const [n, ch] of BOOKS) {
          const o = document.createElement("option");
          o.value = n; o.textContent = n; o.dataset.ch = String(ch);
          sel.appendChild(o);
        }
        // petit log utile si ça casse
        // console.log("Remplissage", sel.id, sel.options.length);
      }

      fillBooks($("bookA"));
      fillBooks($("bookB"));

      $("bookA").value = "Genèse";
      $("bookB").value = "Genèse";
      $("chapA").value = 1;
      $("chapB").value = 1;
      $("versA").value = "1";
      $("versB").value = "2";

      // Helpers similarité
      function refStr(book, ch, v){ return v ? `${book} ${ch}:${v}` : `${book} ${ch}`; }
      function norm(s){
        return String(s||"")
          .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
          .toLowerCase().replace(/[^a-z0-9\s]/g," ")
          .replace(/\s+/g," ").trim();
      }
      function tokens(s){ return norm(s).split(" ").filter(Boolean); }
      function jaccard(a,b){
        const A = new Set(tokens(a)), B = new Set(tokens(b));
        if (A.size === 0 && B.size === 0) return 1;
        let inter = 0;
        for (const t of A) if (B.has(t)) inter++;
        const uni = A.size + B.size - inter;
        return uni === 0 ? 1 : inter / uni;
      }
      function levenshteinRatio(a,b){
        const s = String(a||""), t = String(b||"");
        const n = s.length, m = t.length;
        if (n === 0 && m === 0) return 1;
        const dp = Array.from({length:n+1},()=>Array(m+1).fill(0));
        for(let i=0;i<=n;i++) dp[i][0] = i;
        for(let j=0;j<=m;j++) dp[0][j] = j;
        for(let i=1;i<=n;i++){
          for(let j=1;j<=m;j++){
            const cost = s[i-1] === t[j-1] ? 0 : 1;
            dp[i][j] = Math.min(
              dp[i-1][j] + 1,
              dp[i][j-1] + 1,
              dp[i-1][j-1] + cost
            );
          }
        }
        const dist = dp[n][m];
        const maxLen = Math.max(n,m) || 1;
        return 1 - (dist / maxLen);
      }
      function pct(x){ return Math.round(x*1000)/10; }
      function cls(score){ return score>=0.80 ? "bad" : (score>=0.60 ? "mid" : "ok"); }

      // API health (facultatif)
      (async ()=>{
        try{
          const r = await fetch("/api/health", {cache:"no-store"});
          $("apiStatus").textContent = r.ok ? "API: health OK" : "API: health KO";
          $("apiStatus").className = "pill " + (r.ok ? "ok" : "mid");
        }catch{
          $("apiStatus").textContent = "API: health indisponible";
          $("apiStatus").className = "pill mid";
        }
      })();

      function collect(side){
        const book = $(side==="A"?"bookA":"bookB").value;
        const ch = Number($(side==="A"?"chapA":"chapB").value || 1);
        const v = $(side==="A"?"versA":"versB").value.trim();
        const version = $("versionSel").value || "LSG";
        const directives = $("directives").value.trim();
        return { book, chapter: ch, verse: v || "", version, directives: directives ? { priere_ouverture: directives } : {} };
      }

      async function getStudy(payload){
        const r = await fetch("/api/chat", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(await r.text().catch(()=>`HTTP ${r.status}`));
        const j = await r.json();
        if (!j || j.ok === false) throw new Error(j?.error || "Réponse invalide");
        return j;
      }

      function renderTable(A,B){
        const table = $("table");
        let html = `
          <thead>
            <tr>
              <th>#</th>
              <th>Rubrique</th>
              <th class="muted">Long. A</th>
              <th class="muted">Long. B</th>
              <th>Jaccard</th>
              <th>Levenshtein</th>
              <th>Combiné</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
        `;
        let hi=0, mid=0, okc=0;

        for(const secA of A.data.sections){
          const id = secA.id;
          const secB = B.data.sections.find(s=>s.id===id) || {content:"", title:secA.title};
          const cA = String(secA.content||"").trim();
          const cB = String(secB.content||"").trim();
          const jac = jaccard(cA,cB);
          const lev = levenshteinRatio(cA,cB);
          const comb = 0.5*jac + 0.5*lev;
          const jcls = cls(jac), lcls = cls(lev), ccls = cls(comb);
          if (ccls==="bad") hi++; else if (ccls==="mid") mid++; else okc++;

          html += `
            <tr>
              <td>${id}</td>
              <td>${secA.title||""}</td>
              <td class="muted">${cA.length.toLocaleString()}</td>
              <td class="muted">${cB.length.toLocaleString()}</td>
              <td><span class="pill ${jcls}">${pct(jac)}%</span></td>
              <td><span class="pill ${lcls}">${pct(lev)}%</span></td>
              <td><span class="pill ${ccls}">${pct(comb)}%</span></td>
              <td>${ccls==="bad" ? "⚠️ élevé" : (ccls==="mid"?"△ moyen":"✅ faible")}</td>
            </tr>`;
        }
        html += `</tbody>`;
        table.innerHTML = html;

        // petit résumé dans le header de la table
        const summary = document.createElement("div");
        summary.className = "row";
        summary.style.margin = "6px 0 0 0";
        summary.innerHTML = `
          <span class="pill bad">forte similarité: ${hi}</span>
          <span class="pill mid">moyenne: ${mid}</span>
          <span class="pill ok">faible: ${okc}</span>
        `;
        table.parentElement.insertBefore(summary, table);
      }

      function renderDetails(A,B){
        const wrap = $("details");
        wrap.innerHTML = "";
        for(const secA of A.data.sections){
          const id = secA.id;
          const secB = B.data.sections.find(s=>s.id===id) || {content:"", title:secA.title};
          const cA = String(secA.content||"").trim();
          const cB = String(secB.content||"").trim();

          const el = document.createElement("details");
          const sum = document.createElement("summary");
          sum.innerHTML = `<strong>${id}. ${secA.title||""}</strong>`;
          el.appendChild(sum);

          const box = document.createElement("div");
          box.className = "two-cols";
          const left = document.createElement("div");
          const right = document.createElement("div");
          left.innerHTML = `<div class="muted" style="font-size:12px">A</div><div class="panel-text">${cA || "<em class='muted'>— vide —</em>"}</div>`;
          right.innerHTML = `<div class="muted" style="font-size:12px">B</div><div class="panel-text">${cB || "<em class='muted'>— vide —</em>"}</div>`;
          box.appendChild(left); box.appendChild(right);

          el.appendChild(box);
          wrap.appendChild(el);
        }
      }

      async function run(){
        const A = collect("A");
        const B = collect("B");
        $("refA").textContent = `A : ${refStr(A.book, A.chapter, A.verse)} (${A.version})`;
        $("refB").textContent = `B : ${refStr(B.book, B.chapter, B.verse)} (${B.version})`;

        const [resA, resB] = await Promise.all([getStudy(A), getStudy(B)]);
        $("jsonA").textContent = JSON.stringify(resA, null, 2);
        $("jsonB").textContent = JSON.stringify(resB, null, 2);

        renderTable(resA, resB);
        renderDetails(resA, resB);

        const first = $("details").querySelector("details");
        if (first) first.open = true;
      }

      $("btnRun").addEventListener("click", () => {
        const btn = $("btnRun");
        btn.disabled = true;
        btn.textContent = "Comparaison…";
        run().catch(showErr).finally(()=>{
          btn.disabled = false;
          btn.textContent = "Comparer";
        });
      });

      $("btnSwap").addEventListener("click", () => {
        const bookA = $("bookA");
        const bookB = $("bookB");
        const chapA = $("chapA");
        const chapB = $("chapB");
        const versA = $("versA");
        const versB = $("versB");

        const bA = bookA.value, bB = bookB.value;
        const cA = chapA.value, cB = chapB.value;
        const vA = versA.value, vB = versB.value;

        bookA.value = bB; bookB.value = bA;
        chapA.value = cB; chapB.value = cA;
        versA.value = vB; versB.value = vA;
      });

    }catch(e){
      showErr(e);
    }
  });
})();
